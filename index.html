<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3 LEGENDARY - Mobile System</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B0000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #2d1810 50%, #8B0000 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: rgba(0,0,0,0.95);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            padding: 20px 15px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(255,255,255,0.1) 8px,
                rgba(255,255,255,0.1) 16px
            );
            pointer-events: none;
        }
        
        .logo-container {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-3legendary {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #FFD700;
            box-shadow: 0 0 25px rgba(255,215,0,0.6);
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><radialGradient id="sun" cx="50%" cy="35%"><stop offset="0%" stop-color="%23FF6B6B"/><stop offset="70%" stop-color="%23DC143C"/><stop offset="100%" stop-color="%238B0000"/></radialGradient><filter id="shadow"><feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/></filter></defs><circle cx="200" cy="140" r="90" fill="url(%23sun)" stroke="%23FFD700" stroke-width="2"/><g filter="url(%23shadow)"><path d="M80,180 Q60,160 40,180 Q50,200 70,220 Q90,240 120,235 Q140,230 150,210 Q160,190 145,170 Q130,155 115,165 Q100,175 90,185 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M70,175 Q80,165 90,175 Q95,185 85,195 Q75,205 65,195 Z" fill="%23FF0000"/><path d="M110,185 L130,175 L140,190 L125,200 Z" fill="%23000000"/></g><g filter="url(%23shadow)"><path d="M280,190 Q260,170 240,190 Q250,210 270,230 Q290,250 320,245 Q340,240 350,220 Q360,200 345,180 Q330,165 315,175 Q300,185 290,195 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M270,185 Q280,175 290,185 Q295,195 285,205 Q275,215 265,205 Z" fill="%23FF0000"/><path d="M310,195 L330,185 L340,200 L325,210 Z" fill="%23000000"/></g><rect x="80" y="320" width="240" height="45" rx="10" fill="%23000000" stroke="%23FFD700" stroke-width="3"/><text x="200" y="350" text-anchor="middle" fill="%23FF0000" font-size="32" font-weight="bold" font-family="Arial Black">3 LEGENDARY</text></svg>') center/cover;
        }
        
        .header h1 {
            font-size: 1.8em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            position: relative;
            z-index: 2;
            margin: 0;
        }
        
        .legend-text {
            background: linear-gradient(45deg, #FF0000, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            position: relative;
            z-index: 2;
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            background: rgba(139,0,0,0.4);
            border-bottom: 3px solid #8B0000;
        }
        
        .tab {
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,0,0,0.4);
            border-right: 1px solid #8B0000;
            border-bottom: 1px solid #8B0000;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9em;
            position: relative;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab:nth-child(2n) {
            border-right: none;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: #fff;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(255,0,0,0.4);
        }
        
        .tab:hover:not(.active) {
            background: rgba(139,0,0,0.6);
            transform: scale(1.01);
        }
        
        .content {
            padding: 20px 15px;
            padding-bottom: 80px;
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .section {
            background: rgba(139,0,0,0.15);
            border-radius: 20px;
            padding: 25px 20px;
            margin: 15px 0;
            border: 2px solid #8B0000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 1em;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 3px solid #8B0000;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #FF0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.4);
            transform: scale(1.02);
        }
        
        .btn {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-top: 25px;
            transition: all 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 6px 20px rgba(139,0,0,0.4);
            min-height: 60px;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255,0,0,0.5);
            background: linear-gradient(135deg, #A0001A, #FF1A1A);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-small {
            width: auto;
            padding: 12px 20px;
            font-size: 14px;
            margin: 8px 5px;
            min-height: auto;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .inventory-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #8B0000;
        }
        
        .inventory-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: rgba(139,0,0,0.3);
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .inventory-tab.active {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: #fff;
        }
        
        .inventory-content {
            display: none;
        }
        
        .inventory-content.active {
            display: block;
        }
        
        .item-card {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 5px solid #FFD700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #FFD700;
            flex: 1;
        }
        
        .item-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .status-disponibile {
            background: #006400;
            color: #90EE90;
        }
        
        .status-venduto {
            background: #FFD700;
            color: #000;
        }
        
        .status-esaurito {
            background: #8B0000;
            color: #FFB6C1;
        }
        
        .status-uso {
            background: #666;
            color: #fff;
        }
        
        .quantity-info {
            background: rgba(255,215,0,0.15);
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
        }
        
        .item-details {
            font-size: 0.9em;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .profit-positive {
            color: #90EE90;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #FFB6C1;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #8B0000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .info-box {
            background: rgba(255,215,0,0.15);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 18px;
            margin: 20px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .info-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .calc-preview {
            background: rgba(255,215,0,0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .message {
            padding: 18px;
            margin: 20px 0;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
        }
        
        .success {
            background: rgba(0,100,0,0.3);
            border: 2px solid #006400;
            color: #90EE90;
        }
        
        .error {
            background: rgba(139,0,0,0.3);
            border: 2px solid #8B0000;
            color: #FFB6C1;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #FFD700;
            font-weight: bold;
            padding: 30px;
            font-size: 1.1em;
        }
        
        .floating-add {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FF0000, #FFD700);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #000;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(255,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .floating-add:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,0,0,0.6);
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
            border-left: 4px solid #8B0000;
        }
        
        .balance-name {
            font-weight: bold;
            font-size: 1em;
        }
        
        .balance-amount {
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .positive {
            background: #006400;
            color: #90EE90;
        }
        
        .negative {
            background: #8B0000;
            color: #FFB6C1;
        }
        
        .neutral {
            background: #666;
            color: #fff;
        }
        
        .cash-movement {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
        }
        
        .movement-in {
            border-left: 4px solid #006400;
        }
        
        .movement-out {
            border-left: 4px solid #8B0000;
        }
        
        /* RESPONSIVE MOBILE OPTIMIZATIONS */
        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }
            
            .logo-3legendary {
                width: 60px;
                height: 60px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .tabs {
                grid-template-columns: 1fr 1fr;
            }
            
            .tab {
                padding: 15px 8px;
                font-size: 0.8em;
                min-height: 55px;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .section {
                padding: 20px 15px;
                margin: 10px 0;
            }
            
            .two-column, .three-column {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .item-name {
                font-size: 1em;
            }
            
            .floating-add {
                bottom: 15px;
                right: 15px;
                width: 55px;
                height: 55px;
                font-size: 28px;
            }
        }
        
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.4em;
            }
            
            .tab {
                font-size: 0.75em;
                padding: 12px 6px;
            }
            
            .content {
                padding: 12px 8px;
            }
            
            .section {
                padding: 18px 12px;
            }
            
            .form-group input, .form-group select {
                padding: 14px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        /* üé® AGGIUNGI QUESTI STILI AL TUO CSS ESISTENTE */

/* SISTEMA PREZZO DOPPIO */
.dual-price-container {
    background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(139,0,0,0.15));
    border: 2px solid #FFD700;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
}

.dual-price-header {
    color: #FFD700;
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 15px;
    text-align: center;
}

.price-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.price-field {
    position: relative;
}

.price-field input {
    padding-right: 45px;
    font-size: 18px;
    font-weight: bold;
    background: rgba(0,0,0,0.9);
    color: #fff !important;
    border: 2px solid #8B0000 !important;
}

.currency {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #FFD700;
    font-weight: bold;
    pointer-events: none;
}

.price-preview {
    background: rgba(0,0,0,0.6);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(255,215,0,0.3);
}

.preview-text {
    font-size: 1.1em;
    color: #90EE90;
    font-weight: bold;
    line-height: 1.4;
}

.preview-detail {
    font-size: 0.9em;
    color: #ccc;
    margin-top: 5px;
}

.sync-indicator {
    position: absolute;
    top: -10px;
    right: 20px;
    background: #FFD700;
    color: #000;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
}

/* GESTIONE CATEGORIE INVENTARIO */
.categories-section {
    background: rgba(139,0,0,0.4);
    padding: 20px;
    border-bottom: 2px solid #8B0000;
    border-radius: 15px 15px 0 0;
    margin-bottom: 0;
}

.categories-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.categories-title {
    color: #FFD700;
    font-size: 1.2em;
    font-weight: bold;
}

.add-category-btn {
    background: linear-gradient(135deg, #006400, #32CD32);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9em;
}

.add-category-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(50,205,50,0.4);
}

.categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 15px;
}

.category-card {
    background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(255,215,0,0.1));
    border: 2px solid #FFD700;
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
    text-align: center;
}

.category-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(255,215,0,0.4);
    border-color: #FFA500;
}

.category-card.active {
    background: linear-gradient(135deg, #8B0000, #FF0000);
    border-color: #FF0000;
    transform: scale(1.02);
}

.category-icon {
    font-size: 1.8em;
    margin-bottom: 8px;
    display: block;
}

.category-name {
    font-weight: bold;
    color: #FFD700;
    margin-bottom: 4px;
    font-size: 0.9em;
}

.category-count {
    font-size: 0.8em;
    color: #ccc;
    margin-bottom: 6px;
}

.category-value {
    font-size: 0.75em;
    color: #90EE90;
    font-weight: bold;
}

.category-actions {
    position: absolute;
    top: 6px;
    right: 6px;
    display: flex;
    gap: 3px;
    opacity: 0;
    transition: opacity 0.3s;
}

.category-card:hover .category-actions {
    opacity: 1;
}

.category-action-btn {
    background: rgba(0,0,0,0.8);
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.7em;
}

.category-action-btn:hover {
    transform: scale(1.1);
}

.btn-edit-category {
    color: #FFA500;
}

.btn-delete-category {
    color: #FF4444;
}

/* INVENTARIO MIGLIORATO */
.inventory-controls {
    background: rgba(0,0,0,0.3);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.search-section {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
}

.search-input {
    padding: 12px 15px;
    border: 2px solid #8B0000;
    border-radius: 10px;
    background: rgba(0,0,0,0.8);
    color: #fff;
    font-size: 16px;
    font-weight: 500;
}

.search-input:focus {
    outline: none;
    border-color: #FF0000;
    box-shadow: 0 0 15px rgba(255,0,0,0.4);
}

.filter-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 15px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.8em;
}

.filter-btn.active {
    background: linear-gradient(135deg, #8B0000, #FF0000);
    color: white;
    transform: scale(1.05);
}

.filter-btn:not(.active) {
    background: rgba(255,255,255,0.2);
    color: #fff;
}

.filter-btn:hover:not(.active) {
    background: rgba(255,255,255,0.3);
    transform: scale(1.02);
}

.inventory-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.stat-box {
    background: rgba(0,0,0,0.6);
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #FFD700;
    text-align: center;
}

.stat-number {
    font-size: 1.4em;
    color: #FFD700;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.8em;
    opacity: 0.9;
    margin-top: 4px;
}

.item-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.info-card {
    background: rgba(255,215,0,0.1);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #FFD700;
}

.info-label {
    color: #FFD700;
    font-weight: bold;
    font-size: 0.8em;
    margin-bottom: 4px;
}

.info-value {
    color: #fff;
    font-size: 0.95em;
    font-weight: bold;
}

.movements-section {
    margin-top: 15px;
    background: rgba(0,0,0,0.5);
    border-radius: 10px;
    overflow: hidden;
}

.movements-header {
    background: rgba(255,215,0,0.2);
    padding: 8px 12px;
    border-bottom: 1px solid #FFD700;
}

.movements-title {
    color: #FFD700;
    font-weight: bold;
    font-size: 0.85em;
}

.movement-item {
    padding: 8px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8em;
}

.movement-item:last-child {
    border-bottom: none;
}

.movement-in {
    border-left: 3px solid #006400;
}

.movement-out {
    border-left: 3px solid #8B0000;
}

.movement-date {
    color: #ccc;
    font-size: 0.75em;
}

.movement-amount {
    font-weight: bold;
}

.amount-positive {
    color: #90EE90;
}

.amount-negative {
    color: #FFB6C1;
}

.action-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.8em;
    flex: 1;
    min-width: 100px;
}

.btn-edit {
    background: linear-gradient(135deg, #FFA500, #FF8C00);
    color: white;
}

.btn-delete {
    background: linear-gradient(135deg, #8B0000, #DC143C);
    color: white;
}

.btn-sell {
    background: linear-gradient(135deg, #006400, #32CD32);
    color: white;
}

.btn-unify {
    background: linear-gradient(135deg, #4169E1, #6495ED);
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* RESPONSIVE */
@media (max-width: 600px) {
    .price-fields {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .categories-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .item-info-grid {
        grid-template-columns: 1fr;
    }
    
    .search-section {
        grid-template-columns: 1fr;
    }
}
        /* PWA STYLES */
        @media (display-mode: standalone) {
            .container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* DARK MODE SUPPORT */
        @media (prefers-color-scheme: dark) {
            .form-group input, .form-group select {
                background: rgba(0,0,0,0.9);
            }
        }
        /* üîß NUOVO LAYOUT BILANCIO MIGLIORATO - AGGIUNGI ALLA FINE DEL CSS */
.balance-item-new {
    background: rgba(0,0,0,0.8);
    margin: 15px 0;
    border-radius: 15px;
    border: 2px solid #8B0000;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.balance-header {
    background: linear-gradient(135deg, #8B0000, #FF0000);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.balance-name-new {
    font-size: 1.2em;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
}

.balance-status {
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
    text-align: center;
    min-width: 100px;
}

.status-positive {
    background: #006400;
    color: #90EE90;
}

.status-negative {
    background: #8B0000;
    color: #FFB6C1;
}

.status-neutral {
    background: #FFD700;
    color: #000;
}

.balance-details {
    padding: 15px 20px;
    background: rgba(255,255,255,0.05);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.detail-label {
    color: #FFD700;
    font-weight: bold;
}

.detail-value {
    color: #fff;
    font-weight: normal;
}

.divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #FFD700, transparent);
    margin: 10px 0;
}

/* üì± RESPONSIVE OTTIMIZZATO PER MOBILE */
@media (max-width: 480px) {
    .balance-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .balance-status {
        min-width: auto;
        width: 100%;
    }
    
    .detail-row {
        font-size: 0.85em;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-3legendary"></div>
                <h1>3 <span class="legend-text">LEGENDARY</span></h1>
            </div>
            <div class="subtitle">Sistema Mobile Pok√©mon</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('expenses')">üí∞ Spese</div>
            <div class="tab" onclick="showTab('inventory')">üì¶ Inventario</div>
            <div class="tab" onclick="showTab('sales')">üìà Vendite</div>
            <div class="tab" onclick="showTab('reports')">üìä Report</div>
            <div class="tab" onclick="showTab('cash')">üè¶ Cassa</div>
            <div class="tab" onclick="showTab('balance')">‚öñÔ∏è Bilancio</div>
        </div>
        
        <div class="content">
            <!-- 1. SPESE -->
            <div id="expenses" class="form-section active">
                <div class="section">
                    <h2>üí∞ Nuova Spesa</h2>
                    
                    <div class="info-box">
                        <div class="info-title">üì± Mobile Quick:</div>
                        <p>Inserisci <strong>prezzo totale</strong> e <strong>quantit√†</strong> - il sistema calcola tutto automaticamente!</p>
                    </div>
                    
                    <form id="expenseForm">
                        <div class="form-group">
                            <label>üë§ Chi ha pagato:</label>
                            <select name="socio" required>
                                <option value="">Scegli...</option>
                                <option value="Portafoglio Condiviso">üí∞ Cassa Comune</option>
                                <option value="Ciano">üéÆ Ciano</option>
                                <option value="Alex">üî• Alex</option>
                                <option value="King">üëë King</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>üìù Cosa hai comprato:</label>
                            <input type="text" name="descrizione" placeholder="Es: Booster Darkness Ablaze" required>
                        </div>
                        
                        <div class="form-group">
    <label>üì¶ Quantit√†:</label>
    <input type="number" name="quantita" min="1" value="1" required onchange="calculateExpensePrice()">
</div>

<!-- SISTEMA PREZZO DOPPIO -->
<div class="dual-price-container">
    <div class="sync-indicator">üîÑ SYNC</div>
    <div class="dual-price-header">üí∞ Sistema Prezzo Intelligente</div>
    
    <div class="price-fields">
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">üíµ Prezzo TOTALE</label>
            <input type="number" id="expensePriceTotal" name="prezzo_totale" step="0.01" placeholder="0.00" onchange="calculateExpenseFromTotal()" oninput="calculateExpenseFromTotal()">
            <span class="currency">‚Ç¨</span>
        </div>
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">üíé Prezzo SINGOLO</label>
            <input type="number" id="expensePriceSingle" step="0.01" placeholder="0.00" onchange="calculateExpenseFromSingle()" oninput="calculateExpenseFromSingle()">
            <span class="currency">‚Ç¨</span>
        </div>
    </div>
    
    <div class="price-preview">
        <div class="preview-text" id="expensePreview">Inserisci quantit√† e prezzo per vedere l'anteprima</div>
        <div class="preview-detail" id="expenseDetail"></div>
    </div>
</div>
                        
                        <div class="form-group">
                            <label>üè™ Dove:</label>
                            <input type="text" name="dove" placeholder="eBay, Amazon, Negozio..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>üè∑Ô∏è Tipo:</label>
                            <select name="categoria" required>
                                <option value="">Seleziona...</option>
                                <option value="Da Vendere">üí∞ Da Vendere</option>
                                <option value="Uso Interno">üîß Uso Interno</option>
                            </select>
                        </div>
                        <div class="form-group">
    <label>üìÅ Categoria Prodotto:</label>
    <select name="categoria_prodotto" id="productCategorySelect" required>
        <option value="generale">üìã Generale</option>
    </select>
</div>
                        <div class="form-group">
                            <label>üìÖ Data:</label>
                            <input type="date" name="data" required>
                        </div>
                        
                        <div id="pricePreview" class="calc-preview" style="display: none;">
                            <strong>üí° Calcolo:</strong><br>
                            <span id="priceCalc"></span>
                        </div>
                    
<button type="submit" class="btn">üíæ Salva Spesa</button>
</form>
                </div>
            </div>
            
            <!-- 2. INVENTARIO -->
            <div id="inventory" class="form-section">
                <div class="section">
                    <h2>üì¶ INVENTARIO MAGAZZINO</h2>

<!-- HEADER STATISTICHE -->
<div class="inventory-stats">
    <div class="stat-box">
        <span class="stat-number" id="totalItems">--</span>
        <div class="stat-label">Articoli Totali</div>
    </div>
    <div class="stat-box">
        <span class="stat-number" id="availableItems">--</span>
        <div class="stat-label">Disponibili</div>
    </div>
    <div class="stat-box">
        <span class="stat-number" id="totalValue">‚Ç¨--</span>
        <div class="stat-label">Valore Magazzino</div>
    </div>
    <div class="stat-box">
        <span class="stat-number" id="soldValue">‚Ç¨--</span>
        <div class="stat-label">Venduto</div>
    </div>
</div>
                    <!-- GESTIONE CATEGORIE -->
<div class="categories-section">
    <div class="categories-header">
        <div class="categories-title">üìÅ Categorie Prodotti</div>
        <button class="add-category-btn" onclick="showAddCategoryModal()">‚ûï Nuova Categoria</button>
    </div>
    
    <div class="categories-grid">
        <div class="category-card active" onclick="selectCategory('all')">
            <div class="category-icon">üåü</div>
            <div class="category-name">Tutti i Prodotti</div>
            <div class="category-count">-- articoli</div>
            <div class="category-value">‚Ç¨-- totale</div>
        </div>
        
        <div class="category-card" onclick="selectCategory('booster-packs')">
            <div class="category-icon">üé¥</div>
            <div class="category-name">Booster Packs</div>
            <div class="category-count">-- articoli</div>
            <div class="category-value">‚Ç¨-- totale</div>
            <div class="category-actions">
                <button class="category-action-btn btn-edit-category" onclick="editCategory('booster-packs', event)">‚úèÔ∏è</button>
                <button class="category-action-btn btn-delete-category" onclick="deleteCategory('booster-packs', event)">üóëÔ∏è</button>
            </div>
        </div>
        
        <div class="category-card" onclick="selectCategory('etb')">
            <div class="category-icon">üì¶</div>
            <div class="category-name">Elite Trainer Box</div>
            <div class="category-count">-- articoli</div>
            <div class="category-value">‚Ç¨-- totale</div>
            <div class="category-actions">
                <button class="category-action-btn btn-edit-category" onclick="editCategory('etb', event)">‚úèÔ∏è</button>
                <button class="category-action-btn btn-delete-category" onclick="deleteCategory('etb', event)">üóëÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- BREADCRUMB NAVIGAZIONE -->
    <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 8px; font-size: 0.9em;">
        <span style="color: #FFD700;">üìç Visualizzando:</span>
        <span id="currentCategoryBreadcrumb" style="color: #fff; font-weight: bold; margin-left: 10px;">üåü Tutti i Prodotti</span>
    </div>
</div>

<!-- CONTROLLI INVENTARIO -->
<div class="inventory-controls">
    <div class="search-section">
        <input type="text" class="search-input" placeholder="üîç Cerca prodotti, codici..." onkeyup="searchInventory(this.value)">
        <button class="filter-btn active" onclick="refreshInventory()">üîÑ Aggiorna</button>
    </div>
    <div class="filter-buttons">
        <button class="filter-btn active" onclick="filterInventory('all')">üåü Tutti</button>
        <button class="filter-btn" onclick="filterInventory('disponibili')">‚úÖ Disponibili</button>
        <button class="filter-btn" onclick="filterInventory('esauriti')">‚ùå Esauriti</button>
    </div>
</div>

<!-- STATISTICHE INVENTARIO -->

                    <div class="inventory-tabs">
                        <div class="inventory-tab active" onclick="showInventoryTab('vendere')">üí∞ Da Vendere</div>
                        <div class="inventory-tab" onclick="showInventoryTab('interno')">üîß Uso Interno</div>
                    </div>
                    
                    <div id="inventario-vendere" class="inventory-content active">
                        <div class="loading" id="inventoryLoading">‚è≥ Caricamento...</div>
                        <div id="inventoryVendereContent"></div>
                    </div>
                    
                    <div id="inventario-interno" class="inventory-content">
                        <div id="inventoryInternoContent"></div>
                    </div>
                    
                    <button class="btn" onclick="loadInventory()">üîÑ Aggiorna</button>
                </div>
            </div>
            
            <!-- 3. VENDITE -->
            <div id="sales" class="form-section">
                <div class="section">
                    <h2>üìà Registra Vendita</h2>
                    
                    <div class="info-box">
                        <div class="info-title">üí∞ Profitti:</div>
                        <p>Il ricavato va in <strong>Cassa Comune</strong> e viene diviso per 3!</p>
                    </div>
                    
                    <form id="salesForm">
                        <div class="form-group">
                            <label>üé¥ Cosa vendi:</label>
                            <select name="item_id" id="salesItemSelect" required onchange="updateSaleInfo()">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        
                        <div id="itemInfo" class="quantity-info" style="display: none;">
                            <span id="itemDetails"></span>
                        </div>
                        
                        <div class="form-group">
    <label>üì¶ Quantit√† da vendere:</label>
    <input type="number" name="quantita_vendita" min="1" required onchange="calculateSalePrice()">
</div>

<!-- SISTEMA PREZZO DOPPIO VENDITE -->
<div class="dual-price-container">
    <div class="sync-indicator">üîÑ SYNC</div>
    <div class="dual-price-header">üí∞ Prezzo di Vendita</div>
    
    <div class="price-fields">
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">üíµ Ricavo TOTALE</label>
            <input type="number" id="salePriceTotal" name="prezzo_totale_vendita" step="0.01" placeholder="0.00" onchange="calculateSaleFromTotal()" oninput="calculateSaleFromTotal()">
            <span class="currency">‚Ç¨</span>
        </div>
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">üíé Prezzo SINGOLO</label>
            <input type="number" id="salePriceSingle" step="0.01" placeholder="0.00" onchange="calculateSaleFromSingle()" oninput="calculateSaleFromSingle()">
            <span class="currency">‚Ç¨</span>
        </div>
    </div>
    
    <div class="price-preview">
        <div class="preview-text" id="salePreview">Seleziona prodotto e inserisci quantit√†</div>
        <div class="preview-detail" id="saleDetail"></div>
    </div>
</div>
                        
                        <div class="form-group">
                            <label>üë§ Venduto a:</label>
                            <input type="text" name="venduto_a" placeholder="Cliente, eBay, Vinted..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>üìÖ Data vendita:</label>
                            <input type="date" name="data_vendita" required>
                        </div>
                        
                        <div id="salePreview" class="calc-preview" style="display: none;">
                            <strong>üí° Profitto:</strong><br>
                            <span id="saleCalc"></span>
                        </div>
                        
                        <button type="submit" class="btn">üí∞ Registra Vendita</button>
                    </form>
                </div>
            </div>
            
            <!-- 4. REPORT -->
            <div id="reports" class="form-section">
                <div class="section">
                    <h2>üìä Report Vendite</h2>
                    
                    <div class="loading" id="reportsLoading">‚è≥ Caricamento...</div>
                    <div id="reportsContent"></div>
                    
                    <button class="btn" onclick="loadSalesReport()">üîÑ Aggiorna</button>
                </div>
            </div>
            
            <!-- 5. CASSA -->
            <div id="cash" class="form-section">
                <div class="section">
                    <h2>üè¶ Cassa Comune</h2>
                    <div class="loading" id="cashLoading">‚è≥ Caricamento...</div>
                    <div id="cashContent"></div>
                    
                    <div class="section" style="margin-top: 20px;">
                        <h3 style="color: #FFD700; margin-bottom: 15px; text-align: center;">üí∞ Aggiungi Denaro</h3>
                        <form id="addCashForm">
                            <div class="form-group">
                                <label>üë§ Chi versa:</label>
                                <select name="socio" required>
                                    <option value="">Scegli...</option>
                                    <option value="Ciano">üéÆ Ciano</option>
                                    <option value="Alex">üî• Alex</option>
                                    <option value="King">üëë King</option>
                                    <option value="Tutti">üë• Tutti (diviso per 3)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>üí∂ Importo ‚Ç¨:</label>
                                <input type="number" name="importo" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>üìù Motivo:</label>
                                <input type="text" name="motivo" placeholder="Versamento iniziale..." required>
                            </div>
                            <button type="submit" class="btn">üí∞ Aggiungi</button>
                        </form>
                    </div>
                    
                    <div id="profitDistribution"></div>
                    
                    <button class="btn" onclick="loadCashStatus()">üîÑ Aggiorna Cassa</button>
                </div>
            </div>
            
            <!-- 6. BILANCIO -->
            <div id="balance" class="form-section">
                <div class="section">
                    <h2>‚öñÔ∏è Bilancio Personale</h2>
                    
                    <div class="info-box">
                        <div class="info-title">ü§î Come funziona:</div>
                        <p><strong>Quota Teorica:</strong> Quanto dovrebbe aver speso ognuno se diviso equamente<br>
                        <strong>Nota:</strong> Spese da "Cassa Comune" NON influenzano questo bilancio</p>
                    </div>
                    <div class="section" style="margin-top: 20px;">
    <h3 style="color: #FFD700; margin-bottom: 15px; text-align: center;">üí∏ Registra Pagamento</h3>
    <form id="internalPaymentForm">
        <div class="two-column">
            <div class="form-group">
                <label>üë§ Chi paga:</label>
                <select name="da_chi" required>
                    <option value="">Scegli...</option>
                    <option value="Ciano">üéÆ Ciano</option>
                    <option value="Alex">üî• Alex</option>
                    <option value="King">üëë King</option>
                </select>
            </div>
            <div class="form-group">
                <label>üë§ Chi riceve:</label>
                <select name="a_chi" required>
                    <option value="">Scegli...</option>
                    <option value="Ciano">üéÆ Ciano</option>
                    <option value="Alex">üî• Alex</option>
                    <option value="King">üëë King</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>üí∂ Importo ‚Ç¨:</label>
            <input type="number" name="importo" step="0.01" placeholder="0.00" required>
        </div>
        
        <div class="form-group">
            <label>üìù Motivo:</label>
            <input type="text" name="motivo" placeholder="Sistemazione bilancio..." required>
        </div>
        
        <button type="submit" class="btn">üí∏ Registra Pagamento</button>
    </form>
</div>
                    <div class="loading" id="balanceLoading">‚è≥ Caricamento...</div>
                    <div id="balanceContent"></div>
                    
                    <button class="btn" onclick="loadPersonalBalanceWithPayments()">üîÑ Aggiorna</button>
                </div>
            </div>
            
            <!-- MESSAGGI -->
            <div id="message"></div>
        </div>
        
        <!-- FLOATING ACTION BUTTON -->
        <div class="floating-add" onclick="showTab('expenses')" title="Aggiungi Spesa Veloce">
            +
        </div>
    </div>

    <script>
        console.log('üîÑ JavaScript INIZIATO!');
alert('JavaScript funziona!');
        // üÜï VERIFICA SE IL FORM ESISTE
setTimeout(() => {
    const form = document.getElementById('expenseForm');
    console.log('üìã Form trovato:', form);
    if (form) {
        console.log('‚úÖ Form esiste!');
    } else {
        console.log('‚ùå Form NON trovato!');
    }
}, 1000);
// üöÄ CONFIGURAZIONE API
const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwc17XK8CD4q2wRkgMGYK2_jB4MpiHrf06eIF28RMYebUbDj_ozYQOt6-dhzJdAlvt-AQ/exec';

// STORAGE LOCALE
let localData = { expenses: [], sales: [], inventory: [] };

// FUNZIONE API SEMPLIFICATA
// ‚úÖ NUOVA (funziona davvero)
async function apiCall(action, data = {}) {
    try {
        const params = new URLSearchParams({ action: action, ...data });
        const response = await fetch(`${API_BASE_URL}?${params}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('API Error:', error);
        return { 
            success: false, 
            message: 'Errore di connessione: ' + error.message 
        };
    }
}

// CARICA DATI
function loadLocalData() {
    const stored = localStorage.getItem('3legendary_mobile_data');
    if (stored) localData = JSON.parse(stored);
}

// INIZIALIZZAZIONE
// INIZIALIZZAZIONE
document.addEventListener('DOMContentLoaded', function() {
    loadLocalData();
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => { if (!input.value) input.value = today; });
    
    // üÜï CARICA CATEGORIE DAL BACKEND
    loadCategories();
});
// ========== SISTEMA PREZZO DOPPIO SPESE ==========
let isCalculatingExpense = false;

function calculateExpenseFromTotal() {
    if (isCalculatingExpense) return;
    isCalculatingExpense = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita"]').value) || 0;
    const totalPrice = parseFloat(document.getElementById('expensePriceTotal').value) || 0;
    
    if (quantity > 0 && totalPrice > 0) {
        const singlePrice = totalPrice / quantity;
        document.getElementById('expensePriceSingle').value = singlePrice.toFixed(2);
        updateExpensePreview(quantity, totalPrice, singlePrice);
    } else {
        clearExpensePreview();
    }
    
    isCalculatingExpense = false;
}

function calculateExpenseFromSingle() {
    if (isCalculatingExpense) return;
    isCalculatingExpense = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita"]').value) || 0;
    const singlePrice = parseFloat(document.getElementById('expensePriceSingle').value) || 0;
    
    if (quantity > 0 && singlePrice > 0) {
        const totalPrice = Math.round((quantity * singlePrice) * 100) / 100;
        document.getElementById('expensePriceTotal').value = totalPrice.toFixed(2);
        updateExpensePreview(quantity, totalPrice, singlePrice);
    } else {
        clearExpensePreview();
    }
    
    isCalculatingExpense = false;
}

function calculateExpensePrice() {
    // Ricalcola quando cambia la quantit√†
    const totalPrice = parseFloat(document.getElementById('expensePriceTotal').value) || 0;
    if (totalPrice > 0) {
        calculateExpenseFromTotal();
    } else {
        const singlePrice = parseFloat(document.getElementById('expensePriceSingle').value) || 0;
        if (singlePrice > 0) {
            calculateExpenseFromSingle();
        }
    }
}

function updateExpensePreview(quantity, totalPrice, singlePrice) {
    document.getElementById('expensePreview').innerHTML = 
        `üí∞ <strong>${quantity}x</strong> a <strong>‚Ç¨${singlePrice.toFixed(2)}</strong> cadauno = <strong>‚Ç¨${totalPrice.toFixed(2)}</strong> totale`;
    document.getElementById('expenseDetail').innerHTML = 
        `üí° Investimento: ‚Ç¨${totalPrice.toFixed(2)} ‚Ä¢ Costo unitario: ‚Ç¨${singlePrice.toFixed(2)}`;
}

function clearExpensePreview() {
    document.getElementById('expensePreview').innerHTML = 'Inserisci quantit√† e prezzo per vedere l\'anteprima';
    document.getElementById('expenseDetail').innerHTML = '';
}

// ========== SISTEMA PREZZO DOPPIO VENDITE ==========
let isCalculatingSale = false;
let currentItemPrice = 0;

function calculateSaleFromTotal() {
    if (isCalculatingSale) return;
    isCalculatingSale = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
    const totalPrice = parseFloat(document.getElementById('salePriceTotal').value) || 0;
    
    if (quantity > 0 && totalPrice > 0) {
        const singlePrice = totalPrice / quantity;
        document.getElementById('salePriceSingle').value = singlePrice.toFixed(2);
        updateSalePreview(quantity, totalPrice, singlePrice);
    } else {
        clearSalePreview();
    }
    
    isCalculatingSale = false;
}

function calculateSaleFromSingle() {
    if (isCalculatingSale) return;
    isCalculatingSale = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
    const singlePrice = parseFloat(document.getElementById('salePriceSingle').value) || 0;
    
    if (quantity > 0 && singlePrice > 0) {
        const totalPrice = Math.round((quantity * singlePrice) * 100) / 100;
        document.getElementById('salePriceTotal').value = totalPrice.toFixed(2);
        updateSalePreview(quantity, totalPrice, singlePrice);
    } else {
        clearSalePreview();
    }
    
    isCalculatingSale = false;
}

function calculateSalePrice() {
    // Ricalcola quando cambia la quantit√†
    const totalPrice = parseFloat(document.getElementById('salePriceTotal').value) || 0;
    if (totalPrice > 0) {
        calculateSaleFromTotal();
    } else {
        const singlePrice = parseFloat(document.getElementById('salePriceSingle').value) || 0;
        if (singlePrice > 0) {
            calculateSaleFromSingle();
        }
    }
}

function updateSalePreview(quantity, totalSalePrice, singleSalePrice) {
    if (currentItemPrice > 0) {
        const totalCost = quantity * currentItemPrice;
        const totalProfit = totalSalePrice - totalCost;
        const profitPercentage = totalCost > 0 ? ((totalProfit / totalCost) * 100).toFixed(1) : 0;
        
        const profitColor = totalProfit >= 0 ? '#90EE90' : '#FFB6C1';
        const profitSign = totalProfit >= 0 ? '+' : '';
        
        document.getElementById('salePreview').innerHTML = 
            `üìà <strong>${quantity}x</strong> a <strong>‚Ç¨${singleSalePrice.toFixed(2)}</strong> = <strong>‚Ç¨${totalSalePrice.toFixed(2)}</strong> ricavo`;
        
        document.getElementById('saleDetail').innerHTML = 
            `üí∞ Costo: ‚Ç¨${totalCost.toFixed(2)} ‚Ä¢ ` +
            `<span style="color: ${profitColor}">Profitto: <strong>${profitSign}‚Ç¨${totalProfit.toFixed(2)}</strong> (${profitSign}${profitPercentage}%)</span><br>` +
            `üíé Profitto per socio: ‚Ç¨${(totalProfit / 3).toFixed(2)} cadauno`;
    } else {
        document.getElementById('salePreview').innerHTML = 
            `üìà <strong>${quantity}x</strong> a <strong>‚Ç¨${singleSalePrice.toFixed(2)}</strong> = <strong>‚Ç¨${totalSalePrice.toFixed(2)}</strong> ricavo`;
        document.getElementById('saleDetail').innerHTML = 
            `‚ö†Ô∏è Seleziona un prodotto per calcolare il profitto`;
    }
}

function clearSalePreview() {
    document.getElementById('salePreview').innerHTML = 'Seleziona prodotto e inserisci quantit√†';
    document.getElementById('saleDetail').innerHTML = '';
}

// ========== GESTIONE CATEGORIE ==========
let currentCategory = 'all';
let categories = {}; // Ora viene caricato dal backend

// üÜï CARICA CATEGORIE DAL BACKEND
async function loadCategories() {
    try {
        const result = await apiCall('getCategories');
        if (result.success) {
            categories = result.categories;
            updateCategoriesUI();
            populateCategoryDropdown();
            console.log('‚úÖ Categorie caricate dal backend:', categories);
        } else {
            console.error('‚ùå Errore caricamento categorie:', result.message);
            // Fallback alle categorie locali se il backend fallisce
            categories = {
                'all': { name: 'Tutti i Prodotti', icon: 'üåü', count: 0, value: 0 },
                'booster-packs': { name: 'Booster Packs', icon: 'üé¥', count: 0, value: 0 },
                'etb': { name: 'Elite Trainer Box', icon: 'üì¶', count: 0, value: 0 }
            };
        }
    } catch (error) {
        console.error('‚ùå Errore connessione categorie:', error);
    }
}
// üÜï AGGIORNA UI CATEGORIE
function updateCategoriesUI() {
    const grid = document.querySelector('.categories-grid');
    if (!grid) return;
    
    // Svuota la griglia (tranne "Tutti")
    grid.innerHTML = '';
    
    // Ricrea tutte le categorie dal backend
    Object.entries(categories).forEach(([categoryId, category]) => {
        const categoryHtml = `
            <div class="category-card ${categoryId === currentCategory ? 'active' : ''}" onclick="selectCategory('${categoryId}')">
                <div class="category-icon">${category.icon}</div>
                <div class="category-name">${category.name}</div>
                <div class="category-count">${category.count || 0} articoli</div>
                <div class="category-value">‚Ç¨${(category.value || 0).toFixed(2)} totale</div>
                ${categoryId !== 'all' ? `
                    <div class="category-actions">
                        <button class="category-action-btn btn-edit-category" onclick="editCategory('${categoryId}', event)">‚úèÔ∏è</button>
                        <button class="category-action-btn btn-delete-category" onclick="deleteCategory('${categoryId}', event)">üóëÔ∏è</button>
                    </div>
                ` : ''}
            </div>
        `;
        grid.insertAdjacentHTML('beforeend', categoryHtml);
    });
    
    console.log('üé® UI categorie aggiornata');
}
        // üÜï POPOLA DROPDOWN CATEGORIE NEL FORM SPESE
function populateCategoryDropdown() {
    const dropdown = document.getElementById('productCategorySelect');
    if (!dropdown) return;
    
    // Reset dropdown
    dropdown.innerHTML = '<option value="generale">üìã Generale</option>';
    
    // Aggiungi categorie dal backend
    Object.entries(categories).forEach(([categoryId, category]) => {
        if (categoryId !== 'all') { // Escludi "Tutti i Prodotti"
            const option = document.createElement('option');
            option.value = categoryId;
            option.textContent = `${category.icon} ${category.name}`;
            dropdown.appendChild(option);
        }
    });
    
    console.log('üìÅ Dropdown popolato con:', Object.keys(categories));
}
function selectCategory(categoryId) {
    currentCategory = categoryId;
    
    // Aggiorna UI
    document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const selectedCard = document.querySelector(`[onclick="selectCategory('${categoryId}')"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // Aggiorna breadcrumb
    const category = categories[categoryId];
    if (category) {
    document.getElementById('currentCategoryBreadcrumb').textContent = `${category.icon} ${category.name}`;
}

// Filtra prodotti
filterProductsByCategory(categoryId);

// üÜï AGGIORNA CAMPO NASCOSTO PER NUOVE SPESE
const categoryField = document.getElementById('productCategory');
if (categoryField) {
    categoryField.value = categoryId;
    console.log('Categoria impostata per nuove spese:', categoryId);
}

console.log('Categoria selezionata:', categoryId);
}

// üîß FILTRO CATEGORIE CORRETTO
function filterProductsByCategory(categoryId) {
    console.log('üîç Filtrando per categoria:', categoryId);
    
    // Usa i dati dall'API invece che dal DOM
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            // Filtra oggetti da vendere
            let filteredVendere = result.data.daVendere || [];
            let filteredInterno = result.data.usoInterno || [];
            
            if (categoryId !== 'all') {
                filteredVendere = filteredVendere.filter(item => 
                    (item.categoria_prodotto || 'generale') === categoryId
                );
                filteredInterno = filteredInterno.filter(item => 
                    (item.categoria_prodotto || 'generale') === categoryId
                );
            }
            
            console.log(`üì¶ Filtrati Da Vendere: ${filteredVendere.length}/${result.data.daVendere.length}`);
            console.log(`üîß Filtrati Uso Interno: ${filteredInterno.length}/${result.data.usoInterno.length}`);
            
            // Rigenera HTML per inventario da vendere
            const vendereHtml = filteredVendere.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <span class="item-name">üé¥ ${item.descrizione}</span>
                        <span class="item-status ${item.quantita_disponibile > 0 ? 'status-disponibile' : 'status-esaurito'}">
                            ${item.quantita_disponibile > 0 ? '‚úÖ DISPONIBILE' : '‚ùå ESAURITO'}
                        </span>
                    </div>
                    <div class="item-info-grid">
                        <div class="info-card">
                            <div class="info-label">üì¶ Quantit√†</div>
                            <div class="info-value">${item.quantita_disponibile} / ${item.quantita_totale} disponibili</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üí∞ Prezzo Acquisto</div>
                            <div class="info-value">‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)} cad.</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üë§ Acquistato da</div>
                            <div class="info-value">${item.acquistato_da}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÖ Data Acquisto</div>
                            <div class="info-value">${new Date(item.data).toLocaleDateString('it-IT')}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üíé Valore Rimanente</div>
                            <div class="info-value">‚Ç¨${(item.quantita_disponibile * parseFloat(item.prezzo_unitario)).toFixed(2)}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÅ Categoria</div>
                            <div class="info-value">${item.categoria_prodotto || 'generale'}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn btn-sell" onclick="sellItem('${item.id}', '${item.descrizione}', ${item.quantita_disponibile}, ${item.prezzo_unitario})">üìà Vendi</button>
                        <button class="action-btn btn-edit" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
                        <button class="action-btn btn-unify" onclick="selectForUnify('${item.id}', '${item.descrizione}')">üîó Unifica</button>
                        <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `).join('') || `<p style="text-align: center; color: #ccc; padding: 40px;">üì≠ Nessun prodotto ${categoryId === 'all' ? '' : 'in questa categoria'}</p>`;
            
            // Rigenera HTML per inventario uso interno
            const internoHtml = filteredInterno.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <span class="item-name">üõ°Ô∏è ${item.descrizione}</span>
                        <span class="item-status status-uso">üîß USO INTERNO</span>
                    </div>
                    <div class="item-info-grid">
                        <div class="info-card">
                            <div class="info-label">üì¶ Quantit√†</div>
                            <div class="info-value">${item.quantita_totale} pezzi</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üí∞ Prezzo Acquisto</div>
                            <div class="info-value">‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)} cad.</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üë§ Acquistato da</div>
                            <div class="info-value">${item.acquistato_da}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÖ Data Acquisto</div>
                            <div class="info-value">${new Date(item.data).toLocaleDateString('it-IT')}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üíé Valore Totale</div>
                            <div class="info-value">‚Ç¨${(item.quantita_totale * parseFloat(item.prezzo_unitario)).toFixed(2)}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÅ Categoria</div>
                            <div class="info-value">${item.categoria_prodotto || 'generale'}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn btn-edit" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
                        <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `).join('') || `<p style="text-align: center; color: #ccc; padding: 40px;">üì≠ Nessun prodotto uso interno ${categoryId === 'all' ? '' : 'in questa categoria'}</p>`;
            
            // Aggiorna l'HTML
            document.getElementById('inventoryVendereContent').innerHTML = vendereHtml;
            document.getElementById('inventoryInternoContent').innerHTML = internoHtml;
            
            console.log('‚úÖ Filtro applicato con successo!');
        }
    }).catch(error => {
        console.error('‚ùå Errore nel filtro:', error);
    });
}

function showAddCategoryModal() {
    const modalHtml = `
        <div id="categoryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 500px; width: 100%; border: 3px solid #FFD700;">
                <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 1.4em;">‚ûï Nuova Categoria</h3>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #FFD700; display: block; margin-bottom: 8px; font-weight: bold;">üìù Nome Categoria:</label>
                    <input type="text" id="categoryName" placeholder="Es: Bundle Promozionali" style="width: 100%; padding: 12px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff; font-size: 16px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #FFD700; display: block; margin-bottom: 8px; font-weight: bold;">üé® Icona Categoria:</label>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                        ${['üé¥', 'üì¶', 'ü•´', 'üõ°Ô∏è', 'üéØ', '‚ö°', 'üåü', 'üî•', 'üíé', 'üèÜ', 'üéÅ', 'üé™'].map(icon => 
                            `<button onclick="selectIcon('${icon}')" style="padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff; font-size: 1.2em; cursor: pointer;" class="icon-btn">${icon}</button>`
                        ).join('')}
                    </div>
                    <input type="hidden" id="selectedIcon" value="üé¥">
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button onclick="createCategory()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #006400, #32CD32); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer;">‚úÖ Crea Categoria</button>
                    <button onclick="closeCategoryModal()" style="flex: 1; padding: 15px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer;">‚ùå Annulla</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function selectIcon(icon) {
    document.getElementById('selectedIcon').value = icon;
    document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.style.borderColor = '#8B0000';
        btn.style.background = '#000';
    });
    event.target.style.borderColor = '#FFD700';
    event.target.style.background = '#8B0000';
}

function createCategory() {
    const name = document.getElementById('categoryName').value.trim();
    const icon = document.getElementById('selectedIcon').value;
    
    if (!name) {
        alert('‚ùå Inserisci il nome della categoria!');
        return;
    }
    
    // Crea ID categoria
    const categoryId = name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
    
    if (categories[categoryId]) {
        alert('‚ùå Categoria gi√† esistente!');
        return;
    }
    
    // üÜï SALVA NEL BACKEND
apiCall('addCategory', {
    name: name,
    icon: icon,
    description: `Categoria creata dall'utente: ${name}`
}).then(result => {
    if (result.success) {
        // Aggiungi alla lista locale solo se salvata con successo
        categories[result.categoryId || categoryId] = {
            id: result.categoryId || categoryId,
            name: name,
            icon: icon,
            count: 0,
            value: 0
        };
        
        // Aggiorna UI
        addCategoryToGrid(result.categoryId || categoryId, categories[result.categoryId || categoryId]);
        closeCategoryModal();
        
        alert(`‚úÖ Categoria "${name}" creata e salvata!`);
        console.log('Categoria salvata nel backend:', result);
    } else {
        alert('‚ùå Errore salvataggio: ' + result.message);
    }
}).catch(error => {
    alert('‚ùå Errore connessione: ' + error.message);
});
}

function addCategoryToGrid(categoryId, category) {
    const grid = document.querySelector('.categories-grid');
    const categoryHtml = `
        <div class="category-card" onclick="selectCategory('${categoryId}')">
            <div class="category-icon">${category.icon}</div>
            <div class="category-name">${category.name}</div>
            <div class="category-count">${category.count} articoli</div>
            <div class="category-value">‚Ç¨${category.value} totale</div>
            <div class="category-actions">
                <button class="category-action-btn btn-edit-category" onclick="editCategory('${categoryId}', event)">‚úèÔ∏è</button>
                <button class="category-action-btn btn-delete-category" onclick="deleteCategory('${categoryId}', event)">üóëÔ∏è</button>
            </div>
        </div>
    `;
    grid.insertAdjacentHTML('beforeend', categoryHtml);
}

function editCategory(categoryId, event) {
    event.stopPropagation();
    const category = categories[categoryId];
    
    const newName = prompt(`‚úèÔ∏è Modifica nome categoria:\n\nAttuale: "${category.name}"`, category.name);
    if (newName && newName.trim() && newName !== category.name) {
        category.name = newName.trim();
        
        // Aggiorna UI
        const card = document.querySelector(`[onclick="selectCategory('${categoryId}')"]`);
        if (card) {
            card.querySelector('.category-name').textContent = category.name;
        }
        
        alert(`‚úÖ Categoria rinominata in "${category.name}"!`);
        console.log('Categoria modificata:', categoryId, category);
    }
}

function deleteCategory(categoryId, event) {
    event.stopPropagation();
    
    if (categoryId === 'all') {
        alert('‚ùå Non puoi eliminare la categoria "Tutti i Prodotti"!');
        return;
    }
    
    const category = categories[categoryId];
    if (confirm(`üóëÔ∏è Eliminare la categoria "${category.name}"?\n\n‚ö†Ô∏è I prodotti verranno spostati in "Senza Categoria"`)) {
        // Rimuovi categoria
        delete categories[categoryId];
        
        // Rimuovi dalla UI
        const card = document.querySelector(`[onclick="selectCategory('${categoryId}')"]`);
        if (card) card.remove();
        
        // Se era selezionata, torna a "Tutti"
        if (currentCategory === categoryId) {
            selectCategory('all');
        }
        
        alert(`‚úÖ Categoria "${category.name}" eliminata!`);
        console.log('Categoria eliminata:', categoryId);
    }
}

function closeCategoryModal() {
    const modal = document.getElementById('categoryModal');
    if (modal) modal.remove();
}

// üîç FUNZIONE RICERCA INVENTARIO COMPLETA
// üöÄ VARIABILI PER OTTIMIZZAZIONE RICERCA
let searchTimeout = null;
let cachedInventoryData = null;
let lastInventoryUpdate = 0;
const CACHE_DURATION = 30000; // 30 secondi

// üîç FUNZIONE RICERCA OTTIMIZZATA CON CACHE E DEBOUNCING
function searchInventory(searchTerm) {
    // Cancella il timeout precedente (debouncing)
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // Attende 300ms dall'ultimo carattere digitato
    searchTimeout = setTimeout(() => {
        performSearch(searchTerm);
    }, 300);
}
// üîÑ INVALIDA CACHE QUANDO NECESSARIO
function invalidateInventoryCache() {
    cachedInventoryData = null;
    lastInventoryUpdate = 0;
    console.log('üóëÔ∏è Cache inventario invalidata');
}

// üé® FUNZIONE PER EVIDENZIARE I TERMINI DI RICERCA (OTTIMIZZATA)
function highlightSearchTerm(text, searchTerm) {
    if (!text || !searchTerm) return text;
    
    const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
    return text.replace(regex, '<mark style="background: #FFD700; color: #000; padding: 2px 4px; border-radius: 3px;">$1</mark>');
}

// üõ°Ô∏è ESCAPE CARATTERI SPECIALI REGEX
function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
// üöÄ ESEGUE LA RICERCA EFFETTIVA
function performSearch(searchTerm) {
    console.log('üîç Ricerca ottimizzata:', searchTerm);
    
    // Se il campo di ricerca √® vuoto, mostra tutti i prodotti della categoria corrente
    if (!searchTerm || searchTerm.trim() === '') {
        filterProductsByCategory(currentCategory);
        return;
    }
    
    const normalizedSearchTerm = searchTerm.toLowerCase().trim();
    
    // üì¶ USA CACHE SE DISPONIBILE E RECENTE
    const now = Date.now();
    if (cachedInventoryData && (now - lastInventoryUpdate) < CACHE_DURATION) {
        console.log('‚ö° Usando cache per ricerca veloce');
        searchInCachedData(cachedInventoryData, normalizedSearchTerm, searchTerm);
        return;
    }
    
    // üì° CARICA DATI FRESCHI DALL'API
    console.log('üì° Caricando dati freschi...');
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            // Aggiorna cache
            cachedInventoryData = result.data;
            lastInventoryUpdate = Date.now();
            
            // Esegue ricerca sui dati freschi
            searchInCachedData(result.data, normalizedSearchTerm, searchTerm);
        }
    }).catch(error => {
        console.error('‚ùå Errore nella ricerca:', error);
    });
}

// ‚ö° RICERCA NEI DATI IN CACHE (SUPER VELOCE)
function searchInCachedData(data, normalizedSearchTerm, originalSearchTerm) {
    // Prima applica il filtro categoria, poi la ricerca
    let filteredVendere = data.daVendere || [];
    let filteredInterno = data.usoInterno || [];
    
    // Se non √® "all", filtra prima per categoria
    if (currentCategory !== 'all') {
        filteredVendere = filteredVendere.filter(item => 
            (item.categoria_prodotto || 'generale') === currentCategory
        );
        filteredInterno = filteredInterno.filter(item => 
            (item.categoria_prodotto || 'generale') === currentCategory
        );
    }
    
    // Poi applica la ricerca per nome/descrizione/ID
    filteredVendere = filteredVendere.filter(item => {
        const itemName = (item.descrizione || '').toLowerCase();
        const itemId = (item.id || '').toLowerCase();
        const itemOwner = (item.acquistato_da || '').toLowerCase();
        
        return itemName.includes(normalizedSearchTerm) ||
               itemId.includes(normalizedSearchTerm) ||
               itemOwner.includes(normalizedSearchTerm);
    });
    
    filteredInterno = filteredInterno.filter(item => {
        const itemName = (item.descrizione || '').toLowerCase();
        const itemId = (item.id || '').toLowerCase();
        const itemOwner = (item.acquistato_da || '').toLowerCase();
        
        return itemName.includes(normalizedSearchTerm) ||
               itemId.includes(normalizedSearchTerm) ||
               itemOwner.includes(normalizedSearchTerm);
    });
    
    console.log(`‚ö° Trovati istantaneamente: ${filteredVendere.length} da vendere, ${filteredInterno.length} uso interno`);
    
    // Genera HTML per risultati ricerca (versione ottimizzata)
    const vendereHtml = generateSearchResultsHTML(filteredVendere, originalSearchTerm, 'vendere');
    const internoHtml = generateSearchResultsHTML(filteredInterno, originalSearchTerm, 'interno');
    
    // Aggiorna l'HTML
    document.getElementById('inventoryVendereContent').innerHTML = vendereHtml;
    document.getElementById('inventoryInternoContent').innerHTML = internoHtml;
    
    console.log('‚ö° Ricerca completata istantaneamente!');
}

// üé® GENERA HTML RISULTATI (FUNZIONE SEPARATA PER OTTIMIZZAZIONE)
// üîß CERCA QUESTA FUNZIONE NEL TUO CODICE E SOSTITUISCILA:

// üé® GENERA HTML RISULTATI (FUNZIONE SEPARATA PER OTTIMIZZAZIONE)
function generateSearchResultsHTML(items, searchTerm, type) {
    if (!items || items.length === 0) {
        return `<p style="text-align: center; color: #ccc; padding: 40px;">üîç Nessun risultato ${type === 'interno' ? 'uso interno ' : ''}per "${searchTerm}"</p>`;
    }
    
    return items.map(item => {
        const isInterno = type === 'interno';
        const icon = isInterno ? 'üõ°Ô∏è' : 'üé¥';
        const statusClass = isInterno ? 'status-uso' : (item.quantita_disponibile > 0 ? 'status-disponibile' : 'status-esaurito');
        const statusText = isInterno ? 'üîß USO INTERNO' : (item.quantita_disponibile > 0 ? '‚úÖ DISPONIBILE' : '‚ùå ESAURITO');
        
        return `
            <div class="item-card" style="border-left: 4px solid #FFD700;">
                <div class="item-header">
                    <span class="item-name">${icon} ${highlightSearchTerm(item.descrizione, searchTerm)}</span>
                    <span class="item-status ${statusClass}">${statusText}</span>
                </div>
                <div class="item-info-grid">
                    <div class="info-card">
                        <div class="info-label">üÜî ID</div>
                        <div class="info-value">${item.id}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">üì¶ Quantit√†</div>
                        <div class="info-value">${isInterno ? item.quantita_totale + ' pezzi' : item.quantita_disponibile + ' / ' + item.quantita_totale + ' disp.'}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">üí∞ Prezzo</div>
                        <div class="info-value">‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">üë§ Acquirente</div>
                        <div class="info-value">${highlightSearchTerm(item.acquistato_da, searchTerm)}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">üìÅ Categoria</div>
                        <div class="info-value">${item.categoria_prodotto || 'generale'}</div>
                    </div>
                </div>
                <div class="item-actions">
                    ${!isInterno ? `<button class="action-btn btn-sell" onclick="sellItem('${item.id}', '${item.descrizione}', ${item.quantita_disponibile}, ${item.prezzo_unitario})">üìà Vendi</button>` : ''}
                    <button class="action-btn btn-edit" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
                    ${!isInterno ? `<button class="action-btn btn-unify" onclick="selectForUnify('${item.id}', '${item.descrizione}')">üîó Unifica</button>` : ''}
                    <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Elimina</button>
                </div>
            </div>
        `;
    }).join('');
}

// üîÑ INVALIDA CACHE QUANDO NECESSARIO
function invalidateInventoryCache() {
    cachedInventoryData = null;
    lastInventoryUpdate = 0;
    console.log('üóëÔ∏è Cache inventario invalidata');
}

// üé® FUNZIONE PER EVIDENZIARE I TERMINI DI RICERCA (OTTIMIZZATA)
function highlightSearchTerm(text, searchTerm) {
    if (!text || !searchTerm) return text;
    
    const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
    return text.replace(regex, '<mark style="background: #FFD700; color: #000; padding: 2px 4px; border-radius: 3px;">$1</mark>');
}

// üõ°Ô∏è ESCAPE CARATTERI SPECIALI REGEX
function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}


// üîß FUNZIONE FILTRI INVENTARIO COMPLETA
function filterInventory(filterType) {
    // Aggiorna pulsanti attivi
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    console.log('üîß Filtro inventario:', filterType);
    
    // Usa i dati dall'API
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            let filteredVendere = result.data.daVendere || [];
            let filteredInterno = result.data.usoInterno || [];
            
            // Prima applica il filtro categoria corrente
            if (currentCategory !== 'all') {
                filteredVendere = filteredVendere.filter(item => 
                    (item.categoria_prodotto || 'generale') === currentCategory
                );
                filteredInterno = filteredInterno.filter(item => 
                    (item.categoria_prodotto || 'generale') === currentCategory
                );
            }
            
            // Poi applica il filtro di stato
            switch(filterType) {
                case 'disponibili':
                    filteredVendere = filteredVendere.filter(item => item.quantita_disponibile > 0);
                    // Uso interno non ha "disponibilit√†", li mostra tutti
                    break;
                    
                case 'esauriti':
                    filteredVendere = filteredVendere.filter(item => item.quantita_disponibile <= 0);
                    filteredInterno = []; // Uso interno non pu√≤ essere "esaurito"
                    break;
                    
                case 'all':
                default:
                    // Mostra tutti (nessun filtro aggiuntivo)
                    break;
            }
            
            console.log(`üîß Filtrati per "${filterType}": ${filteredVendere.length} da vendere, ${filteredInterno.length} uso interno`);
            
            // Genera HTML con indicatori di filtro
            const getFilterIndicator = (filterType) => {
                switch(filterType) {
                    case 'disponibili': return '‚úÖ DISPONIBILI';
                    case 'esauriti': return '‚ùå ESAURITI';
                    default: return 'üåü TUTTI';
                }
            };
            
            const vendereHtml = filteredVendere.map(item => `
                <div class="item-card" style="border-left: 4px solid ${getFilterColor(filterType)};">
                    <div class="item-header">
                        <span class="item-name">üé¥ ${item.descrizione}</span>
                        <span class="item-status ${item.quantita_disponibile > 0 ? 'status-disponibile' : 'status-esaurito'}">
                            ${item.quantita_disponibile > 0 ? '‚úÖ DISPONIBILE' : '‚ùå ESAURITO'}
                        </span>
                    </div>
                    <div class="item-info-grid">
                        <div class="info-card">
                            <div class="info-label">üì¶ Quantit√†</div>
                            <div class="info-value">${item.quantita_disponibile} / ${item.quantita_totale} disponibili</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üí∞ Prezzo Acquisto</div>
                            <div class="info-value">‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)} cad.</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üë§ Acquistato da</div>
                            <div class="info-value">${item.acquistato_da}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÖ Data Acquisto</div>
                            <div class="info-value">${new Date(item.data).toLocaleDateString('it-IT')}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üíé Valore Rimanente</div>
                            <div class="info-value">‚Ç¨${(item.quantita_disponibile * parseFloat(item.prezzo_unitario)).toFixed(2)}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÅ Categoria</div>
                            <div class="info-value">${item.categoria_prodotto || 'generale'}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn btn-sell" onclick="sellItem('${item.id}', '${item.descrizione}', ${item.quantita_disponibile}, ${item.prezzo_unitario})">üìà Vendi</button>
                        <button class="action-btn btn-edit" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
                        <button class="action-btn btn-unify" onclick="selectForUnify('${item.id}', '${item.descrizione}')">üîó Unifica</button>
                        <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `).join('') || `<p style="text-align: center; color: #ccc; padding: 40px;">üì≠ Nessun prodotto ${getFilterIndicator(filterType).toLowerCase()}</p>`;
            
            const internoHtml = filteredInterno.map(item => `
                <div class="item-card" style="border-left: 4px solid ${getFilterColor(filterType)};">
                    <div class="item-header">
                        <span class="item-name">üõ°Ô∏è ${item.descrizione}</span>
                        <span class="item-status status-uso">üîß USO INTERNO</span>
                    </div>
                    <div class="item-info-grid">
                        <div class="info-card">
                            <div class="info-label">üì¶ Quantit√†</div>
                            <div class="info-value">${item.quantita_totale} pezzi</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üí∞ Prezzo Acquisto</div>
                            <div class="info-value">‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)} cad.</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üë§ Acquistato da</div>
                            <div class="info-value">${item.acquistato_da}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÖ Data Acquisto</div>
                            <div class="info-value">${new Date(item.data).toLocaleDateString('it-IT')}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üíé Valore Totale</div>
                            <div class="info-value">‚Ç¨${(item.quantita_totale * parseFloat(item.prezzo_unitario)).toFixed(2)}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">üìÅ Categoria</div>
                            <div class="info-value">${item.categoria_prodotto || 'generale'}</div>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn btn-edit" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
                        <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Elimina</button>
                    </div>
                </div>
            `).join('') || `<p style="text-align: center; color: #ccc; padding: 40px;">üì≠ Nessun prodotto uso interno</p>`;
            
            // Aggiorna l'HTML
            document.getElementById('inventoryVendereContent').innerHTML = vendereHtml;
            document.getElementById('inventoryInternoContent').innerHTML = internoHtml;
            
            console.log('‚úÖ Filtro applicato con successo!');
        }
    }).catch(error => {
        console.error('‚ùå Errore nel filtro:', error);
    });
}

// üé® FUNZIONE HELPER PER COLORI FILTRI
function getFilterColor(filterType) {
    switch(filterType) {
        case 'disponibili': return '#006400'; // Verde
        case 'esauriti': return '#8B0000';    // Rosso
        default: return '#FFD700';            // Oro
    }
}

function refreshInventory() {
    console.log('Aggiornamento inventario...');
    loadInventory();
}

// ========== MIGLIORA CONTROLLO PRODOTTI SIMILI ==========
function updateSaleInfo() {
    const select = document.getElementById('salesItemSelect');
    const option = select.options[select.selectedIndex];
    
    if (option.value && option.dataset) {
        currentItemPrice = parseFloat(option.dataset.price) || 0;
        const available = parseInt(option.dataset.available) || 0;
        
        document.getElementById('itemInfo').style.display = 'block';
        document.getElementById('itemDetails').innerHTML = 
            `<strong>Disponibili:</strong> ${available} pezzi<br>` +
            `<strong>Prezzo acquisto:</strong> ‚Ç¨${currentItemPrice.toFixed(2)} cadauno<br>` +
            `<strong>Prodotto:</strong> ${option.textContent.split(' (')[0]}`;
        
        // Imposta quantit√† massima
        const qtyInput = document.querySelector('input[name="quantita_vendita"]');
        qtyInput.max = available;
        if (parseInt(qtyInput.value) > available) {
            qtyInput.value = available;
        }
        
        calculateSalePrice();
    } else {
        document.getElementById('itemInfo').style.display = 'none';
        currentItemPrice = 0;
        clearSalePreview();
    }
}
// FUNZIONI BASE
function showTab(tabName) {
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    
    // Carica dati quando necessario
    if (tabName === 'inventory') loadInventory();
    if (tabName === 'sales') loadSalesItems();
    if (tabName === 'reports') loadSalesReport();
    if (tabName === 'cash') loadCashStatus();
    if (tabName === 'balance') loadPersonalBalanceWithPayments();
}

function showMessage(text, type) {
    document.getElementById('message').innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => document.getElementById('message').innerHTML = '', 5000);
}

function calculateUnitPrice() {
    // Retrocompatibilit√† - reindirizza alla nuova funzione
    calculateExpensePrice();
}

// FORM SPESE CON CONTROLLO SIMILARIT√Ä
document.getElementById('expenseForm').addEventListener('submit', async function(e) {
    console.log('üöÄ FORM SUBMIT TRIGGERED!'); // üÜï DEBUG
    e.preventDefault();
    console.log('‚úÖ Form submission started'); // üÜï DEBUG
const data = Object.fromEntries(new FormData(this));
    

// üÜï DEBUG: verifica che la categoria venga inviata
console.log('üìã Categoria selezionata nel form:', data.categoria_prodotto);
console.log('üìä Tutti i dati del form:', data);
    
    // Se destinazione √® "Da Vendere" o "Uso Interno", controlla similarit√†
    if (data.categoria === 'Da Vendere' || data.categoria === 'Uso Interno') {
        showMessage('üîç Controllo prodotti simili...', 'success');
        
        try {
            const similarResult = await apiCall('checkSimilarProducts', {
                productName: data.descrizione,
                categoria: data.categoria
            });
            
            if (similarResult.success && similarResult.similarities.length > 0) {
                // Trovati prodotti simili - chiedi conferma
                const confirmed = await showSimilarProductDialog(data, similarResult.similarities);
                if (!confirmed) return; // User cancelled
            }
        } catch (error) {
            console.log('Errore controllo similarit√†:', error);
            // Continua comunque con l'inserimento normale
        }
    }
    
    // Procedi con l'inserimento normale
    showMessage('‚è≥ Salvando spesa...', 'success');
    const result = await apiCall('addExpense', data);
    if (result.success) {  // ‚Üê CERCA QUESTA RIGA
        showMessage(result.message, 'success');
        invalidateInventoryCache(); // ‚Üê AGGIUNGI QUESTA RIGA QUI
        this.reset();
    document.querySelector('input[name="data"]').value = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="quantita"]').value = 1;
    document.getElementById('pricePreview').style.display = 'none';
}
});

// STUB PER ALTRI FORM
// FORM VENDITE - VERSIONE VERA
document.getElementById('salesForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    
    showMessage('‚è≥ Registrando vendita...', 'success');
    
    try {
        const result = await apiCall('addSale', data);
        
        if (result.success) {
            showMessage(result.message, 'success');
            invalidateInventoryCache();
            this.reset();
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="data_vendita"]').value = today;
            
            // Ricarica inventario dopo vendita
            loadInventory();
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå Errore: ' + error.message, 'error');
    }
});
document.getElementById('addCashForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    
    showMessage('‚è≥ Aggiungendo alla cassa...', 'success');
    
    try {
        const result = await apiCall('addCash', data);
        
        if (result.success) {
            showMessage(result.message, 'success');
            this.reset();
            loadCashStatus();
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå Errore: ' + error.message, 'error');
    }
});
// FORM PAGAMENTI INTERNI
document.getElementById('internalPaymentForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    
    // Validazione: non puoi pagare a te stesso
    if (data.da_chi === data.a_chi) {
        showMessage('‚ùå Non puoi pagare a te stesso!', 'error');
        return;
    }
    
    showMessage('‚è≥ Registrando pagamento...', 'success');
    
    try {
        const result = await apiCall('addInternalPayment', data);
        
        if (result.success) {
            showMessage(result.message, 'success');
            this.reset();
            loadPersonalBalanceWithPayments();
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå Errore: ' + error.message, 'error');
    }
});
// CARICAMENTO SEZIONI
async function loadInventory() {
    invalidateInventoryCache(); // ‚Üê AGGIUNGI QUESTA RIGA QUI
    document.getElementById('inventoryLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getInventory');
        
        if (result.success && result.data) {
        // Renderizza inventario da vendere
const vendereHtml = result.data.daVendere.map(item => `
    <div class="item-card">
        <div class="item-header">
            <span class="item-name">üé¥ ${item.descrizione}</span>
            <span class="item-status ${item.quantita_disponibile > 0 ? 'status-disponibile' : 'status-esaurito'}">
                ${item.quantita_disponibile > 0 ? '‚úÖ DISPONIBILE' : '‚ùå ESAURITO'}
            </span>
        </div>
        <div class="item-info-grid">
            <div class="info-card">
                <div class="info-label">üì¶ Quantit√†</div>
                <div class="info-value">${item.quantita_disponibile} / ${item.quantita_totale} disponibili</div>
            </div>
            <div class="info-card">
                <div class="info-label">üí∞ Prezzo Acquisto</div>
                <div class="info-value">‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)} cad.</div>
            </div>
            <div class="info-card">
                <div class="info-label">üë§ Acquistato da</div>
                <div class="info-value">${item.acquistato_da}</div>
            </div>
            <div class="info-card">
                <div class="info-label">üìÖ Data Acquisto</div>
                <div class="info-value">${new Date(item.data).toLocaleDateString('it-IT')}</div>
            </div>
            <div class="info-card">
                <div class="info-label">üíé Valore Rimanente</div>
                <div class="info-value">‚Ç¨${(item.quantita_disponibile * parseFloat(item.prezzo_unitario)).toFixed(2)}</div>
            </div>
        </div>
        <div class="item-actions">
            <button class="action-btn btn-sell" onclick="sellItem('${item.id}', '${item.descrizione}', ${item.quantita_disponibile}, ${item.prezzo_unitario})">üìà Vendi</button>
            <button class="action-btn btn-edit" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
            <button class="action-btn btn-unify" onclick="selectForUnify('${item.id}', '${item.descrizione}')">üîó Unifica</button>
            <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Elimina</button>
        </div>
    </div>
`).join('') || '<p>Nessun oggetto da vendere</p>';

// Renderizza inventario uso interno
const internoHtml = result.data.usoInterno.map(item => `
    <div class="item-card">
        <div class="item-header">
            <span class="item-name">üõ°Ô∏è ${item.descrizione}</span>
            <span class="item-status status-uso">üîß USO INTERNO</span>
        </div>
        <div class="item-info-grid">
            <div class="info-card">
                <div class="info-label">üì¶ Quantit√†</div>
                <div class="info-value">${item.quantita_totale} pezzi</div>
            </div>
            <div class="info-card">
                <div class="info-label">üí∞ Prezzo Acquisto</div>
                <div class="info-value">‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)} cad.</div>
            </div>
            <div class="info-card">
                <div class="info-label">üë§ Acquistato da</div>
                <div class="info-value">${item.acquistato_da}</div>
            </div>
            <div class="info-card">
                <div class="info-label">üìÖ Data Acquisto</div>
                <div class="info-value">${new Date(item.data).toLocaleDateString('it-IT')}</div>
            </div>
            <div class="info-card">
                <div class="info-label">üíé Valore Totale</div>
                <div class="info-value">‚Ç¨${(item.quantita_totale * parseFloat(item.prezzo_unitario)).toFixed(2)}</div>
            </div>
        </div>
        <div class="item-actions">
            <button class="action-btn btn-edit" onclick="editItem('${item.id}')">‚úèÔ∏è Modifica</button>
            <button class="action-btn btn-delete" onclick="deleteItem('${item.id}')">üóëÔ∏è Elimina</button>
        </div>
    </div>
`).join('') || '<p>Nessun oggetto uso interno</p>';

document.getElementById('inventoryVendereContent').innerHTML = vendereHtml;
document.getElementById('inventoryInternoContent').innerHTML = internoHtml;
updateInventoryStats(result.data);
updateCategoryCounters(); // ‚Üê AGGIUNGI QUESTA RIGA
} else {
    showMessage('‚ùå ' + (result.message || 'Errore caricamento inventario'), 'error');
}
} catch (error) {
    showMessage('‚ùå Errore: ' + error.message, 'error');
}

document.getElementById('inventoryLoading').style.display = 'none';
}
// CARICA OGGETTI VENDIBILI NEL DROPDOWN
function loadSalesItems() {
    apiCall('getInventory').then(result => {
        const select = document.getElementById('salesItemSelect');
        let options = '<option value="">Seleziona oggetto...</option>';
        
        if (result.success && result.data && result.data.daVendere) {
            result.data.daVendere.forEach(item => {
                if (item.quantita_disponibile > 0) {
                    options += `<option value="${item.id}">${item.descrizione} (${item.quantita_disponibile} disp. - ‚Ç¨${parseFloat(item.prezzo_unitario).toFixed(2)} cad.)</option>`;
                }
            });
        }
        
        if (select) select.innerHTML = options;
    });
}
// MODIFICA OGGETTO INVENTARIO
function editItem(itemId) {
    // Prima recupera i dati attuali
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            // Trova l'oggetto corrente
            let currentItem = null;
            [...result.data.daVendere, ...result.data.usoInterno].forEach(item => {
                if (item.id === itemId) currentItem = item;
            });
            
            if (!currentItem) {
                showMessage('‚ùå Oggetto non trovato', 'error');
                return;
            }
            
            // Crea form di modifica
            const editHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 90%; border: 2px solid #8B0000;">
                        <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">‚úèÔ∏è Modifica Oggetto</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="color: #FFD700; display: block; margin-bottom: 5px;">üìù Nome:</label>
                            <input type="text" id="editName" value="${currentItem.descrizione}" style="width: 100%; padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="color: #FFD700; display: block; margin-bottom: 5px;">üì¶ Quantit√† Totale:</label>
                            <input type="number" id="editQuantity" value="${currentItem.quantita_totale}" min="1" style="width: 100%; padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="color: #FFD700; display: block; margin-bottom: 5px;">üí∞ Prezzo Unitario ‚Ç¨:</label>
                            <input type="number" id="editPrice" value="${currentItem.prezzo_unitario}" step="0.01" min="0" style="width: 100%; padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveItemChanges('${itemId}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #8B0000, #FF0000); color: white; border: none; border-radius: 8px; font-weight: bold;">üíæ Salva</button>
                            <button onclick="closeEditModal()" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold;">‚ùå Annulla</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', editHtml);
        }
    });
}
   // SALVA MODIFICHE OGGETTO
function saveItemChanges(itemId) {
    const newName = document.getElementById('editName').value.trim();
    const newQuantity = parseInt(document.getElementById('editQuantity').value);
    const newPrice = parseFloat(document.getElementById('editPrice').value);
    
    if (!newName || newQuantity < 1 || newPrice < 0) {
        alert('‚ùå Compila tutti i campi correttamente!');
        return;
    }
    
    apiCall('updateItemComplete', {
        id: itemId,
        nuovo_nome: newName,
        nuova_quantita: newQuantity,
        nuovo_prezzo: newPrice
    }).then(result => {
        if (result.success) {
            showMessage('‚úÖ Oggetto modificato!', 'success');
            closeEditModal();
            loadInventory();
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    });
}

// CHIUDI MODAL MODIFICA
function closeEditModal() {
    const modal = document.querySelector('div[style*="position: fixed"]');
    if (modal) modal.remove();
}     
// MOSTRA DIALOG PER PRODOTTI SIMILI
async function showSimilarProductDialog(newProductData, similarities) {
    return new Promise((resolve) => {
        const bestMatch = similarities[0]; // Il pi√π simile
        
        // Salva dati per la funzione unify
        window.currentExpenseData = newProductData;
        window.currentSimilarProduct = bestMatch;
        
        const dialogHtml = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <!-- ... resto del dialog ... -->
                <div style="background: #1a1a1a; padding: 25px; border-radius: 15px; max-width: 95%; border: 3px solid #FFD700; max-height: 80vh; overflow-y: auto;">
                    
                    <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">‚ö†Ô∏è PRODOTTO SIMILE TROVATO</h3>
                    
                    <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #FFD700;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">üì¶ Stai inserendo:</div>
                        <div style="color: #fff; font-size: 1.1em;">"${newProductData.descrizione}"</div>
                        <div style="color: #ccc; font-size: 0.9em; margin-top: 5px;">
                            ${newProductData.quantita}x - ‚Ç¨${parseFloat(newProductData.prezzo_totale).toFixed(2)} totale - ${newProductData.socio}
                        </div>
                    </div>
                    
                    <div style="background: rgba(139,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #8B0000;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">üîç Prodotto esistente simile:</div>
                        <div style="color: #fff; font-size: 1.1em;">"${bestMatch.name}"</div>
                        <div style="color: #ccc; font-size: 0.9em; margin-top: 5px;">
                            ${bestMatch.quantity}x totali (${bestMatch.available}x disponibili) - ‚Ç¨${parseFloat(bestMatch.price).toFixed(2)} cad. - ${bestMatch.owner}
                        </div>
                        <div style="color: #90EE90; font-size: 0.8em; margin-top: 8px;">
                            üìä Similarit√†: ${bestMatch.confidence}% | Parole comuni: ${bestMatch.commonWords.join(', ')}
                        </div>
                    </div>
                    
                    <div style="color: #FFD700; font-weight: bold; margin-bottom: 15px; text-align: center;">ü§î Cosa vuoi fare?</div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="handleSimilarChoice('unify')" style="padding: 12px; background: linear-gradient(135deg, #006400, #90EE90); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">
                            üîÑ UNIFICA - Aggiungi al prodotto esistente
                        </button>
                        <button onclick="handleSimilarChoice('separate')" style="padding: 12px; background: linear-gradient(135deg, #8B0000, #FF0000); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">
                            üÜï SEPARA - Mantieni come prodotto diverso
                        </button>
                        <button onclick="handleSimilarChoice('cancel')" style="padding: 12px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">
                            ‚ùå ANNULLA - Torna alla modifica
                        </button>
                    </div>
                    
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', dialogHtml);
        
        // Gestione scelte
        window.handleSimilarChoice = function(choice) {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) modal.remove();
            
            if (choice === 'unify') {
    showMessage('üîÑ Unificando prodotto...', 'success');
    
    // Chiama API per unificare
    apiCall('unifyProductDuringExpense', {
        newExpenseData: JSON.stringify(window.currentExpenseData),
        existingProductId: window.currentSimilarProduct.id
    }).then(result => {
        if (result.success) {
            showMessage(result.message, 'success');
            document.getElementById('expenseForm').reset();
            document.querySelector('input[name="data"]').value = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="quantita"]').value = 1;
            document.getElementById('pricePreview').style.display = 'none';
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    }).catch(error => {
        showMessage('‚ùå Errore unificazione: ' + error.message, 'error');
    });
    
    resolve(true); // Operazione completata
} else if (choice === 'separate') {
    resolve(true); // Procedi con inserimento normale
} else {
    resolve(false); // Annulla inserimento
}
        };
    });
}
// ELIMINA OGGETTO INVENTARIO
function deleteItem(itemId) {
    // Prima recupera info prodotto per messaggio personalizzato
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            // Trova il prodotto da eliminare
            let productToDelete = null;
            [...result.data.daVendere, ...result.data.usoInterno].forEach(item => {
                if (item.id === itemId) productToDelete = item;
            });
            
            if (!productToDelete) {
                showMessage('‚ùå Prodotto non trovato', 'error');
                return;
            }
            
            // Conferma eliminazione personalizzata
            const confirmMessage = `‚ö†Ô∏è ELIMINAZIONE COMPLETA
            
üì¶ Prodotto: "${productToDelete.descrizione}"
üë§ Acquistato da: ${productToDelete.acquistato_da}
üìä Quantit√†: ${productToDelete.quantita_totale} (${productToDelete.quantita_disponibile} disponibili)
üí∞ Valore: ‚Ç¨${(productToDelete.quantita_totale * parseFloat(productToDelete.prezzo_unitario)).toFixed(2)}

üóëÔ∏è COSA VERR√Ä ELIMINATO:
‚úÖ Prodotto dall'inventario
‚úÖ Spesa originale (‚Ç¨${(productToDelete.quantita_totale * parseFloat(productToDelete.prezzo_unitario)).toFixed(2)})
‚úÖ Movimento cassa (se applicabile)
‚úÖ Aggiornamento bilancio personale

‚ùó Le eventuali VENDITE gi√† registrate rimarranno nel sistema.

Sei sicuro di voler procedere?`;
            
            if (confirm(confirmMessage)) {
                showMessage('üóëÔ∏è Eliminazione in corso...', 'success');
                
                apiCall('deleteItem', { id: itemId }).then(deleteResult => {
                    if (deleteResult.success) {
                        showMessage(deleteResult.message, 'success');
                        
                        // üîÑ AGGIORNA TUTTO DOPO ELIMINAZIONE
invalidateInventoryCache();
loadInventory();

// üîÑ FORZA AGGIORNAMENTO COMPLETO STATISTICHE
setTimeout(() => {
    updateInventoryStats(result.data || {});
    updateCategoryCounters();
    
    // Ricarica anche l'inventario per sicurezza
    apiCall('getInventory').then(invResult => {
        if (invResult.success && invResult.data) {
            updateInventoryStats(invResult.data);
            updateCategoryCounters();
        }
    });
}, 500); // Piccolo delay per essere sicuri
                        
                        // Se siamo in altre tab, aggiorna anche quelle
                        const activeTab = document.querySelector('.tab.active');
                        if (activeTab) {
                            const tabText = activeTab.textContent.toLowerCase();
                            if (tabText.includes('bilancio')) {
                                loadPersonalBalanceWithPayments();
                            } else if (tabText.includes('cassa')) {
                                loadCashStatus();
                            } else if (tabText.includes('report')) {
                                loadSalesReport();
                            }
                        }
                        
                    } else {
                        showMessage('‚ùå ' + deleteResult.message, 'error');
                    }
                }).catch(error => {
                    showMessage('‚ùå Errore eliminazione: ' + error.message, 'error');
                });
            }
        }
    }).catch(error => {
        // Fallback se non riesce a caricare info prodotto
        if (confirm("üóëÔ∏è Sei sicuro di voler eliminare questo oggetto?\n\n‚ö†Ô∏è Verr√† rimosso completamente da spese e inventario.\nLe eventuali vendite rimarranno registrate.")) {
            apiCall('deleteItem', { id: itemId }).then(result => {
                if (result.success) {
                    showMessage(result.message, 'success');
                    invalidateInventoryCache();
loadInventory();

// üîÑ AGGIORNA STATISTICHE ANCHE NEL FALLBACK
setTimeout(() => {
    updateCategoryCounters();
    apiCall('getInventory').then(invResult => {
        if (invResult.success && invResult.data) {
            updateInventoryStats(invResult.data);
        }
    });
}, 500);
                } else {
                    showMessage('‚ùå ' + result.message, 'error');
                }
            });
        }
    });
}

async function loadSalesReport() {
    document.getElementById('reportsLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getSalesReport');
        
        if (result.success) {
            const { sales, stats } = result;
            
            // üõ°Ô∏è PROTEZIONE CONTRO NaN - valori di default con conversione forzata
const safeStats = {
    totalRevenue: parseFloat(stats.totalRevenue) || 0,
    totalProfit: parseFloat(stats.totalProfit) || 0,
    avgROI: parseFloat(stats.avgROI) || 0,
    itemsSold: parseInt(stats.itemsSold) || 0,
    totalCost: parseFloat(stats.totalCost) || 0,
    transactionCount: parseInt(stats.transactionCount) || 0
};
            
            console.log('üìä Stats ricevute:', stats);
            console.log('üõ°Ô∏è Stats sicure:', safeStats);
            
            const statsHtml = `
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">‚Ç¨${safeStats.totalRevenue.toFixed(2)}</div>
            <div class="stat-label">Ricavo Totale</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">‚Ç¨${safeStats.totalProfit.toFixed(2)}</div>
            <div class="stat-label">Profitto Totale</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">‚Ç¨${(safeStats.totalProfit / 3).toFixed(2)}</div>
            <div class="stat-label">Profitto per Socio</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${safeStats.avgROI.toFixed(1)}%</div>
            <div class="stat-label">ROI Medio</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${safeStats.itemsSold}</div>
            <div class="stat-label">Oggetti Venduti</div>
        </div>
    </div>
`;
            
            // üõ°Ô∏è PROTEZIONE ANCHE PER LE VENDITE INDIVIDUALI
            const safeSales = (sales || []).map(sale => ({
                quantita: sale.quantita || 0,
                oggetto: sale.oggetto || 'Prodotto sconosciuto',
                profitto_totale: isNaN(parseFloat(sale.profitto_totale)) ? 0 : parseFloat(sale.profitto_totale),
                prezzo_totale_vendita: isNaN(parseFloat(sale.prezzo_totale_vendita)) ? 0 : parseFloat(sale.prezzo_totale_vendita),
                venduto_a: sale.venduto_a || 'Cliente sconosciuto',
                data: sale.data || new Date().toISOString()
            }));
            
            const salesHtml = safeSales.slice(-5).reverse().map(sale => {
    // Calcola percentuale di profitto
    const costPrice = sale.prezzo_totale_vendita - sale.profitto_totale;
    const profitPercentage = costPrice > 0 ? ((sale.profitto_totale / costPrice) * 100).toFixed(1) : 0;
    
    return `
        <div class="item-card">
            <div class="item-header">
                <span class="item-name">${sale.quantita}x ${sale.oggetto}</span>
                <span class="profit-${sale.profitto_totale >= 0 ? 'positive' : 'negative'}">
                    ${sale.profitto_totale >= 0 ? '+' : ''}‚Ç¨${sale.profitto_totale.toFixed(2)}
                </span>
            </div>
            <div class="item-details">
                <strong>Vendita:</strong> ‚Ç¨${sale.prezzo_totale_vendita.toFixed(2)} totale<br>
                <strong>Profitto:</strong> ${sale.profitto_totale >= 0 ? '+' : ''}‚Ç¨${sale.profitto_totale.toFixed(2)} (${sale.profitto_totale >= 0 ? '+' : ''}${profitPercentage}%)<br>
                <strong>Venduto a:</strong> ${sale.venduto_a}<br>
                <strong>Data:</strong> ${new Date(sale.data).toLocaleDateString('it-IT')}
            </div>
        </div>
    `;
}).join('');
            
            document.getElementById('reportsContent').innerHTML = 
                statsHtml + 
                '<h3 style="color: #FFD700; margin: 20px 0; text-align: center;">üìà Vendite Recenti</h3>' + 
                (salesHtml || '<p style="text-align: center; color: #ccc; padding: 40px;">üì≠ Nessuna vendita registrata</p>');
                
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        console.error('‚ùå Errore completo loadSalesReport:', error);
        showMessage('‚ùå Errore caricamento report: ' + error.toString(), 'error');
    }
    
    document.getElementById('reportsLoading').style.display = 'none';
}
async function loadCashStatus() {
    document.getElementById('cashLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getCashStatus');
        
        if (result.success) {
            const statsHtml = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨${result.saldoCassa.toFixed(2)}</div>
                        <div class="stat-label">Saldo Attuale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨${result.daVendite.toFixed(2)}</div>
                        <div class="stat-label">Da Vendite</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨${result.versamenti.toFixed(2)}</div>
                        <div class="stat-label">Versamenti</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨${result.spese.toFixed(2)}</div>
                        <div class="stat-label">Spese</div>
                    </div>
                </div>
            `;
            
            document.getElementById('cashContent').innerHTML = statsHtml;
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå Errore caricamento cassa: ' + error.toString(), 'error');
    }
    
    document.getElementById('cashLoading').style.display = 'none';
}
async function loadPersonalBalance() {
    document.getElementById('balanceLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getPersonalBalance');
        
        if (result.success) {
            const { balance } = result;
            
            const balanceHtml = `
                <div class="balance-item">
                    <span class="balance-name" onclick="showPersonDetails('Ciano')" style="cursor: pointer;">üéÆ Ciano</span>
                    <span class="balance-amount ${balance.ciano.differenza >= 0 ? 'positive' : 'negative'}">${balance.ciano.stato}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-name" onclick="showPersonDetails('Alex')" style="cursor: pointer;">üî• Alex</span>
                    <span class="balance-amount ${balance.alex.differenza >= 0 ? 'positive' : 'negative'}">${balance.alex.stato}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-name" onclick="showPersonDetails('King')" style="cursor: pointer;">üëë King</span>
                    <span class="balance-amount ${balance.king.differenza >= 0 ? 'positive' : 'negative'}">${balance.king.stato}</span>
                </div>
                <div class="balance-item" style="border-top: 2px solid #FFD700; margin-top: 15px; padding-top: 15px;">
                    <span class="balance-name">üí∞ Totale Investito</span>
                    <span class="balance-amount" style="background: #FFD700; color: #000;">‚Ç¨${balance.totale.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('balanceContent').innerHTML = balanceHtml;
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå Errore caricamento bilancio: ' + error.toString(), 'error');
    }
    
      document.getElementById('balanceLoading').style.display = 'none';
}
    // CARICA BILANCIO CON PAGAMENTI
// SOSTITUISCI COMPLETAMENTE la funzione loadPersonalBalanceWithPayments() con questa:
async function loadPersonalBalanceWithPayments() {
    document.getElementById('balanceLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getPersonalBalanceWithPayments');
        
        if (result.success) {
            const { balance, pagamenti } = result;
            // üéØ CALCOLA CHI DEVE VERSARE A CHI
    const destinatari = calcolaDestinatari(balance);
    
    // Aggiungi destinatari ai dati
    balance.ciano.destinatario = destinatari.ciano;
    balance.alex.destinatario = destinatari.alex;
    balance.king.destinatario = destinatari.king;
            // üéØ NUOVO HTML GENERATO CON CARD CHIARE
            const balanceHtml = `
    ${createBalanceExplanation()}
    ${generateBalanceCard('üéÆ Ciano', balance.ciano, balance.totale)}
    ${generateBalanceCard('üî• Alex', balance.alex, balance.totale)}
    ${generateBalanceCard('üëë King', balance.king, balance.totale)}
                
                <div class="balance-item-new" style="border-color: #FFD700;">
                    <div class="balance-header" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
                        <span class="balance-name-new" style="color: #000;">üí∞ Totale Investito</span>
                        <span class="balance-status" style="background: #000; color: #FFD700;">‚Ç¨${balance.totale.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            // Cronologia pagamenti (come prima)
            let paymentsHtml = '';
            if (pagamenti && pagamenti.length > 0) {
                paymentsHtml = `
                    <h3 style="color: #FFD700; margin: 20px 0 10px 0; text-align: center;">üìã Ultimi Pagamenti</h3>
                    ${pagamenti.slice(0, 5).map(payment => `
                        <div class="cash-movement movement-out">
                            <div>
                                <strong>${payment[1]} ‚Üí ${payment[2]}</strong><br>
                                <small>${payment[4]} ‚Ä¢ ${new Date(payment[0]).toLocaleDateString('it-IT')}</small>
                            </div>
                            <span class="balance-amount negative">‚Ç¨${parseFloat(payment[3]).toFixed(2)}</span>
                        </div>
                    `).join('')}
                `;
            }
            
            document.getElementById('balanceContent').innerHTML = balanceHtml + paymentsHtml;
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå Errore caricamento bilancio: ' + error.toString(), 'error');
    }
    
    document.getElementById('balanceLoading').style.display = 'none';
}

// üéØ SOSTITUISCI COMPLETAMENTE la funzione generateBalanceCard() con questa:
function generateBalanceCard(nome, dati, totaleInvestito) {
    const statusClass = dati.reale >= 0 ? 'status-positive' : 'status-negative';
    const statusColor = dati.reale >= 0 ? '#90EE90' : '#FFB6C1';
    const quotaTeorica = totaleInvestito / 3;
    
    // Calcola quanto ha speso realmente (dalla differenza teorica)
    const spesoReale = quotaTeorica + dati.teorico;
    
    // üÜï CALCOLA BILANCIO TEORICO PURO (senza pagamenti)
    const differenzaTeoricaPura = dati.teorico;
    const statusTeorico = differenzaTeoricaPura >= 0 ? 'Riceve' : 'Versa';
    const importoTeorico = Math.abs(differenzaTeoricaPura);
    const coloreTeorico = differenzaTeoricaPura >= 0 ? '#90EE90' : '#FFB6C1';
    
    return `
        <div class="balance-item-new">
            <div class="balance-header">
                <span class="balance-name-new" onclick="showPersonDetails('${nome.replace(/[üéÆüî•üëë]/g, '').trim()}')">${nome}</span>
                <span class="balance-status ${statusClass}">${dati.stato}</span>
            </div>
            <div class="balance-details">
                <!-- üìä SEZIONE BILANCIO TEORICO -->
                <div class="detail-row" style="background: rgba(255,215,0,0.1); padding: 8px; border-radius: 5px; margin-bottom: 10px;">
                    <span class="detail-label">üìä TEORICO (solo spese):</span>
                    <span class="detail-value" style="color: ${coloreTeorico}; font-weight: bold;">${statusTeorico} ‚Ç¨${importoTeorico.toFixed(2)}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">üí∞ Ha Speso:</span>
                    <span class="detail-value">‚Ç¨${spesoReale.toFixed(2)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">üìè Dovrebbe Spendere:</span>
                    <span class="detail-value">‚Ç¨${quotaTeorica.toFixed(2)}</span>
                </div>
                
                <div class="divider"></div>
                
                <!-- üí∏ SEZIONE PAGAMENTI E SALDO FINALE -->
                <div class="detail-row">
                    <span class="detail-label">${dati.pagamenti > 0 ? 'üí∞ SOLDI RICEVUTI dagli altri:' : dati.pagamenti < 0 ? 'üí∏ SOLDI DATI agli altri:' : 'üí≥ Nessun pagamento:'}</span>
                    <span class="detail-value">${dati.pagamenti > 0 ? '+‚Ç¨' + dati.pagamenti.toFixed(2) : dati.pagamenti < 0 ? '‚Ç¨' + Math.abs(dati.pagamenti).toFixed(2) : '‚Ç¨0.00'}</span>
                </div>
                <div class="detail-row" style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; margin-top: 8px;">
    <span class="detail-label">üéØ SALDO FINALE:</span>
    <span class="detail-value" style="color: ${statusColor}; font-weight: bold; font-size: 1.1em;">${dati.reale >= 0 ? '+' : ''}‚Ç¨${dati.reale.toFixed(2)}</span>
</div>
${dati.reale !== 0 ? `
<div class="detail-row" style="background: rgba(255,215,0,0.1); padding: 8px; border-radius: 5px; margin-top: 5px; border: 1px solid #FFD700;">
    <span class="detail-label">${dati.reale > 0 ? 'üéÅ RICEVERAI DA:' : 'üí∏ VERSA A:'}</span>
    <span class="detail-value" style="font-weight: bold;">${dati.destinatario || 'Calcolo in corso...'}</span>
</div>
` : ''}
            </div>
        </div>
    `;
}

    // üéØ NUOVA FUNZIONE PER SPIEGAZIONE BILANCIO
function createBalanceExplanation() {
    return `
        <div class="info-box" style="margin-bottom: 20px; background: rgba(255,215,0,0.1); border: 2px solid #FFD700;">
            <div class="info-title">üí° Come Funziona il Bilancio</div>
            <p><strong>üîÑ DINAMICO:</strong> Questo bilancio si aggiorna <strong>automaticamente</strong> ogni volta che:</p>
            <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.5;">
                <li>üì¶ <strong>Qualcuno fa una spesa</strong> ‚Üí cambia chi deve dare/ricevere soldi</li>
                <li>üí∏ <strong>Fate un pagamento interno</strong> ‚Üí si aggiorna il saldo finale</li>
            </ul>
            <p style="margin-top: 10px;"><strong>üéØ Saldo Finale =</strong> Quanto dovete dare/ricevere <strong>ADESSO</strong> per essere in pari!</p>
        </div>
    `;
}
      // üéØ FUNZIONE PER CALCOLARE CHI DEVE VERSARE A CHI
function calcolaDestinatari(balance) {
    const persone = [
        { nome: 'Ciano', saldo: balance.ciano.reale },
        { nome: 'Alex', saldo: balance.alex.reale },
        { nome: 'King', saldo: balance.king.reale }
    ];
    
    // Separa chi deve ricevere e chi deve versare
    const deveRicevere = persone.filter(p => p.saldo > 0).sort((a, b) => b.saldo - a.saldo);
    const deveVersare = persone.filter(p => p.saldo < 0).sort((a, b) => a.saldo - b.saldo);
    const inPari = persone.filter(p => Math.abs(p.saldo) < 0.01);
    
    const destinatari = {};
    
    // Chi √® in pari
    inPari.forEach(persona => {
        destinatari[persona.nome.toLowerCase()] = 'In pari! üéØ';
    });
    
    // Chi deve ricevere
    deveRicevere.forEach(persona => {
        const versatori = deveVersare.filter(p => p.saldo < 0).map(p => p.nome);
        if (versatori.length > 0) {
            destinatari[persona.nome.toLowerCase()] = versatori.join(' e ');
        } else {
            destinatari[persona.nome.toLowerCase()] = 'Tutti in pari';
        }
    });
    
    // Chi deve versare
    deveVersare.forEach(persona => {
        const ricevitori = deveRicevere.filter(p => p.saldo > 0).map(p => p.nome);
        if (ricevitori.length > 0) {
            destinatari[persona.nome.toLowerCase()] = ricevitori.join(' e ');
        } else {
            destinatari[persona.nome.toLowerCase()] = 'Tutti in pari';
        }
    });
    
    return destinatari;
}  
// CAMBIA TAB INVENTARIO
function showInventoryTab(type) {
    document.querySelectorAll('.inventory-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.inventory-content').forEach(content => {
        content.classList.remove('active');
    });
    
    const clickedTab = document.querySelector(`[onclick="showInventoryTab('${type}')"]`);
    if (clickedTab) clickedTab.classList.add('active');
    
    document.getElementById('inventario-' + type).classList.add('active');
}
    // MOSTRA DETTAGLI ACQUISTI PERSONA
function showPersonDetails(persona) {
    showMessage('‚è≥ Caricando dettagli...', 'success');
    
    apiCall('getPersonDetails', { persona: persona }).then(result => {
        if (result.success && result.acquisti) {
            let detailsHtml = `<h3 style="color: #FFD700; text-align: center; margin: 20px 0;">üõí Acquisti di ${persona}</h3>`;
            
            result.acquisti.forEach(acquisto => {
                detailsHtml += `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-name">${acquisto.descrizione}</span>
                            <span class="profit-positive">‚Ç¨${parseFloat(acquisto.prezzo_totale).toFixed(2)}</span>
                        </div>
                        <div class="item-details">
                            <strong>Quantit√†:</strong> ${acquisto.quantita}<br>
                            <strong>Prezzo unitario:</strong> ‚Ç¨${(parseFloat(acquisto.prezzo_totale) / parseInt(acquisto.quantita)).toFixed(2)}<br>
                            <strong>Dove:</strong> ${acquisto.dove}<br>
                            <strong>Data:</strong> ${new Date(acquisto.data).toLocaleDateString('it-IT', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}<br>
                            <strong>Tipo:</strong> ${acquisto.categoria}
                        </div>
                    </div>
                `;
            });
            
            detailsHtml += `
                <div style="text-align: center; margin: 20px 0;">
                    <strong style="color: #FFD700;">Totale Speso: ‚Ç¨${result.totale_speso.toFixed(2)}</strong>
                </div>
                <button class="btn" onclick="loadPersonalBalance()">üîô Torna al Bilancio</button>
            `;
            
            document.getElementById('balanceContent').innerHTML = detailsHtml;
        } else {
            showMessage('‚ùå Errore caricamento dettagli', 'error');
        }
    });
}
   // SISTEMA UNIFICAZIONE INVENTARIO
let unificationMode = false;
let selectedProductForUnify = null;

function selectForUnify(productId, productName) {
    if (!unificationMode) {
        // Attiva modalit√† unificazione
        unificationMode = true;
        selectedProductForUnify = { id: productId, name: productName };
        
        showMessage(`üîó Modalit√† unificazione attiva! Seleziona il secondo prodotto da unificare con "${productName}"`, 'success');
        
        // Evidenzia tutti i pulsanti unifica
        document.querySelectorAll('button[onclick*="selectForUnify"]').forEach(btn => {
            if (btn.onclick.toString().includes(productId)) {
                btn.style.background = '#FFD700';
                btn.style.color = '#000';
                btn.innerHTML = 'üü° Selezionato';
            } else {
                btn.style.background = '#FF4500';
                btn.innerHTML = 'üîó Seleziona per unificare';
            }
        });
        
        // Aggiungi pulsante di annullamento
        showUnificationControls();
        
    } else {
        // Secondo prodotto selezionato - conferma unificazione
        if (productId === selectedProductForUnify.id) {
            showMessage('‚ùå Non puoi unificare un prodotto con se stesso!', 'error');
            return;
        }
        
        showUnificationConfirmDialog(selectedProductForUnify, { id: productId, name: productName });
    }
}

function showUnificationControls() {
    const controlsHtml = `
        <div id="unificationControls" style="position: fixed; bottom: 20px; left: 20px; right: 20px; background: #FFD700; color: #000; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; z-index: 1000;">
            üîó Modalit√† Unificazione Attiva - Seleziona il secondo prodotto
            <br>
            <button onclick="cancelUnification()" style="margin-top: 10px; background: #8B0000; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold;">‚ùå Annulla</button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', controlsHtml);
}

function cancelUnification() {
    unificationMode = false;
    selectedProductForUnify = null;
    
    // Ripristina pulsanti originali
    document.querySelectorAll('button[onclick*="selectForUnify"]').forEach(btn => {
        btn.style.background = '#006400';
        btn.style.color = 'white';
        btn.innerHTML = 'üîó Unifica';
    });
    
    // Rimuovi controlli
    const controls = document.getElementById('unificationControls');
    if (controls) controls.remove();
    
    showMessage('‚ùå Unificazione annullata', 'error');
}

function showUnificationConfirmDialog(product1, product2) {
    const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: #1a1a1a; padding: 25px; border-radius: 15px; max-width: 95%; border: 3px solid #FFD700;">
                
                <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">üîó CONFERMA UNIFICAZIONE</h3>
                
                <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #FFD700;">
                    <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">üì¶ Prodotto 1:</div>
                    <div style="color: #fff;">"${product1.name}"</div>
                </div>
                
                <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #FFD700;">
                    <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">üì¶ Prodotto 2:</div>
                    <div style="color: #fff;">"${product2.name}"</div>
                </div>
                
                <div style="color: #FFD700; font-weight: bold; margin-bottom: 15px; text-align: center;">
                    ‚ö†Ô∏è I due prodotti verranno unificati in uno solo!
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="confirmUnification('${product1.id}', '${product2.id}')" style="padding: 12px; background: linear-gradient(135deg, #006400, #90EE90); color: white; border: none; border-radius: 8px; font-weight: bold;">
                        ‚úÖ CONFERMA UNIFICAZIONE
                    </button>
                    <button onclick="closeUnificationDialog()" style="padding: 12px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold;">
                        ‚ùå ANNULLA
                    </button>
                </div>
                
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHtml);
}

function confirmUnification(productId1, productId2) {
    showMessage('üîó Unificando prodotti...', 'success');
    
    apiCall('unifyExistingProducts', {
        productId1: productId1,
        productId2: productId2
    }).then(result => {
        closeUnificationDialog();
        cancelUnification();
        
        if (result.success) {
            showMessage(result.message, 'success');
            loadInventory(); // Ricarica inventario
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    }).catch(error => {
        showMessage('‚ùå Errore unificazione: ' + error.message, 'error');
    });
}

function closeUnificationDialog() {
    const dialog = document.querySelector('div[style*="position: fixed"][style*="z-index: 9999"]');
    if (dialog) dialog.remove();
}
 // AGGIORNA STATISTICHE INVENTARIO
function updateInventoryStats(data) {
    const totalItems = (data.daVendere?.length || 0) + (data.usoInterno?.length || 0);
    const availableItems = data.daVendere?.filter(item => item.quantita_disponibile > 0).length || 0;
    
    let totalValue = 0;
    let soldValue = 0;
    
    // Calcola valori
    [...(data.daVendere || []), ...(data.usoInterno || [])].forEach(item => {
        const itemValue = item.quantita_disponibile * parseFloat(item.prezzo_unitario);
        totalValue += itemValue;
        
        const soldQty = item.quantita_totale - item.quantita_disponibile;
        soldValue += soldQty * parseFloat(item.prezzo_unitario);
    });
    
    // Aggiorna UI
document.getElementById('totalItems').textContent = totalItems;
document.getElementById('availableItems').textContent = availableItems;
document.getElementById('totalValue').textContent = `‚Ç¨${totalValue.toFixed(2)}`;  // ‚Üê 2 decimali
document.getElementById('soldValue').textContent = `‚Ç¨${soldValue.toFixed(2)}`;    // ‚Üê 2 decimali
}   
// üîß FUNZIONE CORRETTA PER AGGIORNARE CONTATORI CATEGORIE
function updateCategoryCounters() {
    // Resetta tutti i contatori
    Object.keys(categories).forEach(categoryId => {
        if (categories[categoryId]) {
            categories[categoryId].count = 0;
            categories[categoryId].value = 0;
        }
    });
    
    // üìä USA I DATI DALL'API INVECE CHE DAL DOM
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            // Conta tutti gli oggetti (da vendere + uso interno)
            const allItems = [...(result.data.daVendere || []), ...(result.data.usoInterno || [])];
            
            console.log('üîç Oggetti trovati per conteggio:', allItems.length);
            
            // Conta per ogni categoria
            allItems.forEach(item => {
                const itemCategory = item.categoria_prodotto || 'generale'; // ‚Üê GIUSTO
                const itemValue = (item.quantita_disponibile || 0) * (item.prezzo_unitario || 0);
                
                console.log(`üì¶ Oggetto: ${item.descrizione} - Categoria: ${itemCategory} - Valore: ‚Ç¨${itemValue.toFixed(2)}`);
                
                // Aggiungi a categoria specifica
                if (categories[itemCategory]) {
                    categories[itemCategory].count++;
                    categories[itemCategory].value += itemValue;
                }
                
                // Aggiungi sempre a "all"
                if (categories['all']) {
                    categories['all'].count++;
                    categories['all'].value += itemValue;
                }
            });
            
            console.log('üìä Contatori aggiornati:', categories);
            
            // Aggiorna UI con i nuovi contatori
            updateCategoriesUI();
        }
    }).catch(error => {
        console.error('‚ùå Errore aggiornamento contatori:', error);
    });
}
  // üîç FUNZIONE DEBUG PER VEDERE COSA STA SUCCEDENDO
function debugCategories() {
    console.log('üîç === DEBUG CATEGORIE ===');
    
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            console.log('üì¶ Dati inventario ricevuti:', result.data);
            
            const allItems = [...(result.data.daVendere || []), ...(result.data.usoInterno || [])];
            console.log(`üìä Totale oggetti: ${allItems.length}`);
            
            allItems.forEach((item, index) => {
                console.log(`${index + 1}. Nome: "${item.descrizione}" | Categoria: "${item.categoria}" | Disponibili: ${item.quantita_disponibile} | Prezzo: ‚Ç¨${item.prezzo_unitario}`);
            });
            
            console.log('üè∑Ô∏è Categorie disponibili:', Object.keys(categories));
        } else {
            console.error('‚ùå Errore caricamento inventario:', result.message);
        }
    });
}

// Chiama questa funzione dalla console del browser per fare debug
// debugCategories(); 
     // üöÄ PASSO 1: AGGIUNGI QUESTE FUNZIONI ALLA FINE DEL TUO JAVASCRIPT

// FUNZIONE PRINCIPALE PER APRIRE MODAL VENDITA
function sellItem(itemId, itemName, availableQty, unitPrice) {
    if (availableQty <= 0) {
        showMessage('‚ùå Oggetto esaurito!', 'error');
        return;
    }
    
    const modalHtml = `
        <div id="sellModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 500px; width: 100%; border: 3px solid #FFD700; max-height: 90vh; overflow-y: auto;">
                <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 1.4em;">üìà Vendi Oggetto</h3>
                
                <!-- INFO OGGETTO -->
                <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #FFD700;">
                    <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">üé¥ Prodotto Selezionato:</div>
                    <div style="color: #fff; font-size: 1.1em; margin-bottom: 8px;">"${itemName}"</div>
                    <div style="color: #ccc; font-size: 0.9em;">
                        üì¶ Disponibili: <strong>${availableQty}</strong> pezzi<br>
                        üí∞ Prezzo acquisto: <strong>‚Ç¨${parseFloat(unitPrice).toFixed(2)}</strong> cadauno
                    </div>
                </div>
                
                <!-- FORM VENDITA -->
                <form id="quickSellForm">
                    <input type="hidden" name="item_id" value="${itemId}">
                    
                    <div style="margin-bottom: 15px;">
                        <label style="color: #FFD700; display: block; margin-bottom: 8px; font-weight: bold;">üì¶ Quantit√† da vendere:</label>
                        <input type="number" name="quantita_vendita" min="1" max="${availableQty}" value="1" required 
                               style="width: 100%; padding: 12px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff; font-size: 16px;"
                               onchange="updateQuickSalePreview('${itemId}', ${unitPrice})">
                    </div>
                    
                    <!-- SISTEMA PREZZO DOPPIO VENDITE -->
                    <div style="background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(139,0,0,0.15)); border: 2px solid #FFD700; border-radius: 15px; padding: 20px; margin: 20px 0; position: relative;">
                        <div style="position: absolute; top: -10px; right: 20px; background: #FFD700; color: #000; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold;">üîÑ SYNC</div>
                        <div style="color: #FFD700; font-weight: bold; font-size: 1.1em; margin-bottom: 15px; text-align: center;">üí∞ Prezzo di Vendita</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="position: relative;">
                                <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">üíµ Ricavo TOTALE</label>
                                <input type="number" id="quickSalePriceTotal" name="prezzo_totale_vendita" step="0.01" placeholder="0.00"
                                       style="padding-right: 45px; font-size: 18px; font-weight: bold; background: rgba(0,0,0,0.9); color: #fff; border: 2px solid #8B0000; border-radius: 8px; width: 100%; padding: 12px;"
                                       onchange="calculateQuickSaleFromTotal('${itemId}', ${unitPrice})" oninput="calculateQuickSaleFromTotal('${itemId}', ${unitPrice})">
                                <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #FFD700; font-weight: bold; pointer-events: none; margin-top: 12px;">‚Ç¨</span>
                            </div>
                            <div style="position: relative;">
                                <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">üíé Prezzo SINGOLO</label>
                                <input type="number" id="quickSalePriceSingle" step="0.01" placeholder="0.00"
                                       style="padding-right: 45px; font-size: 18px; font-weight: bold; background: rgba(0,0,0,0.9); color: #fff; border: 2px solid #8B0000; border-radius: 8px; width: 100%; padding: 12px;"
                                       onchange="calculateQuickSaleFromSingle('${itemId}', ${unitPrice})" oninput="calculateQuickSaleFromSingle('${itemId}', ${unitPrice})">
                                <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #FFD700; font-weight: bold; pointer-events: none; margin-top: 12px;">‚Ç¨</span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.6); border-radius: 10px; padding: 15px; text-align: center; border: 1px solid rgba(255,215,0,0.3);">
                            <div style="font-size: 1.1em; color: #90EE90; font-weight: bold; line-height: 1.4;" id="quickSalePreview">Inserisci quantit√† e prezzo</div>
                            <div style="font-size: 0.9em; color: #ccc; margin-top: 5px;" id="quickSaleDetail"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="color: #FFD700; display: block; margin-bottom: 8px; font-weight: bold;">üë§ Venduto a:</label>
                        <input type="text" name="venduto_a" placeholder="Cliente, eBay, Vinted..." required 
                               style="width: 100%; padding: 12px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #FFD700; display: block; margin-bottom: 8px; font-weight: bold;">üìÖ Data vendita:</label>
                        <input type="date" name="data_vendita" value="${new Date().toISOString().split('T')[0]}" required 
                               style="width: 100%; padding: 12px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff; font-size: 16px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #006400, #32CD32); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">üí∞ Conferma Vendita</button>
                        <button type="button" onclick="closeSellModal()" style="flex: 1; padding: 15px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">‚ùå Annulla</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Aggiungi event listener al form
    document.getElementById('quickSellForm').addEventListener('submit', handleQuickSell);
}

// CALCOLI PREZZO NEL MODAL
let isCalculatingQuickSale = false;

function calculateQuickSaleFromTotal(itemId, costPrice) {
    if (isCalculatingQuickSale) return;
    isCalculatingQuickSale = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
    const totalPrice = parseFloat(document.getElementById('quickSalePriceTotal').value) || 0;
    
    if (quantity > 0 && totalPrice > 0) {
        const singlePrice = totalPrice / quantity;
        document.getElementById('quickSalePriceSingle').value = singlePrice.toFixed(2);
        updateQuickSalePreviewCalc(quantity, totalPrice, singlePrice, costPrice);
    } else {
        clearQuickSalePreview();
    }
    
    isCalculatingQuickSale = false;
}

function calculateQuickSaleFromSingle(itemId, costPrice) {
    if (isCalculatingQuickSale) return;
    isCalculatingQuickSale = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
    const singlePrice = parseFloat(document.getElementById('quickSalePriceSingle').value) || 0;
    
    if (quantity > 0 && singlePrice > 0) {
        const totalPrice = Math.round((quantity * singlePrice) * 100) / 100;
        document.getElementById('quickSalePriceTotal').value = totalPrice.toFixed(2);
        updateQuickSalePreviewCalc(quantity, totalPrice, singlePrice, costPrice);
    } else {
        clearQuickSalePreview();
    }
    
    isCalculatingQuickSale = false;
}

function updateQuickSalePreview(itemId, costPrice) {
    const totalPrice = parseFloat(document.getElementById('quickSalePriceTotal').value) || 0;
    if (totalPrice > 0) {
        calculateQuickSaleFromTotal(itemId, costPrice);
    } else {
        const singlePrice = parseFloat(document.getElementById('quickSalePriceSingle').value) || 0;
        if (singlePrice > 0) {
            calculateQuickSaleFromSingle(itemId, costPrice);
        } else {
            clearQuickSalePreview();
        }
    }
}

function updateQuickSalePreviewCalc(quantity, totalSalePrice, singleSalePrice, costPrice) {
    const totalCost = quantity * costPrice;
    const totalProfit = totalSalePrice - totalCost;
    const profitPercentage = totalCost > 0 ? ((totalProfit / totalCost) * 100).toFixed(1) : 0;
    
    const profitColor = totalProfit >= 0 ? '#90EE90' : '#FFB6C1';
    const profitSign = totalProfit >= 0 ? '+' : '';
    
    document.getElementById('quickSalePreview').innerHTML = 
        `üìà <strong>${quantity}x</strong> a <strong>‚Ç¨${singleSalePrice.toFixed(2)}</strong> = <strong>‚Ç¨${totalSalePrice.toFixed(2)}</strong> ricavo`;
    
    document.getElementById('quickSaleDetail').innerHTML = 
        `üí∞ Costo: ‚Ç¨${totalCost.toFixed(2)} ‚Ä¢ ` +
        `<span style="color: ${profitColor}">Profitto: <strong>${profitSign}‚Ç¨${totalProfit.toFixed(2)}</strong> (${profitSign}${profitPercentage}%)</span><br>` +
        `üíé Profitto per socio: ‚Ç¨${(totalProfit / 3).toFixed(2)} cadauno`;
}

// GESTIONE SUBMIT VENDITA RAPIDA
async function handleQuickSell(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    
    showMessage('‚è≥ Registrando vendita...', 'success');
    
    try {
        const result = await apiCall('addSale', data);
        
        if (result.success) {
            showMessage(result.message, 'success');
            closeSellModal();
            invalidateInventoryCache();
            loadInventory(); // Ricarica inventario aggiornato
        } else {
            showMessage('‚ùå ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('‚ùå Errore: ' + error.message, 'error');
    }
}
function clearQuickSalePreview() {
    document.getElementById('quickSalePreview').innerHTML = 'Inserisci quantit√† e prezzo';
    document.getElementById('quickSaleDetail').innerHTML = '';
}
// CHIUDI MODAL VENDITA
function closeSellModal() {
    const modal = document.getElementById('sellModal');
    if (modal) modal.remove();
}   
</script>
</body>
</html>
