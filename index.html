<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3 LEGENDARY - Mobile System</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B0000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #2d1810 50%, #8B0000 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: rgba(0,0,0,0.95);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            padding: 20px 15px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(255,255,255,0.1) 8px,
                rgba(255,255,255,0.1) 16px
            );
            pointer-events: none;
        }
        
        .logo-container {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-3legendary {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #FFD700;
            box-shadow: 0 0 25px rgba(255,215,0,0.6);
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><radialGradient id="sun" cx="50%" cy="35%"><stop offset="0%" stop-color="%23FF6B6B"/><stop offset="70%" stop-color="%23DC143C"/><stop offset="100%" stop-color="%238B0000"/></radialGradient><filter id="shadow"><feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/></filter></defs><circle cx="200" cy="140" r="90" fill="url(%23sun)" stroke="%23FFD700" stroke-width="2"/><g filter="url(%23shadow)"><path d="M80,180 Q60,160 40,180 Q50,200 70,220 Q90,240 120,235 Q140,230 150,210 Q160,190 145,170 Q130,155 115,165 Q100,175 90,185 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M70,175 Q80,165 90,175 Q95,185 85,195 Q75,205 65,195 Z" fill="%23FF0000"/><path d="M110,185 L130,175 L140,190 L125,200 Z" fill="%23000000"/></g><g filter="url(%23shadow)"><path d="M280,190 Q260,170 240,190 Q250,210 270,230 Q290,250 320,245 Q340,240 350,220 Q360,200 345,180 Q330,165 315,175 Q300,185 290,195 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M270,185 Q280,175 290,185 Q295,195 285,205 Q275,215 265,205 Z" fill="%23FF0000"/><path d="M310,195 L330,185 L340,200 L325,210 Z" fill="%23000000"/></g><rect x="80" y="320" width="240" height="45" rx="10" fill="%23000000" stroke="%23FFD700" stroke-width="3"/><text x="200" y="350" text-anchor="middle" fill="%23FF0000" font-size="32" font-weight="bold" font-family="Arial Black">3 LEGENDARY</text></svg>') center/cover;
        }
        
        .header h1 {
            font-size: 1.8em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            position: relative;
            z-index: 2;
            margin: 0;
        }
        
        .legend-text {
            background: linear-gradient(45deg, #FF0000, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            position: relative;
            z-index: 2;
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            background: rgba(139,0,0,0.4);
            border-bottom: 3px solid #8B0000;
        }
        
        .tab {
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,0,0,0.4);
            border-right: 1px solid #8B0000;
            border-bottom: 1px solid #8B0000;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9em;
            position: relative;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab:nth-child(2n) {
            border-right: none;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: #fff;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(255,0,0,0.4);
        }
        
        .tab:hover:not(.active) {
            background: rgba(139,0,0,0.6);
            transform: scale(1.01);
        }
        
        .content {
            padding: 20px 15px;
            padding-bottom: 80px;
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .section {
            background: rgba(139,0,0,0.15);
            border-radius: 20px;
            padding: 25px 20px;
            margin: 15px 0;
            border: 2px solid #8B0000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 1em;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 3px solid #8B0000;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #FF0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.4);
            transform: scale(1.02);
        }
        
        .btn {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-top: 25px;
            transition: all 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 6px 20px rgba(139,0,0,0.4);
            min-height: 60px;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255,0,0,0.5);
            background: linear-gradient(135deg, #A0001A, #FF1A1A);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-small {
            width: auto;
            padding: 12px 20px;
            font-size: 14px;
            margin: 8px 5px;
            min-height: auto;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .inventory-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #8B0000;
        }
        
        .inventory-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: rgba(139,0,0,0.3);
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .inventory-tab.active {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: #fff;
        }
        
        .inventory-content {
            display: none;
        }
        
        .inventory-content.active {
            display: block;
        }
        
        .item-card {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 5px solid #FFD700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #FFD700;
            flex: 1;
        }
        
        .item-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .status-disponibile {
            background: #006400;
            color: #90EE90;
        }
        
        .status-venduto {
            background: #FFD700;
            color: #000;
        }
        
        .status-esaurito {
            background: #8B0000;
            color: #FFB6C1;
        }
        
        .status-uso {
            background: #666;
            color: #fff;
        }
        
        .quantity-info {
            background: rgba(255,215,0,0.15);
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
        }
        
        .item-details {
            font-size: 0.9em;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .profit-positive {
            color: #90EE90;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #FFB6C1;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #8B0000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .info-box {
            background: rgba(255,215,0,0.15);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 18px;
            margin: 20px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .info-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .calc-preview {
            background: rgba(255,215,0,0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .message {
            padding: 18px;
            margin: 20px 0;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
        }
        
        .success {
            background: rgba(0,100,0,0.3);
            border: 2px solid #006400;
            color: #90EE90;
        }
        
        .error {
            background: rgba(139,0,0,0.3);
            border: 2px solid #8B0000;
            color: #FFB6C1;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #FFD700;
            font-weight: bold;
            padding: 30px;
            font-size: 1.1em;
        }
        
        .floating-add {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FF0000, #FFD700);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #000;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(255,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .floating-add:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,0,0,0.6);
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
            border-left: 4px solid #8B0000;
        }
        
        .balance-name {
            font-weight: bold;
            font-size: 1em;
        }
        
        .balance-amount {
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .positive {
            background: #006400;
            color: #90EE90;
        }
        
        .negative {
            background: #8B0000;
            color: #FFB6C1;
        }
        
        .neutral {
            background: #666;
            color: #fff;
        }
        
        .cash-movement {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
        }
        
        .movement-in {
            border-left: 4px solid #006400;
        }
        
        .movement-out {
            border-left: 4px solid #8B0000;
        }
        
        /* RESPONSIVE MOBILE OPTIMIZATIONS */
        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }
            
            .logo-3legendary {
                width: 60px;
                height: 60px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .tabs {
                grid-template-columns: 1fr 1fr;
            }
            
            .tab {
                padding: 15px 8px;
                font-size: 0.8em;
                min-height: 55px;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .section {
                padding: 20px 15px;
                margin: 10px 0;
            }
            
            .two-column, .three-column {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .item-name {
                font-size: 1em;
            }
            
            .floating-add {
                bottom: 15px;
                right: 15px;
                width: 55px;
                height: 55px;
                font-size: 28px;
            }
        }
        
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.4em;
            }
            
            .tab {
                font-size: 0.75em;
                padding: 12px 6px;
            }
            
            .content {
                padding: 12px 8px;
            }
            
            .section {
                padding: 18px 12px;
            }
            
            .form-group input, .form-group select {
                padding: 14px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        /* 🎨 AGGIUNGI QUESTI STILI AL TUO CSS ESISTENTE */

/* SISTEMA PREZZO DOPPIO */
.dual-price-container {
    background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(139,0,0,0.15));
    border: 2px solid #FFD700;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
}

.dual-price-header {
    color: #FFD700;
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 15px;
    text-align: center;
}

.price-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.price-field {
    position: relative;
}

.price-field input {
    padding-right: 45px;
    font-size: 18px;
    font-weight: bold;
    background: rgba(0,0,0,0.9);
}

.currency {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #FFD700;
    font-weight: bold;
    pointer-events: none;
}

.price-preview {
    background: rgba(0,0,0,0.6);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(255,215,0,0.3);
}

.preview-text {
    font-size: 1.1em;
    color: #90EE90;
    font-weight: bold;
    line-height: 1.4;
}

.preview-detail {
    font-size: 0.9em;
    color: #ccc;
    margin-top: 5px;
}

.sync-indicator {
    position: absolute;
    top: -10px;
    right: 20px;
    background: #FFD700;
    color: #000;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
}

/* GESTIONE CATEGORIE INVENTARIO */
.categories-section {
    background: rgba(139,0,0,0.4);
    padding: 20px;
    border-bottom: 2px solid #8B0000;
    border-radius: 15px 15px 0 0;
    margin-bottom: 0;
}

.categories-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.categories-title {
    color: #FFD700;
    font-size: 1.2em;
    font-weight: bold;
}

.add-category-btn {
    background: linear-gradient(135deg, #006400, #32CD32);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9em;
}

.add-category-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(50,205,50,0.4);
}

.categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 15px;
}

.category-card {
    background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(255,215,0,0.1));
    border: 2px solid #FFD700;
    border-radius: 12px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
    text-align: center;
}

.category-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(255,215,0,0.4);
    border-color: #FFA500;
}

.category-card.active {
    background: linear-gradient(135deg, #8B0000, #FF0000);
    border-color: #FF0000;
    transform: scale(1.02);
}

.category-icon {
    font-size: 1.8em;
    margin-bottom: 8px;
    display: block;
}

.category-name {
    font-weight: bold;
    color: #FFD700;
    margin-bottom: 4px;
    font-size: 0.9em;
}

.category-count {
    font-size: 0.8em;
    color: #ccc;
    margin-bottom: 6px;
}

.category-value {
    font-size: 0.75em;
    color: #90EE90;
    font-weight: bold;
}

.category-actions {
    position: absolute;
    top: 6px;
    right: 6px;
    display: flex;
    gap: 3px;
    opacity: 0;
    transition: opacity 0.3s;
}

.category-card:hover .category-actions {
    opacity: 1;
}

.category-action-btn {
    background: rgba(0,0,0,0.8);
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.7em;
}

.category-action-btn:hover {
    transform: scale(1.1);
}

.btn-edit-category {
    color: #FFA500;
}

.btn-delete-category {
    color: #FF4444;
}

/* INVENTARIO MIGLIORATO */
.inventory-controls {
    background: rgba(0,0,0,0.3);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.search-section {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
}

.search-input {
    padding: 12px 15px;
    border: 2px solid #8B0000;
    border-radius: 10px;
    background: rgba(0,0,0,0.8);
    color: #fff;
    font-size: 16px;
    font-weight: 500;
}

.search-input:focus {
    outline: none;
    border-color: #FF0000;
    box-shadow: 0 0 15px rgba(255,0,0,0.4);
}

.filter-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 15px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.8em;
}

.filter-btn.active {
    background: linear-gradient(135deg, #8B0000, #FF0000);
    color: white;
    transform: scale(1.05);
}

.filter-btn:not(.active) {
    background: rgba(255,255,255,0.2);
    color: #fff;
}

.filter-btn:hover:not(.active) {
    background: rgba(255,255,255,0.3);
    transform: scale(1.02);
}

.inventory-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.stat-box {
    background: rgba(0,0,0,0.6);
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #FFD700;
    text-align: center;
}

.stat-number {
    font-size: 1.4em;
    color: #FFD700;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.8em;
    opacity: 0.9;
    margin-top: 4px;
}

.item-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.info-card {
    background: rgba(255,215,0,0.1);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #FFD700;
}

.info-label {
    color: #FFD700;
    font-weight: bold;
    font-size: 0.8em;
    margin-bottom: 4px;
}

.info-value {
    color: #fff;
    font-size: 0.95em;
    font-weight: bold;
}

.movements-section {
    margin-top: 15px;
    background: rgba(0,0,0,0.5);
    border-radius: 10px;
    overflow: hidden;
}

.movements-header {
    background: rgba(255,215,0,0.2);
    padding: 8px 12px;
    border-bottom: 1px solid #FFD700;
}

.movements-title {
    color: #FFD700;
    font-weight: bold;
    font-size: 0.85em;
}

.movement-item {
    padding: 8px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8em;
}

.movement-item:last-child {
    border-bottom: none;
}

.movement-in {
    border-left: 3px solid #006400;
}

.movement-out {
    border-left: 3px solid #8B0000;
}

.movement-date {
    color: #ccc;
    font-size: 0.75em;
}

.movement-amount {
    font-weight: bold;
}

.amount-positive {
    color: #90EE90;
}

.amount-negative {
    color: #FFB6C1;
}

.action-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.8em;
    flex: 1;
    min-width: 100px;
}

.btn-edit {
    background: linear-gradient(135deg, #FFA500, #FF8C00);
    color: white;
}

.btn-delete {
    background: linear-gradient(135deg, #8B0000, #DC143C);
    color: white;
}

.btn-sell {
    background: linear-gradient(135deg, #006400, #32CD32);
    color: white;
}

.btn-unify {
    background: linear-gradient(135deg, #4169E1, #6495ED);
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* RESPONSIVE */
@media (max-width: 600px) {
    .price-fields {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .categories-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .item-info-grid {
        grid-template-columns: 1fr;
    }
    
    .search-section {
        grid-template-columns: 1fr;
    }
}
        /* PWA STYLES */
        @media (display-mode: standalone) {
            .container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* DARK MODE SUPPORT */
        @media (prefers-color-scheme: dark) {
            .form-group input, .form-group select {
                background: rgba(0,0,0,0.9);
            }
        }
        /* 🔧 NUOVO LAYOUT BILANCIO MIGLIORATO - AGGIUNGI ALLA FINE DEL CSS */
.balance-item-new {
    background: rgba(0,0,0,0.8);
    margin: 15px 0;
    border-radius: 15px;
    border: 2px solid #8B0000;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.balance-header {
    background: linear-gradient(135deg, #8B0000, #FF0000);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.balance-name-new {
    font-size: 1.2em;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
}

.balance-status {
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
    text-align: center;
    min-width: 100px;
}

.status-positive {
    background: #006400;
    color: #90EE90;
}

.status-negative {
    background: #8B0000;
    color: #FFB6C1;
}

.status-neutral {
    background: #FFD700;
    color: #000;
}

.balance-details {
    padding: 15px 20px;
    background: rgba(255,255,255,0.05);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.detail-label {
    color: #FFD700;
    font-weight: bold;
}

.detail-value {
    color: #fff;
    font-weight: normal;
}

.divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #FFD700, transparent);
    margin: 10px 0;
}

/* 📱 RESPONSIVE OTTIMIZZATO PER MOBILE */
@media (max-width: 480px) {
    .balance-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .balance-status {
        min-width: auto;
        width: 100%;
    }
    
    .detail-row {
        font-size: 0.85em;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-3legendary"></div>
                <h1>3 <span class="legend-text">LEGENDARY</span></h1>
            </div>
            <div class="subtitle">Sistema Mobile Pokémon</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('expenses')">💰 Spese</div>
            <div class="tab" onclick="showTab('inventory')">📦 Inventario</div>
            <div class="tab" onclick="showTab('sales')">📈 Vendite</div>
            <div class="tab" onclick="showTab('reports')">📊 Report</div>
            <div class="tab" onclick="showTab('cash')">🏦 Cassa</div>
            <div class="tab" onclick="showTab('balance')">⚖️ Bilancio</div>
        </div>
        
        <div class="content">
            <!-- 1. SPESE -->
            <div id="expenses" class="form-section active">
                <div class="section">
                    <h2>💰 Nuova Spesa</h2>
                    
                    <div class="info-box">
                        <div class="info-title">📱 Mobile Quick:</div>
                        <p>Inserisci <strong>prezzo totale</strong> e <strong>quantità</strong> - il sistema calcola tutto automaticamente!</p>
                    </div>
                    
                    <form id="expenseForm">
                        <div class="form-group">
                            <label>👤 Chi ha pagato:</label>
                            <select name="socio" required>
                                <option value="">Scegli...</option>
                                <option value="Portafoglio Condiviso">💰 Cassa Comune</option>
                                <option value="Ciano">🎮 Ciano</option>
                                <option value="Alex">🔥 Alex</option>
                                <option value="King">👑 King</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>📝 Cosa hai comprato:</label>
                            <input type="text" name="descrizione" placeholder="Es: Booster Darkness Ablaze" required>
                        </div>
                        
                        <div class="form-group">
    <label>📦 Quantità:</label>
    <input type="number" name="quantita" min="1" value="1" required onchange="calculateExpensePrice()">
</div>

<!-- SISTEMA PREZZO DOPPIO -->
<div class="dual-price-container">
    <div class="sync-indicator">🔄 SYNC</div>
    <div class="dual-price-header">💰 Sistema Prezzo Intelligente</div>
    
    <div class="price-fields">
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">💵 Prezzo TOTALE</label>
            <input type="number" id="expensePriceTotal" name="prezzo_totale" step="0.01" placeholder="0.00" onchange="calculateExpenseFromTotal()" oninput="calculateExpenseFromTotal()">
            <span class="currency">€</span>
        </div>
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">💎 Prezzo SINGOLO</label>
            <input type="number" id="expensePriceSingle" step="0.01" placeholder="0.00" onchange="calculateExpenseFromSingle()" oninput="calculateExpenseFromSingle()">
            <span class="currency">€</span>
        </div>
    </div>
    
    <div class="price-preview">
        <div class="preview-text" id="expensePreview">Inserisci quantità e prezzo per vedere l'anteprima</div>
        <div class="preview-detail" id="expenseDetail"></div>
    </div>
</div>
                        
                        <div class="form-group">
                            <label>🏪 Dove:</label>
                            <input type="text" name="dove" placeholder="eBay, Amazon, Negozio..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>🏷️ Tipo:</label>
                            <select name="categoria" required>
                                <option value="">Seleziona...</option>
                                <option value="Da Vendere">💰 Da Vendere</option>
                                <option value="Uso Interno">🔧 Uso Interno</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>📅 Data:</label>
                            <input type="date" name="data" required>
                        </div>
                        
                        <div id="pricePreview" class="calc-preview" style="display: none;">
                            <strong>💡 Calcolo:</strong><br>
                            <span id="priceCalc"></span>
                        </div>
                        
                        <button type="submit" class="btn">💾 Salva Spesa</button>
                    </form>
                </div>
            </div>
            
            <!-- 2. INVENTARIO -->
            <div id="inventory" class="form-section">
                <div class="section">
                    <h2>📦 Inventario</h2>
                    <!-- GESTIONE CATEGORIE -->
<div class="categories-section">
    <div class="categories-header">
        <div class="categories-title">📁 Categorie Prodotti</div>
        <button class="add-category-btn" onclick="showAddCategoryModal()">➕ Nuova Categoria</button>
    </div>
    
    <div class="categories-grid">
        <div class="category-card active" onclick="selectCategory('all')">
            <div class="category-icon">🌟</div>
            <div class="category-name">Tutti i Prodotti</div>
            <div class="category-count">-- articoli</div>
            <div class="category-value">€-- totale</div>
        </div>
        
        <div class="category-card" onclick="selectCategory('booster-packs')">
            <div class="category-icon">🎴</div>
            <div class="category-name">Booster Packs</div>
            <div class="category-count">-- articoli</div>
            <div class="category-value">€-- totale</div>
            <div class="category-actions">
                <button class="category-action-btn btn-edit-category" onclick="editCategory('booster-packs', event)">✏️</button>
                <button class="category-action-btn btn-delete-category" onclick="deleteCategory('booster-packs', event)">🗑️</button>
            </div>
        </div>
        
        <div class="category-card" onclick="selectCategory('etb')">
            <div class="category-icon">📦</div>
            <div class="category-name">Elite Trainer Box</div>
            <div class="category-count">-- articoli</div>
            <div class="category-value">€-- totale</div>
            <div class="category-actions">
                <button class="category-action-btn btn-edit-category" onclick="editCategory('etb', event)">✏️</button>
                <button class="category-action-btn btn-delete-category" onclick="deleteCategory('etb', event)">🗑️</button>
            </div>
        </div>
    </div>
    
    <!-- BREADCRUMB NAVIGAZIONE -->
    <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 8px; font-size: 0.9em;">
        <span style="color: #FFD700;">📍 Visualizzando:</span>
        <span id="currentCategoryBreadcrumb" style="color: #fff; font-weight: bold; margin-left: 10px;">🌟 Tutti i Prodotti</span>
    </div>
</div>

<!-- CONTROLLI INVENTARIO -->
<div class="inventory-controls">
    <div class="search-section">
        <input type="text" class="search-input" placeholder="🔍 Cerca prodotti, codici..." onkeyup="searchInventory(this.value)">
        <button class="filter-btn active" onclick="refreshInventory()">🔄 Aggiorna</button>
    </div>
    <div class="filter-buttons">
        <button class="filter-btn active" onclick="filterInventory('all')">🌟 Tutti</button>
        <button class="filter-btn" onclick="filterInventory('disponibili')">✅ Disponibili</button>
        <button class="filter-btn" onclick="filterInventory('esauriti')">❌ Esauriti</button>
    </div>
</div>

<!-- STATISTICHE INVENTARIO -->
<div class="inventory-stats">
    <div class="stat-box">
        <span class="stat-number" id="totalItems">--</span>
        <div class="stat-label">Articoli Totali</div>
    </div>
    <div class="stat-box">
        <span class="stat-number" id="availableItems">--</span>
        <div class="stat-label">Disponibili</div>
    </div>
    <div class="stat-box">
        <span class="stat-number" id="totalValue">€--</span>
        <div class="stat-label">Valore Magazzino</div>
    </div>
    <div class="stat-box">
        <span class="stat-number" id="soldValue">€--</span>
        <div class="stat-label">Venduto</div>
    </div>
</div>
                    <div class="inventory-tabs">
                        <div class="inventory-tab active" onclick="showInventoryTab('vendere')">💰 Da Vendere</div>
                        <div class="inventory-tab" onclick="showInventoryTab('interno')">🔧 Uso Interno</div>
                    </div>
                    
                    <div id="inventario-vendere" class="inventory-content active">
                        <div class="loading" id="inventoryLoading">⏳ Caricamento...</div>
                        <div id="inventoryVendereContent"></div>
                    </div>
                    
                    <div id="inventario-interno" class="inventory-content">
                        <div id="inventoryInternoContent"></div>
                    </div>
                    
                    <button class="btn" onclick="loadInventory()">🔄 Aggiorna</button>
                </div>
            </div>
            
            <!-- 3. VENDITE -->
            <div id="sales" class="form-section">
                <div class="section">
                    <h2>📈 Registra Vendita</h2>
                    
                    <div class="info-box">
                        <div class="info-title">💰 Profitti:</div>
                        <p>Il ricavato va in <strong>Cassa Comune</strong> e viene diviso per 3!</p>
                    </div>
                    
                    <form id="salesForm">
                        <div class="form-group">
                            <label>🎴 Cosa vendi:</label>
                            <select name="item_id" id="salesItemSelect" required onchange="updateSaleInfo()">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        
                        <div id="itemInfo" class="quantity-info" style="display: none;">
                            <span id="itemDetails"></span>
                        </div>
                        
                        <div class="form-group">
    <label>📦 Quantità da vendere:</label>
    <input type="number" name="quantita_vendita" min="1" required onchange="calculateSalePrice()">
</div>

<!-- SISTEMA PREZZO DOPPIO VENDITE -->
<div class="dual-price-container">
    <div class="sync-indicator">🔄 SYNC</div>
    <div class="dual-price-header">💰 Prezzo di Vendita</div>
    
    <div class="price-fields">
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">💵 Ricavo TOTALE</label>
            <input type="number" id="salePriceTotal" name="prezzo_totale_vendita" step="0.01" placeholder="0.00" onchange="calculateSaleFromTotal()" oninput="calculateSaleFromTotal()">
            <span class="currency">€</span>
        </div>
        <div class="price-field">
            <label style="color: #FFD700; margin-bottom: 8px; display: block; font-size: 0.9em;">💎 Prezzo SINGOLO</label>
            <input type="number" id="salePriceSingle" step="0.01" placeholder="0.00" onchange="calculateSaleFromSingle()" oninput="calculateSaleFromSingle()">
            <span class="currency">€</span>
        </div>
    </div>
    
    <div class="price-preview">
        <div class="preview-text" id="salePreview">Seleziona prodotto e inserisci quantità</div>
        <div class="preview-detail" id="saleDetail"></div>
    </div>
</div>
                        
                        <div class="form-group">
                            <label>👤 Venduto a:</label>
                            <input type="text" name="venduto_a" placeholder="Cliente, eBay, Vinted..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>📅 Data vendita:</label>
                            <input type="date" name="data_vendita" required>
                        </div>
                        
                        <div id="salePreview" class="calc-preview" style="display: none;">
                            <strong>💡 Profitto:</strong><br>
                            <span id="saleCalc"></span>
                        </div>
                        
                        <button type="submit" class="btn">💰 Registra Vendita</button>
                    </form>
                </div>
            </div>
            
            <!-- 4. REPORT -->
            <div id="reports" class="form-section">
                <div class="section">
                    <h2>📊 Report Vendite</h2>
                    
                    <div class="loading" id="reportsLoading">⏳ Caricamento...</div>
                    <div id="reportsContent"></div>
                    
                    <button class="btn" onclick="loadSalesReport()">🔄 Aggiorna</button>
                </div>
            </div>
            
            <!-- 5. CASSA -->
            <div id="cash" class="form-section">
                <div class="section">
                    <h2>🏦 Cassa Comune</h2>
                    <div class="loading" id="cashLoading">⏳ Caricamento...</div>
                    <div id="cashContent"></div>
                    
                    <div class="section" style="margin-top: 20px;">
                        <h3 style="color: #FFD700; margin-bottom: 15px; text-align: center;">💰 Aggiungi Denaro</h3>
                        <form id="addCashForm">
                            <div class="form-group">
                                <label>👤 Chi versa:</label>
                                <select name="socio" required>
                                    <option value="">Scegli...</option>
                                    <option value="Ciano">🎮 Ciano</option>
                                    <option value="Alex">🔥 Alex</option>
                                    <option value="King">👑 King</option>
                                    <option value="Tutti">👥 Tutti (diviso per 3)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>💶 Importo €:</label>
                                <input type="number" name="importo" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>📝 Motivo:</label>
                                <input type="text" name="motivo" placeholder="Versamento iniziale..." required>
                            </div>
                            <button type="submit" class="btn">💰 Aggiungi</button>
                        </form>
                    </div>
                    
                    <div id="profitDistribution"></div>
                    
                    <button class="btn" onclick="loadCashStatus()">🔄 Aggiorna Cassa</button>
                </div>
            </div>
            
            <!-- 6. BILANCIO -->
            <div id="balance" class="form-section">
                <div class="section">
                    <h2>⚖️ Bilancio Personale</h2>
                    
                    <div class="info-box">
                        <div class="info-title">🤔 Come funziona:</div>
                        <p><strong>Quota Teorica:</strong> Quanto dovrebbe aver speso ognuno se diviso equamente<br>
                        <strong>Nota:</strong> Spese da "Cassa Comune" NON influenzano questo bilancio</p>
                    </div>
                    <div class="section" style="margin-top: 20px;">
    <h3 style="color: #FFD700; margin-bottom: 15px; text-align: center;">💸 Registra Pagamento</h3>
    <form id="internalPaymentForm">
        <div class="two-column">
            <div class="form-group">
                <label>👤 Chi paga:</label>
                <select name="da_chi" required>
                    <option value="">Scegli...</option>
                    <option value="Ciano">🎮 Ciano</option>
                    <option value="Alex">🔥 Alex</option>
                    <option value="King">👑 King</option>
                </select>
            </div>
            <div class="form-group">
                <label>👤 Chi riceve:</label>
                <select name="a_chi" required>
                    <option value="">Scegli...</option>
                    <option value="Ciano">🎮 Ciano</option>
                    <option value="Alex">🔥 Alex</option>
                    <option value="King">👑 King</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>💶 Importo €:</label>
            <input type="number" name="importo" step="0.01" placeholder="0.00" required>
        </div>
        
        <div class="form-group">
            <label>📝 Motivo:</label>
            <input type="text" name="motivo" placeholder="Sistemazione bilancio..." required>
        </div>
        
        <button type="submit" class="btn">💸 Registra Pagamento</button>
    </form>
</div>
                    <div class="loading" id="balanceLoading">⏳ Caricamento...</div>
                    <div id="balanceContent"></div>
                    
                    <button class="btn" onclick="loadPersonalBalanceWithPayments()">🔄 Aggiorna</button>
                </div>
            </div>
            
            <!-- MESSAGGI -->
            <div id="message"></div>
        </div>
        
        <!-- FLOATING ACTION BUTTON -->
        <div class="floating-add" onclick="showTab('expenses')" title="Aggiungi Spesa Veloce">
            +
        </div>
    </div>

    <script>
// 🚀 CONFIGURAZIONE API
const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwc17XK8CD4q2wRkgMGYK2_jB4MpiHrf06eIF28RMYebUbDj_ozYQOt6-dhzJdAlvt-AQ/exec';

// STORAGE LOCALE
let localData = { expenses: [], sales: [], inventory: [] };

// FUNZIONE API SEMPLIFICATA
// ✅ NUOVA (funziona davvero)
async function apiCall(action, data = {}) {
    try {
        const params = new URLSearchParams({ action: action, ...data });
        const response = await fetch(`${API_BASE_URL}?${params}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('API Error:', error);
        return { 
            success: false, 
            message: 'Errore di connessione: ' + error.message 
        };
    }
}

// CARICA DATI
function loadLocalData() {
    const stored = localStorage.getItem('3legendary_mobile_data');
    if (stored) localData = JSON.parse(stored);
}

// INIZIALIZZAZIONE
document.addEventListener('DOMContentLoaded', function() {
    loadLocalData();
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => { if (!input.value) input.value = today; });
});
// ========== SISTEMA PREZZO DOPPIO SPESE ==========
let isCalculatingExpense = false;

function calculateExpenseFromTotal() {
    if (isCalculatingExpense) return;
    isCalculatingExpense = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita"]').value) || 0;
    const totalPrice = parseFloat(document.getElementById('expensePriceTotal').value) || 0;
    
    if (quantity > 0 && totalPrice > 0) {
        const singlePrice = totalPrice / quantity;
        document.getElementById('expensePriceSingle').value = singlePrice.toFixed(2);
        updateExpensePreview(quantity, totalPrice, singlePrice);
    } else {
        clearExpensePreview();
    }
    
    isCalculatingExpense = false;
}

function calculateExpenseFromSingle() {
    if (isCalculatingExpense) return;
    isCalculatingExpense = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita"]').value) || 0;
    const singlePrice = parseFloat(document.getElementById('expensePriceSingle').value) || 0;
    
    if (quantity > 0 && singlePrice > 0) {
        const totalPrice = quantity * singlePrice;
        document.getElementById('expensePriceTotal').value = totalPrice.toFixed(2);
        updateExpensePreview(quantity, totalPrice, singlePrice);
    } else {
        clearExpensePreview();
    }
    
    isCalculatingExpense = false;
}

function calculateExpensePrice() {
    // Ricalcola quando cambia la quantità
    const totalPrice = parseFloat(document.getElementById('expensePriceTotal').value) || 0;
    if (totalPrice > 0) {
        calculateExpenseFromTotal();
    } else {
        const singlePrice = parseFloat(document.getElementById('expensePriceSingle').value) || 0;
        if (singlePrice > 0) {
            calculateExpenseFromSingle();
        }
    }
}

function updateExpensePreview(quantity, totalPrice, singlePrice) {
    document.getElementById('expensePreview').innerHTML = 
        `💰 <strong>${quantity}x</strong> a <strong>€${singlePrice.toFixed(2)}</strong> cadauno = <strong>€${totalPrice.toFixed(2)}</strong> totale`;
    document.getElementById('expenseDetail').innerHTML = 
        `💡 Investimento: €${totalPrice.toFixed(2)} • Costo unitario: €${singlePrice.toFixed(2)}`;
}

function clearExpensePreview() {
    document.getElementById('expensePreview').innerHTML = 'Inserisci quantità e prezzo per vedere l\'anteprima';
    document.getElementById('expenseDetail').innerHTML = '';
}

// ========== SISTEMA PREZZO DOPPIO VENDITE ==========
let isCalculatingSale = false;
let currentItemPrice = 0;

function calculateSaleFromTotal() {
    if (isCalculatingSale) return;
    isCalculatingSale = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
    const totalPrice = parseFloat(document.getElementById('salePriceTotal').value) || 0;
    
    if (quantity > 0 && totalPrice > 0) {
        const singlePrice = totalPrice / quantity;
        document.getElementById('salePriceSingle').value = singlePrice.toFixed(2);
        updateSalePreview(quantity, totalPrice, singlePrice);
    } else {
        clearSalePreview();
    }
    
    isCalculatingSale = false;
}

function calculateSaleFromSingle() {
    if (isCalculatingSale) return;
    isCalculatingSale = true;
    
    const quantity = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
    const singlePrice = parseFloat(document.getElementById('salePriceSingle').value) || 0;
    
    if (quantity > 0 && singlePrice > 0) {
        const totalPrice = quantity * singlePrice;
        document.getElementById('salePriceTotal').value = totalPrice.toFixed(2);
        updateSalePreview(quantity, totalPrice, singlePrice);
    } else {
        clearSalePreview();
    }
    
    isCalculatingSale = false;
}

function calculateSalePrice() {
    // Ricalcola quando cambia la quantità
    const totalPrice = parseFloat(document.getElementById('salePriceTotal').value) || 0;
    if (totalPrice > 0) {
        calculateSaleFromTotal();
    } else {
        const singlePrice = parseFloat(document.getElementById('salePriceSingle').value) || 0;
        if (singlePrice > 0) {
            calculateSaleFromSingle();
        }
    }
}

function updateSalePreview(quantity, totalSalePrice, singleSalePrice) {
    if (currentItemPrice > 0) {
        const totalCost = quantity * currentItemPrice;
        const totalProfit = totalSalePrice - totalCost;
        const profitPercentage = totalCost > 0 ? ((totalProfit / totalCost) * 100).toFixed(1) : 0;
        
        const profitColor = totalProfit >= 0 ? '#90EE90' : '#FFB6C1';
        const profitSign = totalProfit >= 0 ? '+' : '';
        
        document.getElementById('salePreview').innerHTML = 
            `📈 <strong>${quantity}x</strong> a <strong>€${singleSalePrice.toFixed(2)}</strong> = <strong>€${totalSalePrice.toFixed(2)}</strong> ricavo`;
        
        document.getElementById('saleDetail').innerHTML = 
            `💰 Costo: €${totalCost.toFixed(2)} • ` +
            `<span style="color: ${profitColor}">Profitto: <strong>${profitSign}€${totalProfit.toFixed(2)}</strong> (${profitSign}${profitPercentage}%)</span><br>` +
            `💎 Profitto per socio: €${(totalProfit / 3).toFixed(2)} cadauno`;
    } else {
        document.getElementById('salePreview').innerHTML = 
            `📈 <strong>${quantity}x</strong> a <strong>€${singleSalePrice.toFixed(2)}</strong> = <strong>€${totalSalePrice.toFixed(2)}</strong> ricavo`;
        document.getElementById('saleDetail').innerHTML = 
            `⚠️ Seleziona un prodotto per calcolare il profitto`;
    }
}

function clearSalePreview() {
    document.getElementById('salePreview').innerHTML = 'Seleziona prodotto e inserisci quantità';
    document.getElementById('saleDetail').innerHTML = '';
}

// ========== GESTIONE CATEGORIE ==========
let currentCategory = 'all';
let categories = {
    'all': { name: 'Tutti i Prodotti', icon: '🌟', count: 0, value: 0 },
    'booster-packs': { name: 'Booster Packs', icon: '🎴', count: 0, value: 0 },
    'etb': { name: 'Elite Trainer Box', icon: '📦', count: 0, value: 0 }
};

function selectCategory(categoryId) {
    currentCategory = categoryId;
    
    // Aggiorna UI
    document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('active');
    });
    
    const selectedCard = document.querySelector(`[onclick="selectCategory('${categoryId}')"]`);
    if (selectedCard) {
        selectedCard.classList.add('active');
    }
    
    // Aggiorna breadcrumb
    const category = categories[categoryId];
    if (category) {
        document.getElementById('currentCategoryBreadcrumb').textContent = `${category.icon} ${category.name}`;
    }
    
    // Filtra prodotti
    filterProductsByCategory(categoryId);
    
    console.log('Categoria selezionata:', categoryId);
}

function filterProductsByCategory(categoryId) {
    // Qui andrà la logica di filtro quando collegato all'inventario reale
    console.log('Filtrando per categoria:', categoryId);
}

function showAddCategoryModal() {
    const modalHtml = `
        <div id="categoryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 500px; width: 100%; border: 3px solid #FFD700;">
                <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 1.4em;">➕ Nuova Categoria</h3>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #FFD700; display: block; margin-bottom: 8px; font-weight: bold;">📝 Nome Categoria:</label>
                    <input type="text" id="categoryName" placeholder="Es: Bundle Promozionali" style="width: 100%; padding: 12px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff; font-size: 16px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #FFD700; display: block; margin-bottom: 8px; font-weight: bold;">🎨 Icona Categoria:</label>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                        ${['🎴', '📦', '🥫', '🛡️', '🎯', '⚡', '🌟', '🔥', '💎', '🏆', '🎁', '🎪'].map(icon => 
                            `<button onclick="selectIcon('${icon}')" style="padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff; font-size: 1.2em; cursor: pointer;" class="icon-btn">${icon}</button>`
                        ).join('')}
                    </div>
                    <input type="hidden" id="selectedIcon" value="🎴">
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button onclick="createCategory()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #006400, #32CD32); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer;">✅ Crea Categoria</button>
                    <button onclick="closeCategoryModal()" style="flex: 1; padding: 15px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer;">❌ Annulla</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function selectIcon(icon) {
    document.getElementById('selectedIcon').value = icon;
    document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.style.borderColor = '#8B0000';
        btn.style.background = '#000';
    });
    event.target.style.borderColor = '#FFD700';
    event.target.style.background = '#8B0000';
}

function createCategory() {
    const name = document.getElementById('categoryName').value.trim();
    const icon = document.getElementById('selectedIcon').value;
    
    if (!name) {
        alert('❌ Inserisci il nome della categoria!');
        return;
    }
    
    // Crea ID categoria
    const categoryId = name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
    
    if (categories[categoryId]) {
        alert('❌ Categoria già esistente!');
        return;
    }
    
    // Aggiungi categoria
    categories[categoryId] = {
        name: name,
        icon: icon,
        count: 0,
        value: 0
    };
    
    // Aggiorna UI
    addCategoryToGrid(categoryId, categories[categoryId]);
    closeCategoryModal();
    
    alert(`✅ Categoria "${name}" creata con successo!`);
    console.log('Nuova categoria:', categories[categoryId]);
}

function addCategoryToGrid(categoryId, category) {
    const grid = document.querySelector('.categories-grid');
    const categoryHtml = `
        <div class="category-card" onclick="selectCategory('${categoryId}')">
            <div class="category-icon">${category.icon}</div>
            <div class="category-name">${category.name}</div>
            <div class="category-count">${category.count} articoli</div>
            <div class="category-value">€${category.value} totale</div>
            <div class="category-actions">
                <button class="category-action-btn btn-edit-category" onclick="editCategory('${categoryId}', event)">✏️</button>
                <button class="category-action-btn btn-delete-category" onclick="deleteCategory('${categoryId}', event)">🗑️</button>
            </div>
        </div>
    `;
    grid.insertAdjacentHTML('beforeend', categoryHtml);
}

function editCategory(categoryId, event) {
    event.stopPropagation();
    const category = categories[categoryId];
    
    const newName = prompt(`✏️ Modifica nome categoria:\n\nAttuale: "${category.name}"`, category.name);
    if (newName && newName.trim() && newName !== category.name) {
        category.name = newName.trim();
        
        // Aggiorna UI
        const card = document.querySelector(`[onclick="selectCategory('${categoryId}')"]`);
        if (card) {
            card.querySelector('.category-name').textContent = category.name;
        }
        
        alert(`✅ Categoria rinominata in "${category.name}"!`);
        console.log('Categoria modificata:', categoryId, category);
    }
}

function deleteCategory(categoryId, event) {
    event.stopPropagation();
    
    if (categoryId === 'all') {
        alert('❌ Non puoi eliminare la categoria "Tutti i Prodotti"!');
        return;
    }
    
    const category = categories[categoryId];
    if (confirm(`🗑️ Eliminare la categoria "${category.name}"?\n\n⚠️ I prodotti verranno spostati in "Senza Categoria"`)) {
        // Rimuovi categoria
        delete categories[categoryId];
        
        // Rimuovi dalla UI
        const card = document.querySelector(`[onclick="selectCategory('${categoryId}')"]`);
        if (card) card.remove();
        
        // Se era selezionata, torna a "Tutti"
        if (currentCategory === categoryId) {
            selectCategory('all');
        }
        
        alert(`✅ Categoria "${category.name}" eliminata!`);
        console.log('Categoria eliminata:', categoryId);
    }
}

function closeCategoryModal() {
    const modal = document.getElementById('categoryModal');
    if (modal) modal.remove();
}

// ========== FUNZIONI INVENTARIO ==========
function searchInventory(searchTerm) {
    console.log('Ricerca inventario:', searchTerm);
    // Qui andrà la logica di ricerca
}

function filterInventory(filterType) {
    // Aggiorna pulsanti attivi
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    console.log('Filtro inventario:', filterType);
    // Qui andrà la logica di filtro
}

function refreshInventory() {
    console.log('Aggiornamento inventario...');
    loadInventory();
}

// ========== MIGLIORA CONTROLLO PRODOTTI SIMILI ==========
function updateSaleInfo() {
    const select = document.getElementById('salesItemSelect');
    const option = select.options[select.selectedIndex];
    
    if (option.value && option.dataset) {
        currentItemPrice = parseFloat(option.dataset.price) || 0;
        const available = parseInt(option.dataset.available) || 0;
        
        document.getElementById('itemInfo').style.display = 'block';
        document.getElementById('itemDetails').innerHTML = 
            `<strong>Disponibili:</strong> ${available} pezzi<br>` +
            `<strong>Prezzo acquisto:</strong> €${currentItemPrice.toFixed(2)} cadauno<br>` +
            `<strong>Prodotto:</strong> ${option.textContent.split(' (')[0]}`;
        
        // Imposta quantità massima
        const qtyInput = document.querySelector('input[name="quantita_vendita"]');
        qtyInput.max = available;
        if (parseInt(qtyInput.value) > available) {
            qtyInput.value = available;
        }
        
        calculateSalePrice();
    } else {
        document.getElementById('itemInfo').style.display = 'none';
        currentItemPrice = 0;
        clearSalePreview();
    }
}
// FUNZIONI BASE
function showTab(tabName) {
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    
    // Carica dati quando necessario
    if (tabName === 'inventory') loadInventory();
    if (tabName === 'sales') loadSalesItems();
    if (tabName === 'reports') loadSalesReport();
    if (tabName === 'cash') loadCashStatus();
    if (tabName === 'balance') loadPersonalBalanceWithPayments();
}

function showMessage(text, type) {
    document.getElementById('message').innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => document.getElementById('message').innerHTML = '', 5000);
}

function calculateUnitPrice() {
    // Retrocompatibilità - reindirizza alla nuova funzione
    calculateExpensePrice();
}

// FORM SPESE CON CONTROLLO SIMILARITÀ
document.getElementById('expenseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    
    // Se destinazione è "Da Vendere" o "Uso Interno", controlla similarità
    if (data.categoria === 'Da Vendere' || data.categoria === 'Uso Interno') {
        showMessage('🔍 Controllo prodotti simili...', 'success');
        
        try {
            const similarResult = await apiCall('checkSimilarProducts', {
                productName: data.descrizione,
                categoria: data.categoria
            });
            
            if (similarResult.success && similarResult.similarities.length > 0) {
                // Trovati prodotti simili - chiedi conferma
                const confirmed = await showSimilarProductDialog(data, similarResult.similarities);
                if (!confirmed) return; // User cancelled
            }
        } catch (error) {
            console.log('Errore controllo similarità:', error);
            // Continua comunque con l'inserimento normale
        }
    }
    
    // Procedi con l'inserimento normale
    showMessage('⏳ Salvando spesa...', 'success');
    const result = await apiCall('addExpense', data);
    showMessage(result.message, 'success');
    this.reset();
    document.querySelector('input[name="data"]').value = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="quantita"]').value = 1;
    document.getElementById('pricePreview').style.display = 'none';
});

// STUB PER ALTRI FORM
// FORM VENDITE - VERSIONE VERA
document.getElementById('salesForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    
    showMessage('⏳ Registrando vendita...', 'success');
    
    try {
        const result = await apiCall('addSale', data);
        
        if (result.success) {
            showMessage(result.message, 'success');
            this.reset();
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="data_vendita"]').value = today;
            
            // Ricarica inventario dopo vendita
            loadInventory();
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('❌ Errore: ' + error.message, 'error');
    }
});
document.getElementById('addCashForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    
    showMessage('⏳ Aggiungendo alla cassa...', 'success');
    
    try {
        const result = await apiCall('addCash', data);
        
        if (result.success) {
            showMessage(result.message, 'success');
            this.reset();
            loadCashStatus();
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('❌ Errore: ' + error.message, 'error');
    }
});
// FORM PAGAMENTI INTERNI
document.getElementById('internalPaymentForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    
    // Validazione: non puoi pagare a te stesso
    if (data.da_chi === data.a_chi) {
        showMessage('❌ Non puoi pagare a te stesso!', 'error');
        return;
    }
    
    showMessage('⏳ Registrando pagamento...', 'success');
    
    try {
        const result = await apiCall('addInternalPayment', data);
        
        if (result.success) {
            showMessage(result.message, 'success');
            this.reset();
            loadPersonalBalanceWithPayments();
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('❌ Errore: ' + error.message, 'error');
    }
});
// CARICAMENTO SEZIONI
async function loadInventory() {
    document.getElementById('inventoryLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getInventory');
        
        if (result.success && result.data) {
            // Renderizza inventario da vendere
            const vendereHtml = result.data.daVendere.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <span class="item-name">${item.descrizione}</span>
                        <span class="item-status ${item.quantita_disponibile > 0 ? 'status-disponibile' : 'status-esaurito'}">
                            ${item.quantita_disponibile > 0 ? 'DISPONIBILE' : 'ESAURITO'}
                        </span>
                    </div>
                    <div class="quantity-info">
                        <strong>Quantità:</strong> ${item.quantita_disponibile} disponibili (${item.quantita_totale} totali)<br>
                        <strong>Prezzo acquisto:</strong> €${parseFloat(item.prezzo_unitario).toFixed(2)} cad.
                    </div>
                    <div class="item-details">
    Acquistato da <strong>${item.acquistato_da}</strong> il ${new Date(item.data).toLocaleDateString('it-IT', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    })}<br>
    <button class="btn btn-small" onclick="editItem('${item.id}')" style="background: #FFA500; margin-top: 10px;">✏️ Modifica</button>
<button class="btn btn-small" onclick="deleteItem('${item.id}')" style="background: #8B0000; margin-top: 10px;">🗑️ Elimina</button>
<button class="btn btn-small" onclick="selectForUnify('${item.id}', '${item.descrizione}')" style="background: #006400; margin-top: 10px;">🔗 Unifica</button>
</div>
                </div>
            `).join('') || '<p>Nessun oggetto da vendere</p>';
            
            // Renderizza inventario uso interno
            const internoHtml = result.data.usoInterno.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <span class="item-name">${item.descrizione}</span>
                        <span class="item-status status-uso">USO INTERNO</span>
                    </div>
                    <div class="quantity-info">
                        <strong>Quantità:</strong> ${item.quantita_totale}<br>
                        <strong>Prezzo acquisto:</strong> €${parseFloat(item.prezzo_unitario).toFixed(2)} cad.
                    </div>
                    <div class="item-details">
    Acquistato da <strong>${item.acquistato_da}</strong> il ${new Date(item.data).toLocaleDateString('it-IT', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    })}<br>
    <button class="btn btn-small" onclick="editItem('${item.id}')" style="background: #FFA500; margin-top: 10px;">✏️ Modifica</button>
<button class="btn btn-small" onclick="deleteItem('${item.id}')" style="background: #8B0000; margin-top: 10px;">🗑️ Elimina</button>
<button class="btn btn-small" onclick="selectForUnify('${item.id}', '${item.descrizione}')" style="background: #006400; margin-top: 10px;">🔗 Unifica</button>
</div>
                </div>
            `).join('') || '<p>Nessun oggetto uso interno</p>';
            
            document.getElementById('inventoryVendereContent').innerHTML = vendereHtml;
            document.getElementById('inventoryInternoContent').innerHTML = internoHtml;
        } else {
            showMessage('❌ ' + (result.message || 'Errore caricamento inventario'), 'error');
        }
    } catch (error) {
        showMessage('❌ Errore: ' + error.message, 'error');
    }
    
   document.getElementById('inventoryLoading').style.display = 'none';
}

// CARICA OGGETTI VENDIBILI NEL DROPDOWN
function loadSalesItems() {
    apiCall('getInventory').then(result => {
        const select = document.getElementById('salesItemSelect');
        let options = '<option value="">Seleziona oggetto...</option>';
        
        if (result.success && result.data && result.data.daVendere) {
            result.data.daVendere.forEach(item => {
                if (item.quantita_disponibile > 0) {
                    options += `<option value="${item.id}">${item.descrizione} (${item.quantita_disponibile} disp. - €${parseFloat(item.prezzo_unitario).toFixed(2)} cad.)</option>`;
                }
            });
        }
        
        if (select) select.innerHTML = options;
    });
}
// MODIFICA OGGETTO INVENTARIO
function editItem(itemId) {
    // Prima recupera i dati attuali
    apiCall('getInventory').then(result => {
        if (result.success && result.data) {
            // Trova l'oggetto corrente
            let currentItem = null;
            [...result.data.daVendere, ...result.data.usoInterno].forEach(item => {
                if (item.id === itemId) currentItem = item;
            });
            
            if (!currentItem) {
                showMessage('❌ Oggetto non trovato', 'error');
                return;
            }
            
            // Crea form di modifica
            const editHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 90%; border: 2px solid #8B0000;">
                        <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">✏️ Modifica Oggetto</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="color: #FFD700; display: block; margin-bottom: 5px;">📝 Nome:</label>
                            <input type="text" id="editName" value="${currentItem.descrizione}" style="width: 100%; padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="color: #FFD700; display: block; margin-bottom: 5px;">📦 Quantità Totale:</label>
                            <input type="number" id="editQuantity" value="${currentItem.quantita_totale}" min="1" style="width: 100%; padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="color: #FFD700; display: block; margin-bottom: 5px;">💰 Prezzo Unitario €:</label>
                            <input type="number" id="editPrice" value="${currentItem.prezzo_unitario}" step="0.01" min="0" style="width: 100%; padding: 10px; border: 2px solid #8B0000; border-radius: 8px; background: #000; color: #fff;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveItemChanges('${itemId}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #8B0000, #FF0000); color: white; border: none; border-radius: 8px; font-weight: bold;">💾 Salva</button>
                            <button onclick="closeEditModal()" style="flex: 1; padding: 12px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold;">❌ Annulla</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', editHtml);
        }
    });
}
   // SALVA MODIFICHE OGGETTO
function saveItemChanges(itemId) {
    const newName = document.getElementById('editName').value.trim();
    const newQuantity = parseInt(document.getElementById('editQuantity').value);
    const newPrice = parseFloat(document.getElementById('editPrice').value);
    
    if (!newName || newQuantity < 1 || newPrice < 0) {
        alert('❌ Compila tutti i campi correttamente!');
        return;
    }
    
    apiCall('updateItemComplete', {
        id: itemId,
        nuovo_nome: newName,
        nuova_quantita: newQuantity,
        nuovo_prezzo: newPrice
    }).then(result => {
        if (result.success) {
            showMessage('✅ Oggetto modificato!', 'success');
            closeEditModal();
            loadInventory();
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    });
}

// CHIUDI MODAL MODIFICA
function closeEditModal() {
    const modal = document.querySelector('div[style*="position: fixed"]');
    if (modal) modal.remove();
}     
// MOSTRA DIALOG PER PRODOTTI SIMILI
async function showSimilarProductDialog(newProductData, similarities) {
    return new Promise((resolve) => {
        const bestMatch = similarities[0]; // Il più simile
        
        // Salva dati per la funzione unify
        window.currentExpenseData = newProductData;
        window.currentSimilarProduct = bestMatch;
        
        const dialogHtml = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <!-- ... resto del dialog ... -->
                <div style="background: #1a1a1a; padding: 25px; border-radius: 15px; max-width: 95%; border: 3px solid #FFD700; max-height: 80vh; overflow-y: auto;">
                    
                    <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">⚠️ PRODOTTO SIMILE TROVATO</h3>
                    
                    <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #FFD700;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">📦 Stai inserendo:</div>
                        <div style="color: #fff; font-size: 1.1em;">"${newProductData.descrizione}"</div>
                        <div style="color: #ccc; font-size: 0.9em; margin-top: 5px;">
                            ${newProductData.quantita}x - €${parseFloat(newProductData.prezzo_totale).toFixed(2)} totale - ${newProductData.socio}
                        </div>
                    </div>
                    
                    <div style="background: rgba(139,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #8B0000;">
                        <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">🔍 Prodotto esistente simile:</div>
                        <div style="color: #fff; font-size: 1.1em;">"${bestMatch.name}"</div>
                        <div style="color: #ccc; font-size: 0.9em; margin-top: 5px;">
                            ${bestMatch.quantity}x totali (${bestMatch.available}x disponibili) - €${parseFloat(bestMatch.price).toFixed(2)} cad. - ${bestMatch.owner}
                        </div>
                        <div style="color: #90EE90; font-size: 0.8em; margin-top: 8px;">
                            📊 Similarità: ${bestMatch.confidence}% | Parole comuni: ${bestMatch.commonWords.join(', ')}
                        </div>
                    </div>
                    
                    <div style="color: #FFD700; font-weight: bold; margin-bottom: 15px; text-align: center;">🤔 Cosa vuoi fare?</div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="handleSimilarChoice('unify')" style="padding: 12px; background: linear-gradient(135deg, #006400, #90EE90); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">
                            🔄 UNIFICA - Aggiungi al prodotto esistente
                        </button>
                        <button onclick="handleSimilarChoice('separate')" style="padding: 12px; background: linear-gradient(135deg, #8B0000, #FF0000); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">
                            🆕 SEPARA - Mantieni come prodotto diverso
                        </button>
                        <button onclick="handleSimilarChoice('cancel')" style="padding: 12px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1em;">
                            ❌ ANNULLA - Torna alla modifica
                        </button>
                    </div>
                    
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', dialogHtml);
        
        // Gestione scelte
        window.handleSimilarChoice = function(choice) {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) modal.remove();
            
            if (choice === 'unify') {
    showMessage('🔄 Unificando prodotto...', 'success');
    
    // Chiama API per unificare
    apiCall('unifyProductDuringExpense', {
        newExpenseData: JSON.stringify(window.currentExpenseData),
        existingProductId: window.currentSimilarProduct.id
    }).then(result => {
        if (result.success) {
            showMessage(result.message, 'success');
            document.getElementById('expenseForm').reset();
            document.querySelector('input[name="data"]').value = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="quantita"]').value = 1;
            document.getElementById('pricePreview').style.display = 'none';
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    }).catch(error => {
        showMessage('❌ Errore unificazione: ' + error.message, 'error');
    });
    
    resolve(true); // Operazione completata
} else if (choice === 'separate') {
                resolve(true); // Procedi con inserimento normale
            } else {
                resolve(false); // Annulla inserimento
            }
        };
    });
}
// ELIMINA OGGETTO INVENTARIO
function deleteItem(itemId) {
    if (confirm("Sei sicuro di voler eliminare questo oggetto?")) {
        apiCall('deleteItem', {
            id: itemId
        }).then(result => {
            if (result.success) {
                showMessage('✅ Oggetto eliminato!', 'success');
                loadInventory();
            } else {
                showMessage('❌ ' + result.message, 'error');
            }
        });
    }
}

async function loadSalesReport() {
    document.getElementById('reportsLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getSalesReport');
        
        if (result.success) {
            const { sales, stats } = result;
            
            const statsHtml = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">€${stats.totalRevenue.toFixed(2)}</div>
                        <div class="stat-label">Ricavo Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${stats.totalProfit.toFixed(2)}</div>
                        <div class="stat-label">Profitto Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.avgROI}%</div>
                        <div class="stat-label">ROI Medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.itemsSold}</div>
                        <div class="stat-label">Oggetti Venduti</div>
                    </div>
                </div>
            `;
            
            const salesHtml = sales.slice(-5).reverse().map(sale => `
                <div class="item-card">
                    <div class="item-header">
                        <span class="item-name">${sale.quantita}x ${sale.oggetto}</span>
                        <span class="profit-positive">+€${parseFloat(sale.profitto_totale).toFixed(2)}</span>
                    </div>
                    <div class="item-details">
                        <strong>Vendita:</strong> €${parseFloat(sale.prezzo_totale_vendita).toFixed(2)} totale<br>
                        <strong>Profitto per socio:</strong> €${(parseFloat(sale.profitto_totale) / 3).toFixed(2)} ciascuno<br>
                        <strong>Venduto a:</strong> ${sale.venduto_a}<br>
                        <strong>Data:</strong> ${new Date(sale.data).toLocaleDateString('it-IT')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('reportsContent').innerHTML = statsHtml + '<h3 style="color: #FFD700; margin: 20px 0; text-align: center;">📈 Vendite Recenti</h3>' + (salesHtml || '<p>Nessuna vendita</p>');
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('❌ Errore caricamento report: ' + error.toString(), 'error');
    }
    
    document.getElementById('reportsLoading').style.display = 'none';
}
async function loadCashStatus() {
    document.getElementById('cashLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getCashStatus');
        
        if (result.success) {
            const statsHtml = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">€${result.saldoCassa.toFixed(2)}</div>
                        <div class="stat-label">Saldo Attuale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${result.daVendite.toFixed(2)}</div>
                        <div class="stat-label">Da Vendite</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${result.versamenti.toFixed(2)}</div>
                        <div class="stat-label">Versamenti</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${result.spese.toFixed(2)}</div>
                        <div class="stat-label">Spese</div>
                    </div>
                </div>
            `;
            
            document.getElementById('cashContent').innerHTML = statsHtml;
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('❌ Errore caricamento cassa: ' + error.toString(), 'error');
    }
    
    document.getElementById('cashLoading').style.display = 'none';
}
async function loadPersonalBalance() {
    document.getElementById('balanceLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getPersonalBalance');
        
        if (result.success) {
            const { balance } = result;
            
            const balanceHtml = `
                <div class="balance-item">
                    <span class="balance-name" onclick="showPersonDetails('Ciano')" style="cursor: pointer;">🎮 Ciano</span>
                    <span class="balance-amount ${balance.ciano.differenza >= 0 ? 'positive' : 'negative'}">${balance.ciano.stato}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-name" onclick="showPersonDetails('Alex')" style="cursor: pointer;">🔥 Alex</span>
                    <span class="balance-amount ${balance.alex.differenza >= 0 ? 'positive' : 'negative'}">${balance.alex.stato}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-name" onclick="showPersonDetails('King')" style="cursor: pointer;">👑 King</span>
                    <span class="balance-amount ${balance.king.differenza >= 0 ? 'positive' : 'negative'}">${balance.king.stato}</span>
                </div>
                <div class="balance-item" style="border-top: 2px solid #FFD700; margin-top: 15px; padding-top: 15px;">
                    <span class="balance-name">💰 Totale Investito</span>
                    <span class="balance-amount" style="background: #FFD700; color: #000;">€${balance.totale.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('balanceContent').innerHTML = balanceHtml;
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('❌ Errore caricamento bilancio: ' + error.toString(), 'error');
    }
    
      document.getElementById('balanceLoading').style.display = 'none';
}
    // CARICA BILANCIO CON PAGAMENTI
// SOSTITUISCI COMPLETAMENTE la funzione loadPersonalBalanceWithPayments() con questa:
async function loadPersonalBalanceWithPayments() {
    document.getElementById('balanceLoading').style.display = 'block';
    
    try {
        const result = await apiCall('getPersonalBalanceWithPayments');
        
        if (result.success) {
            const { balance, pagamenti } = result;
            // 🎯 CALCOLA CHI DEVE VERSARE A CHI
    const destinatari = calcolaDestinatari(balance);
    
    // Aggiungi destinatari ai dati
    balance.ciano.destinatario = destinatari.ciano;
    balance.alex.destinatario = destinatari.alex;
    balance.king.destinatario = destinatari.king;
            // 🎯 NUOVO HTML GENERATO CON CARD CHIARE
            const balanceHtml = `
    ${createBalanceExplanation()}
    ${generateBalanceCard('🎮 Ciano', balance.ciano, balance.totale)}
    ${generateBalanceCard('🔥 Alex', balance.alex, balance.totale)}
    ${generateBalanceCard('👑 King', balance.king, balance.totale)}
                
                <div class="balance-item-new" style="border-color: #FFD700;">
                    <div class="balance-header" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
                        <span class="balance-name-new" style="color: #000;">💰 Totale Investito</span>
                        <span class="balance-status" style="background: #000; color: #FFD700;">€${balance.totale.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            // Cronologia pagamenti (come prima)
            let paymentsHtml = '';
            if (pagamenti && pagamenti.length > 0) {
                paymentsHtml = `
                    <h3 style="color: #FFD700; margin: 20px 0 10px 0; text-align: center;">📋 Ultimi Pagamenti</h3>
                    ${pagamenti.slice(0, 5).map(payment => `
                        <div class="cash-movement movement-out">
                            <div>
                                <strong>${payment[1]} → ${payment[2]}</strong><br>
                                <small>${payment[4]} • ${new Date(payment[0]).toLocaleDateString('it-IT')}</small>
                            </div>
                            <span class="balance-amount negative">€${parseFloat(payment[3]).toFixed(2)}</span>
                        </div>
                    `).join('')}
                `;
            }
            
            document.getElementById('balanceContent').innerHTML = balanceHtml + paymentsHtml;
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    } catch (error) {
        showMessage('❌ Errore caricamento bilancio: ' + error.toString(), 'error');
    }
    
    document.getElementById('balanceLoading').style.display = 'none';
}

// 🎯 SOSTITUISCI COMPLETAMENTE la funzione generateBalanceCard() con questa:
function generateBalanceCard(nome, dati, totaleInvestito) {
    const statusClass = dati.reale >= 0 ? 'status-positive' : 'status-negative';
    const statusColor = dati.reale >= 0 ? '#90EE90' : '#FFB6C1';
    const quotaTeorica = totaleInvestito / 3;
    
    // Calcola quanto ha speso realmente (dalla differenza teorica)
    const spesoReale = quotaTeorica + dati.teorico;
    
    // 🆕 CALCOLA BILANCIO TEORICO PURO (senza pagamenti)
    const differenzaTeoricaPura = dati.teorico;
    const statusTeorico = differenzaTeoricaPura >= 0 ? 'Riceve' : 'Versa';
    const importoTeorico = Math.abs(differenzaTeoricaPura);
    const coloreTeorico = differenzaTeoricaPura >= 0 ? '#90EE90' : '#FFB6C1';
    
    return `
        <div class="balance-item-new">
            <div class="balance-header">
                <span class="balance-name-new" onclick="showPersonDetails('${nome.replace(/[🎮🔥👑]/g, '').trim()}')">${nome}</span>
                <span class="balance-status ${statusClass}">${dati.stato}</span>
            </div>
            <div class="balance-details">
                <!-- 📊 SEZIONE BILANCIO TEORICO -->
                <div class="detail-row" style="background: rgba(255,215,0,0.1); padding: 8px; border-radius: 5px; margin-bottom: 10px;">
                    <span class="detail-label">📊 TEORICO (solo spese):</span>
                    <span class="detail-value" style="color: ${coloreTeorico}; font-weight: bold;">${statusTeorico} €${importoTeorico.toFixed(2)}</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">💰 Ha Speso:</span>
                    <span class="detail-value">€${spesoReale.toFixed(2)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">📏 Dovrebbe Spendere:</span>
                    <span class="detail-value">€${quotaTeorica.toFixed(2)}</span>
                </div>
                
                <div class="divider"></div>
                
                <!-- 💸 SEZIONE PAGAMENTI E SALDO FINALE -->
                <div class="detail-row">
                    <span class="detail-label">${dati.pagamenti > 0 ? '💰 SOLDI RICEVUTI dagli altri:' : dati.pagamenti < 0 ? '💸 SOLDI DATI agli altri:' : '💳 Nessun pagamento:'}</span>
                    <span class="detail-value">${dati.pagamenti > 0 ? '+€' + dati.pagamenti.toFixed(2) : dati.pagamenti < 0 ? '€' + Math.abs(dati.pagamenti).toFixed(2) : '€0.00'}</span>
                </div>
                <div class="detail-row" style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; margin-top: 8px;">
    <span class="detail-label">🎯 SALDO FINALE:</span>
    <span class="detail-value" style="color: ${statusColor}; font-weight: bold; font-size: 1.1em;">${dati.reale >= 0 ? '+' : ''}€${dati.reale.toFixed(2)}</span>
</div>
${dati.reale !== 0 ? `
<div class="detail-row" style="background: rgba(255,215,0,0.1); padding: 8px; border-radius: 5px; margin-top: 5px; border: 1px solid #FFD700;">
    <span class="detail-label">${dati.reale > 0 ? '🎁 RICEVERAI DA:' : '💸 VERSA A:'}</span>
    <span class="detail-value" style="font-weight: bold;">${dati.destinatario || 'Calcolo in corso...'}</span>
</div>
` : ''}
            </div>
        </div>
    `;
}

    // 🎯 NUOVA FUNZIONE PER SPIEGAZIONE BILANCIO
function createBalanceExplanation() {
    return `
        <div class="info-box" style="margin-bottom: 20px; background: rgba(255,215,0,0.1); border: 2px solid #FFD700;">
            <div class="info-title">💡 Come Funziona il Bilancio</div>
            <p><strong>🔄 DINAMICO:</strong> Questo bilancio si aggiorna <strong>automaticamente</strong> ogni volta che:</p>
            <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.5;">
                <li>📦 <strong>Qualcuno fa una spesa</strong> → cambia chi deve dare/ricevere soldi</li>
                <li>💸 <strong>Fate un pagamento interno</strong> → si aggiorna il saldo finale</li>
            </ul>
            <p style="margin-top: 10px;"><strong>🎯 Saldo Finale =</strong> Quanto dovete dare/ricevere <strong>ADESSO</strong> per essere in pari!</p>
        </div>
    `;
}
      // 🎯 FUNZIONE PER CALCOLARE CHI DEVE VERSARE A CHI
function calcolaDestinatari(balance) {
    const persone = [
        { nome: 'Ciano', saldo: balance.ciano.reale },
        { nome: 'Alex', saldo: balance.alex.reale },
        { nome: 'King', saldo: balance.king.reale }
    ];
    
    // Separa chi deve ricevere e chi deve versare
    const deveRicevere = persone.filter(p => p.saldo > 0).sort((a, b) => b.saldo - a.saldo);
    const deveVersare = persone.filter(p => p.saldo < 0).sort((a, b) => a.saldo - b.saldo);
    const inPari = persone.filter(p => Math.abs(p.saldo) < 0.01);
    
    const destinatari = {};
    
    // Chi è in pari
    inPari.forEach(persona => {
        destinatari[persona.nome.toLowerCase()] = 'In pari! 🎯';
    });
    
    // Chi deve ricevere
    deveRicevere.forEach(persona => {
        const versatori = deveVersare.filter(p => p.saldo < 0).map(p => p.nome);
        if (versatori.length > 0) {
            destinatari[persona.nome.toLowerCase()] = versatori.join(' e ');
        } else {
            destinatari[persona.nome.toLowerCase()] = 'Tutti in pari';
        }
    });
    
    // Chi deve versare
    deveVersare.forEach(persona => {
        const ricevitori = deveRicevere.filter(p => p.saldo > 0).map(p => p.nome);
        if (ricevitori.length > 0) {
            destinatari[persona.nome.toLowerCase()] = ricevitori.join(' e ');
        } else {
            destinatari[persona.nome.toLowerCase()] = 'Tutti in pari';
        }
    });
    
    return destinatari;
}  
// CAMBIA TAB INVENTARIO
function showInventoryTab(type) {
    document.querySelectorAll('.inventory-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.inventory-content').forEach(content => {
        content.classList.remove('active');
    });
    
    const clickedTab = document.querySelector(`[onclick="showInventoryTab('${type}')"]`);
    if (clickedTab) clickedTab.classList.add('active');
    
    document.getElementById('inventario-' + type).classList.add('active');
}
    // MOSTRA DETTAGLI ACQUISTI PERSONA
function showPersonDetails(persona) {
    showMessage('⏳ Caricando dettagli...', 'success');
    
    apiCall('getPersonDetails', { persona: persona }).then(result => {
        if (result.success && result.acquisti) {
            let detailsHtml = `<h3 style="color: #FFD700; text-align: center; margin: 20px 0;">🛒 Acquisti di ${persona}</h3>`;
            
            result.acquisti.forEach(acquisto => {
                detailsHtml += `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-name">${acquisto.descrizione}</span>
                            <span class="profit-positive">€${parseFloat(acquisto.prezzo_totale).toFixed(2)}</span>
                        </div>
                        <div class="item-details">
                            <strong>Quantità:</strong> ${acquisto.quantita}<br>
                            <strong>Prezzo unitario:</strong> €${(parseFloat(acquisto.prezzo_totale) / parseInt(acquisto.quantita)).toFixed(2)}<br>
                            <strong>Dove:</strong> ${acquisto.dove}<br>
                            <strong>Data:</strong> ${new Date(acquisto.data).toLocaleDateString('it-IT', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}<br>
                            <strong>Tipo:</strong> ${acquisto.categoria}
                        </div>
                    </div>
                `;
            });
            
            detailsHtml += `
                <div style="text-align: center; margin: 20px 0;">
                    <strong style="color: #FFD700;">Totale Speso: €${result.totale_speso.toFixed(2)}</strong>
                </div>
                <button class="btn" onclick="loadPersonalBalance()">🔙 Torna al Bilancio</button>
            `;
            
            document.getElementById('balanceContent').innerHTML = detailsHtml;
        } else {
            showMessage('❌ Errore caricamento dettagli', 'error');
        }
    });
}
   // SISTEMA UNIFICAZIONE INVENTARIO
let unificationMode = false;
let selectedProductForUnify = null;

function selectForUnify(productId, productName) {
    if (!unificationMode) {
        // Attiva modalità unificazione
        unificationMode = true;
        selectedProductForUnify = { id: productId, name: productName };
        
        showMessage(`🔗 Modalità unificazione attiva! Seleziona il secondo prodotto da unificare con "${productName}"`, 'success');
        
        // Evidenzia tutti i pulsanti unifica
        document.querySelectorAll('button[onclick*="selectForUnify"]').forEach(btn => {
            if (btn.onclick.toString().includes(productId)) {
                btn.style.background = '#FFD700';
                btn.style.color = '#000';
                btn.innerHTML = '🟡 Selezionato';
            } else {
                btn.style.background = '#FF4500';
                btn.innerHTML = '🔗 Seleziona per unificare';
            }
        });
        
        // Aggiungi pulsante di annullamento
        showUnificationControls();
        
    } else {
        // Secondo prodotto selezionato - conferma unificazione
        if (productId === selectedProductForUnify.id) {
            showMessage('❌ Non puoi unificare un prodotto con se stesso!', 'error');
            return;
        }
        
        showUnificationConfirmDialog(selectedProductForUnify, { id: productId, name: productName });
    }
}

function showUnificationControls() {
    const controlsHtml = `
        <div id="unificationControls" style="position: fixed; bottom: 20px; left: 20px; right: 20px; background: #FFD700; color: #000; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; z-index: 1000;">
            🔗 Modalità Unificazione Attiva - Seleziona il secondo prodotto
            <br>
            <button onclick="cancelUnification()" style="margin-top: 10px; background: #8B0000; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold;">❌ Annulla</button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', controlsHtml);
}

function cancelUnification() {
    unificationMode = false;
    selectedProductForUnify = null;
    
    // Ripristina pulsanti originali
    document.querySelectorAll('button[onclick*="selectForUnify"]').forEach(btn => {
        btn.style.background = '#006400';
        btn.style.color = 'white';
        btn.innerHTML = '🔗 Unifica';
    });
    
    // Rimuovi controlli
    const controls = document.getElementById('unificationControls');
    if (controls) controls.remove();
    
    showMessage('❌ Unificazione annullata', 'error');
}

function showUnificationConfirmDialog(product1, product2) {
    const dialogHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: #1a1a1a; padding: 25px; border-radius: 15px; max-width: 95%; border: 3px solid #FFD700;">
                
                <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px;">🔗 CONFERMA UNIFICAZIONE</h3>
                
                <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #FFD700;">
                    <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">📦 Prodotto 1:</div>
                    <div style="color: #fff;">"${product1.name}"</div>
                </div>
                
                <div style="background: rgba(255,215,0,0.15); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #FFD700;">
                    <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px;">📦 Prodotto 2:</div>
                    <div style="color: #fff;">"${product2.name}"</div>
                </div>
                
                <div style="color: #FFD700; font-weight: bold; margin-bottom: 15px; text-align: center;">
                    ⚠️ I due prodotti verranno unificati in uno solo!
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="confirmUnification('${product1.id}', '${product2.id}')" style="padding: 12px; background: linear-gradient(135deg, #006400, #90EE90); color: white; border: none; border-radius: 8px; font-weight: bold;">
                        ✅ CONFERMA UNIFICAZIONE
                    </button>
                    <button onclick="closeUnificationDialog()" style="padding: 12px; background: #666; color: white; border: none; border-radius: 8px; font-weight: bold;">
                        ❌ ANNULLA
                    </button>
                </div>
                
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', dialogHtml);
}

function confirmUnification(productId1, productId2) {
    showMessage('🔗 Unificando prodotti...', 'success');
    
    apiCall('unifyExistingProducts', {
        productId1: productId1,
        productId2: productId2
    }).then(result => {
        closeUnificationDialog();
        cancelUnification();
        
        if (result.success) {
            showMessage(result.message, 'success');
            loadInventory(); // Ricarica inventario
        } else {
            showMessage('❌ ' + result.message, 'error');
        }
    }).catch(error => {
        showMessage('❌ Errore unificazione: ' + error.message, 'error');
    });
}

function closeUnificationDialog() {
    const dialog = document.querySelector('div[style*="position: fixed"][style*="z-index: 9999"]');
    if (dialog) dialog.remove();
}     
</script>
</body>
</html>
