<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3 LEGENDARY - Mobile System</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B0000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #2d1810 50%, #8B0000 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: rgba(0,0,0,0.95);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            padding: 20px 15px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(255,255,255,0.1) 8px,
                rgba(255,255,255,0.1) 16px
            );
            pointer-events: none;
        }
        
        .logo-container {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-3legendary {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #FFD700;
            box-shadow: 0 0 25px rgba(255,215,0,0.6);
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><radialGradient id="sun" cx="50%" cy="35%"><stop offset="0%" stop-color="%23FF6B6B"/><stop offset="70%" stop-color="%23DC143C"/><stop offset="100%" stop-color="%238B0000"/></radialGradient><filter id="shadow"><feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/></filter></defs><circle cx="200" cy="140" r="90" fill="url(%23sun)" stroke="%23FFD700" stroke-width="2"/><g filter="url(%23shadow)"><path d="M80,180 Q60,160 40,180 Q50,200 70,220 Q90,240 120,235 Q140,230 150,210 Q160,190 145,170 Q130,155 115,165 Q100,175 90,185 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M70,175 Q80,165 90,175 Q95,185 85,195 Q75,205 65,195 Z" fill="%23FF0000"/><path d="M110,185 L130,175 L140,190 L125,200 Z" fill="%23000000"/></g><g filter="url(%23shadow)"><path d="M280,190 Q260,170 240,190 Q250,210 270,230 Q290,250 320,245 Q340,240 350,220 Q360,200 345,180 Q330,165 315,175 Q300,185 290,195 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M270,185 Q280,175 290,185 Q295,195 285,205 Q275,215 265,205 Z" fill="%23FF0000"/><path d="M310,195 L330,185 L340,200 L325,210 Z" fill="%23000000"/></g><rect x="80" y="320" width="240" height="45" rx="10" fill="%23000000" stroke="%23FFD700" stroke-width="3"/><text x="200" y="350" text-anchor="middle" fill="%23FF0000" font-size="32" font-weight="bold" font-family="Arial Black">3 LEGENDARY</text></svg>') center/cover;
        }
        
        .header h1 {
            font-size: 1.8em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            position: relative;
            z-index: 2;
            margin: 0;
        }
        
        .legend-text {
            background: linear-gradient(45deg, #FF0000, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            position: relative;
            z-index: 2;
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            background: rgba(139,0,0,0.4);
            border-bottom: 3px solid #8B0000;
        }
        
        .tab {
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,0,0,0.4);
            border-right: 1px solid #8B0000;
            border-bottom: 1px solid #8B0000;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9em;
            position: relative;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab:nth-child(2n) {
            border-right: none;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: #fff;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(255,0,0,0.4);
        }
        
        .tab:hover:not(.active) {
            background: rgba(139,0,0,0.6);
            transform: scale(1.01);
        }
        
        .content {
            padding: 20px 15px;
            padding-bottom: 80px;
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .section {
            background: rgba(139,0,0,0.15);
            border-radius: 20px;
            padding: 25px 20px;
            margin: 15px 0;
            border: 2px solid #8B0000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 1em;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 3px solid #8B0000;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #FF0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.4);
            transform: scale(1.02);
        }
        
        .btn {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-top: 25px;
            transition: all 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 6px 20px rgba(139,0,0,0.4);
            min-height: 60px;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255,0,0,0.5);
            background: linear-gradient(135deg, #A0001A, #FF1A1A);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-small {
            width: auto;
            padding: 12px 20px;
            font-size: 14px;
            margin: 8px 5px;
            min-height: auto;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .item-card {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 5px solid #FFD700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #FFD700;
            flex: 1;
        }
        
        .item-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .status-disponibile {
            background: #006400;
            color: #90EE90;
        }
        
        .status-esaurito {
            background: #8B0000;
            color: #FFB6C1;
        }
        
        .quantity-info {
            background: rgba(255,215,0,0.15);
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
        }
        
        .item-details {
            font-size: 0.9em;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .calc-preview {
            background: rgba(255,215,0,0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .message {
            padding: 18px;
            margin: 20px 0;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
        }
        
        .success {
            background: rgba(0,100,0,0.3);
            border: 2px solid #006400;
            color: #90EE90;
        }
        
        .error {
            background: rgba(139,0,0,0.3);
            border: 2px solid #8B0000;
            color: #FFB6C1;
        }
        
        .info-box {
            background: rgba(255,215,0,0.15);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 18px;
            margin: 20px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .info-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .floating-add {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FF0000, #FFD700);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #000;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(255,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .floating-add:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,0,0,0.6);
        }
        
        /* RESPONSIVE MOBILE OPTIMIZATIONS */
        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }
            
            .logo-3legendary {
                width: 60px;
                height: 60px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .tab {
                padding: 15px 8px;
                font-size: 0.8em;
                min-height: 55px;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .section {
                padding: 20px 15px;
                margin: 10px 0;
            }
            
            .two-column {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .floating-add {
                bottom: 15px;
                right: 15px;
                width: 55px;
                height: 55px;
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-3legendary"></div>
                <h1>3 <span class="legend-text">LEGENDARY</span></h1>
            </div>
            <div class="subtitle">Sistema Mobile Pok√©mon</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('expenses')">üí∞ Spese</div>
            <div class="tab" onclick="showTab('inventory')">üì¶ Inventario</div>
            <div class="tab" onclick="showTab('sales')">üìà Vendite</div>
            <div class="tab" onclick="showTab('reports')">üìä Report</div>
        </div>
        
        <div class="content">
            <!-- 1. SPESE -->
            <div id="expenses" class="form-section active">
                <div class="section">
                    <h2>üí∞ Nuova Spesa</h2>
                    
                    <div class="info-box">
                        <div class="info-title">üì± Offline Mode:</div>
                        <p>Modalit√† <strong>locale</strong> - i dati vengono salvati temporaneamente sul telefono. Sincronizza manualmente con il sistema PC!</p>
                    </div>
                    
                    <form id="expenseForm">
                        <div class="form-group">
                            <label>üë§ Chi ha pagato:</label>
                            <select name="socio" required>
                                <option value="">Scegli...</option>
                                <option value="Portafoglio Condiviso">üí∞ Cassa Comune</option>
                                <option value="Ciano">üéÆ Ciano</option>
                                <option value="Alex">üî• Alex</option>
                                <option value="King">üëë King</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>üìù Cosa hai comprato:</label>
                            <input type="text" name="descrizione" placeholder="Es: Booster Darkness Ablaze" required>
                        </div>
                        
                        <div class="two-column">
                            <div class="form-group">
                                <label>üì¶ Quantit√†:</label>
                                <input type="number" name="quantita" min="1" value="1" required onchange="calculateUnitPrice()">
                            </div>
                            <div class="form-group">
                                <label>üí∂ Prezzo TOTALE ‚Ç¨:</label>
                                <input type="number" name="prezzo_totale" step="0.01" placeholder="0.00" required onchange="calculateUnitPrice()">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>üè™ Dove:</label>
                            <input type="text" name="dove" placeholder="eBay, Amazon, Negozio..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>üè∑Ô∏è Tipo:</label>
                            <select name="categoria" required>
                                <option value="">Seleziona...</option>
                                <option value="Da Vendere">üí∞ Da Vendere</option>
                                <option value="Uso Interno">üîß Uso Interno</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>üìÖ Data:</label>
                            <input type="date" name="data" required>
                        </div>
                        
                        <div id="pricePreview" class="calc-preview" style="display: none;">
                            <strong>üí° Calcolo:</strong><br>
                            <span id="priceCalc"></span>
                        </div>
                        
                        <button type="submit" class="btn">üíæ Salva Spesa (Locale)</button>
                    </form>
                </div>
            </div>
            
            <!-- 2. INVENTARIO -->
            <div id="inventory" class="form-section">
                <div class="section">
                    <h2>üì¶ Inventario Locale</h2>
                    
                    <div class="info-box">
                        <div class="info-title">üì± Inventario Mobile:</div>
                        <p>Visualizza gli oggetti salvati localmente. Per l'inventario completo usa il sistema PC.</p>
                    </div>
                    
                    <div id="inventoryContent">
                        <div class="item-card">
                            <div class="item-header">
                                <span class="item-name">Nessun oggetto salvato</span>
                                <span class="item-status status-esaurito">VUOTO</span>
                            </div>
                            <div class="item-details">
                                Aggiungi spese per vedere l'inventario qui!
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="refreshInventory()">üîÑ Aggiorna</button>
                </div>
            </div>
            
            <!-- 3. VENDITE -->
            <div id="sales" class="form-section">
                <div class="section">
                    <h2>üìà Registra Vendita</h2>
                    
                    <div class="info-box">
                        <div class="info-title">üí∞ Vendita Mobile:</div>
                        <p>Registra vendite in modalit√† locale. Sincronizza con il sistema PC per aggiornare tutto!</p>
                    </div>
                    
                    <form id="salesForm">
                        <div class="form-group">
                            <label>üé¥ Cosa vendi:</label>
                            <input type="text" name="oggetto" placeholder="Nome oggetto venduto" required>
                        </div>
                        
                        <div class="two-column">
                            <div class="form-group">
                                <label>üì¶ Quantit√†:</label>
                                <input type="number" name="quantita_vendita" min="1" value="1" required onchange="calculateSaleProfit()">
                            </div>
                            <div class="form-group">
                                <label>üí∂ Prezzo TOTALE ‚Ç¨:</label>
                                <input type="number" name="prezzo_totale_vendita" step="0.01" required onchange="calculateSaleProfit()">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>üí∂ Costo totale acquisto ‚Ç¨:</label>
                            <input type="number" name="costo_totale" step="0.01" required onchange="calculateSaleProfit()">
                        </div>
                        
                        <div class="form-group">
                            <label>üë§ Venduto a:</label>
                            <input type="text" name="venduto_a" placeholder="Cliente, eBay, Vinted..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>üìÖ Data vendita:</label>
                            <input type="date" name="data_vendita" required>
                        </div>
                        
                        <div id="salePreview" class="calc-preview" style="display: none;">
                            <strong>üí° Profitto:</strong><br>
                            <span id="saleCalc"></span>
                        </div>
                        
                        <button type="submit" class="btn">üí∞ Registra Vendita (Locale)</button>
                    </form>
                </div>
            </div>
            
            <!-- 4. REPORT -->
            <div id="reports" class="form-section">
                <div class="section">
                    <h2>üìä Report Mobile</h2>
                    
                    <div class="info-box">
                        <div class="info-title">üì± Dati Locali:</div>
                        <p>Statistiche basate sui dati salvati localmente su questo dispositivo.</p>
                    </div>
                    
                    <div id="reportContent">
                        <div class="item-card">
                            <div class="item-header">
                                <span class="item-name">üìä Statistiche</span>
                            </div>
                            <div class="item-details">
                                <strong>Spese registrate:</strong> <span id="totalExpenses">0</span><br>
                                <strong>Vendite registrate:</strong> <span id="totalSales">0</span><br>
                                <strong>Totale investito:</strong> ‚Ç¨<span id="totalInvested">0.00</span><br>
                                <strong>Totale ricavi:</strong> ‚Ç¨<span id="totalRevenue">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="updateReport()">üîÑ Aggiorna Report</button>
                </div>
            </div>
            
            <!-- MESSAGGI -->
            <div id="message"></div>
        </div>
        
        <!-- FLOATING ACTION BUTTON -->
        <div class="floating-add" onclick="showTab('expenses')" title="Aggiungi Spesa Veloce">
            +
        </div>
    </div>

    <script>
        // STORAGE LOCALE
        let localData = {
            expenses: [],
            sales: [],
            inventory: []
        };
        
        // Carica dati dal localStorage
        function loadLocalData() {
            const stored = localStorage.getItem('3legendary_data');
            if (stored) {
                localData = JSON.parse(stored);
            }
        }
        
        // Salva dati nel localStorage
        function saveLocalData() {
            localStorage.setItem('3legendary_data', JSON.stringify(localData));
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalData();
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });
            
            refreshInventory();
            updateReport();
        });

        function showTab(tabName) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'inventory') refreshInventory();
            if (tabName === 'reports') updateReport();
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // CALCOLI AUTOMATICI
        function calculateUnitPrice() {
            const quantita = parseInt(document.querySelector('input[name="quantita"]').value) || 0;
            const prezzoTotale = parseFloat(document.querySelector('input[name="prezzo_totale"]').value) || 0;
            
            if (quantita > 0 && prezzoTotale > 0) {
                const prezzoUnitario = prezzoTotale / quantita;
                document.getElementById('pricePreview').style.display = 'block';
                document.getElementById('priceCalc').innerHTML = `
                    <strong>${quantita}x</strong> a <strong>‚Ç¨${prezzoUnitario.toFixed(2)}</strong> per pezzo
                `;
            } else {
                document.getElementById('pricePreview').style.display = 'none';
            }
        }

        function calculateSaleProfit() {
            const quantita = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
            const prezzoTotaleVendita = parseFloat(document.querySelector('input[name="prezzo_totale_vendita"]').value) || 0;
            const costoTotale = parseFloat(document.querySelector('input[name="costo_totale"]').value) || 0;
            
            if (quantita > 0 && prezzoTotaleVendita > 0 && costoTotale > 0) {
                const profittoTotale = prezzoTotaleVendita - costoTotale;
                const percentuale = ((profittoTotale / costoTotale) * 100).toFixed(1);
                const profittoPerSocio = profittoTotale / 3;
                
                const profitClass = profittoTotale >= 0 ? 'success' : 'error';
                
                document.getElementById('salePreview').style.display = 'block';
                document.getElementById('saleCalc').innerHTML = `
                    <strong>Costo:</strong> ‚Ç¨${costoTotale.toFixed(2)}<br>
                    <strong>Ricavo:</strong> ‚Ç¨${prezzoTotaleVendita.toFixed(2)}<br>
                    <strong>Profitto:</strong> ‚Ç¨${profittoTotale.toFixed(2)} (${percentuale}%)<br>
                    <strong>Per socio:</strong> ‚Ç¨${profittoPerSocio.toFixed(2)} ciascuno
                `;
            } else {
                document.getElementById('salePreview').style.display = 'none';
            }
        }

        // FORM HANDLERS
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Calcola prezzo unitario
            const quantita = parseInt(data.quantita);
            const prezzoTotale = parseFloat(data.prezzo_totale);
            data.prezzo_unitario = (prezzoTotale / quantita).toFixed(2);
            data.id = 'EXP' + Date.now();
            
            // Salva localmente
            localData.expenses.push(data);
            
            // Se √® "Da Vendere" o "Uso Interno", aggiungi all'inventario
            if (data.categoria === 'Da Vendere' || data.categoria === 'Uso Interno') {
                const inventoryItem = {
                    id: 'INV' + Date.now(),
                    descrizione: data.descrizione,
                    acquistato_da: data.socio,
                    quantita_totale: quantita,
                    quantita_disponibile: quantita,
                    prezzo_unitario: parseFloat(data.prezzo_unitario),
                    destinazione: data.categoria,
                    data: data.data,
                    stato: 'Disponibile'
                };
                localData.inventory.push(inventoryItem);
            }
            
            saveLocalData();
            
            showMessage(`‚úÖ Spesa salvata! ${quantita}x ${data.descrizione} a ‚Ç¨${data.prezzo_unitario} cad.`, 'success');
            this.reset();
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="data"]').value = today;
            document.querySelector('input[name="quantita"]').value = 1;
            document.getElementById('pricePreview').style.display = 'none';
            
            refreshInventory();
            updateReport();
        });

        document.getElementById('salesForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            const quantita = parseInt(data.quantita_vendita);
            const prezzoTotaleVendita = parseFloat(data.prezzo_totale_vendita);
            const costoTotale = parseFloat(data.costo_totale);
            const profittoTotale = prezzoTotaleVendita - costoTotale;
            
            data.profitto_totale = profittoTotale.toFixed(2);
            data.profitto_per_socio = (profittoTotale / 3).toFixed(2);
            data.percentuale = ((profittoTotale / costoTotale) * 100).toFixed(1);
            data.id = 'SALE' + Date.now();
            
            localData.sales.push(data);
            saveLocalData();
            
            showMessage(`‚úÖ Vendita registrata! Profitto: ‚Ç¨${profittoTotale.toFixed(2)} (${data.percentuale}%)`, 'success');
            this.reset();
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="data_vendita"]').value = today;
            document.querySelector('input[name="quantita_vendita"]').value = 1;
            document.getElementById('salePreview').style.display = 'none';
            
            updateReport();
        });

        // INVENTARIO
        function refreshInventory() {
            const content = document.getElementById('inventoryContent');
            
            if (localData.inventory.length === 0) {
                content.innerHTML = `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-name">Nessun oggetto salvato</span>
                            <span class="item-status status-esaurito">VUOTO</span>
                        </div>
                        <div class="item-details">
                            Aggiungi spese per vedere l'inventario qui!
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            localData.inventory.forEach(item => {
                const statusClass = item.quantita_disponibile > 0 ? 'status-disponibile' : 'status-esaurito';
                const statusText = item.quantita_disponibile > 0 ? 'DISPONIBILE' : 'ESAURITO';
                
                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-name">${item.descrizione}</span>
                            <span class="item-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="quantity-info">
                            <strong>Quantit√†:</strong> ${item.quantita_disponibile} disponibili (${item.quantita_totale} totali)<br>
                            <strong>Prezzo acquisto:</strong> ‚Ç¨${item.prezzo_unitario.toFixed(2)} cad.<br>
                            <strong>Destinazione:</strong> ${item.destinazione}
                        </div>
                        <div class="item-details">
                            Acquistato da <strong>${item.acquistato_da}</strong> il ${item.data}
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }

        // REPORT
        function updateReport() {
            const totalExpenses = localData.expenses.length;
            const totalSales = localData.sales.length;
            
            const totalInvested = localData.expenses.reduce((sum, exp) => 
                sum + parseFloat(exp.prezzo_totale || 0), 0);
                
            const totalRevenue = localData.sales.reduce((sum, sale) => 
                sum + parseFloat(sale.prezzo_totale_vendita || 0), 0);
            
            document.getElementById('totalExpenses').textContent = totalExpenses;
            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalInvested').textContent = totalInvested.toFixed(2);
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
            
            // Aggiungi dettagli vendite se presenti
            if (totalSales > 0) {
                const reportContent = document.getElementById('reportContent');
                const totalProfit = localData.sales.reduce((sum, sale) => 
                    sum + parseFloat(sale.profitto_totale || 0), 0);
                
                const avgROI = totalInvested > 0 ? (totalProfit / totalInvested * 100).toFixed(1) : 0;
                
                reportContent.innerHTML = `
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-name">üìä Statistiche</span>
                        </div>
                        <div class="item-details">
                            <strong>Spese registrate:</strong> ${totalExpenses}<br>
                            <strong>Vendite registrate:</strong> ${totalSales}<br>
                            <strong>Totale investito:</strong> ‚Ç¨${totalInvested.toFixed(2)}<br>
                            <strong>Totale ricavi:</strong> ‚Ç¨${totalRevenue.toFixed(2)}<br>
                            <strong>Profitto totale:</strong> ‚Ç¨${totalProfit.toFixed(2)}<br>
                            <strong>ROI medio:</strong> ${avgROI}%
                        </div>
                    </div>
                    
                    <div class="item-card">
                        <div class="item-header">
                            <span class="item-name">üìà Ultime Vendite</span>
                        </div>
                        <div class="item-details">
                            ${localData.sales.slice(-3).reverse().map(sale => `
                                <strong>${sale.oggetto}</strong> - ‚Ç¨${sale.prezzo_totale_vendita} 
                                (Profitto: ‚Ç¨${sale.profitto_totale})<br>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // FUNZIONI UTILITY
        function exportData() {
            const dataStr = JSON.stringify(localData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = '3legendary_mobile_data.json';
            link.click();
            
            showMessage('üìÅ Dati esportati! Condividi il file con il sistema PC.', 'success');
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Vuoi cancellare TUTTI i dati locali?')) {
                localData = { expenses: [], sales: [], inventory: [] };
                saveLocalData();
                refreshInventory();
                updateReport();
                showMessage('üóëÔ∏è Tutti i dati sono stati cancellati!', 'error');
            }
        }

        // Aggiungi pulsanti utility
        function addUtilityButtons() {
            const reportSection = document.querySelector('#reports .section');
            reportSection.innerHTML += `
                <div style="margin-top: 20px;">
                    <button class="btn btn-small" onclick="exportData()" style="background: #006400;">üìÅ Esporta Dati</button>
                    <button class="btn btn-small" onclick="clearAllData()" style="background: #8B0000;">üóëÔ∏è Cancella Tutto</button>
                </div>
                
                <div class="info-box" style="margin-top: 20px;">
                    <div class="info-title">üîÑ Sincronizzazione:</div>
                    <p>Per sincronizzare con il sistema PC:</p>
                    <p>1. Esporta i dati mobili<br>
                    2. Apri il sistema PC<br>
                    3. Inserisci manualmente le spese/vendite<br>
                    4. Cancella i dati mobili</p>
                </div>
            `;
        }

        // Inizializza utility al caricamento
        setTimeout(addUtilityButtons, 1000);