<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3 LEGENDARY - Mobile System</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B0000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #2d1810 50%, #8B0000 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: rgba(0,0,0,0.95);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            padding: 20px 15px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 8px,
                rgba(255,255,255,0.1) 8px,
                rgba(255,255,255,0.1) 16px
            );
            pointer-events: none;
        }
        
        .logo-container {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-3legendary {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #FFD700;
            box-shadow: 0 0 25px rgba(255,215,0,0.6);
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><defs><radialGradient id="sun" cx="50%" cy="35%"><stop offset="0%" stop-color="%23FF6B6B"/><stop offset="70%" stop-color="%23DC143C"/><stop offset="100%" stop-color="%238B0000"/></radialGradient><filter id="shadow"><feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/></filter></defs><circle cx="200" cy="140" r="90" fill="url(%23sun)" stroke="%23FFD700" stroke-width="2"/><g filter="url(%23shadow)"><path d="M80,180 Q60,160 40,180 Q50,200 70,220 Q90,240 120,235 Q140,230 150,210 Q160,190 145,170 Q130,155 115,165 Q100,175 90,185 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M70,175 Q80,165 90,175 Q95,185 85,195 Q75,205 65,195 Z" fill="%23FF0000"/><path d="M110,185 L130,175 L140,190 L125,200 Z" fill="%23000000"/></g><g filter="url(%23shadow)"><path d="M280,190 Q260,170 240,190 Q250,210 270,230 Q290,250 320,245 Q340,240 350,220 Q360,200 345,180 Q330,165 315,175 Q300,185 290,195 Z" fill="%23000000" stroke="%23FFD700" stroke-width="2"/><path d="M270,185 Q280,175 290,185 Q295,195 285,205 Q275,215 265,205 Z" fill="%23FF0000"/><path d="M310,195 L330,185 L340,200 L325,210 Z" fill="%23000000"/></g><rect x="80" y="320" width="240" height="45" rx="10" fill="%23000000" stroke="%23FFD700" stroke-width="3"/><text x="200" y="350" text-anchor="middle" fill="%23FF0000" font-size="32" font-weight="bold" font-family="Arial Black">3 LEGENDARY</text></svg>') center/cover;
        }
        
        .header h1 {
            font-size: 1.8em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            position: relative;
            z-index: 2;
            margin: 0;
        }
        
        .legend-text {
            background: linear-gradient(45deg, #FF0000, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            position: relative;
            z-index: 2;
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            background: rgba(139,0,0,0.4);
            border-bottom: 3px solid #8B0000;
        }
        
        .tab {
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,0,0,0.4);
            border-right: 1px solid #8B0000;
            border-bottom: 1px solid #8B0000;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9em;
            position: relative;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab:nth-child(2n) {
            border-right: none;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: #fff;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(255,0,0,0.4);
        }
        
        .tab:hover:not(.active) {
            background: rgba(139,0,0,0.6);
            transform: scale(1.01);
        }
        
        .content {
            padding: 20px 15px;
            padding-bottom: 80px;
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
        }
        
        .section {
            background: rgba(139,0,0,0.15);
            border-radius: 20px;
            padding: 25px 20px;
            margin: 15px 0;
            border: 2px solid #8B0000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 1em;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 3px solid #8B0000;
            border-radius: 12px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #FF0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.4);
            transform: scale(1.02);
        }
        
        .btn {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-top: 25px;
            transition: all 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 6px 20px rgba(139,0,0,0.4);
            min-height: 60px;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255,0,0,0.5);
            background: linear-gradient(135deg, #A0001A, #FF1A1A);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-small {
            width: auto;
            padding: 12px 20px;
            font-size: 14px;
            margin: 8px 5px;
            min-height: auto;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .inventory-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #8B0000;
        }
        
        .inventory-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: rgba(139,0,0,0.3);
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .inventory-tab.active {
            background: linear-gradient(135deg, #8B0000, #FF0000);
            color: #fff;
        }
        
        .inventory-content {
            display: none;
        }
        
        .inventory-content.active {
            display: block;
        }
        
        .item-card {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 5px solid #FFD700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #FFD700;
            flex: 1;
        }
        
        .item-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .status-disponibile {
            background: #006400;
            color: #90EE90;
        }
        
        .status-venduto {
            background: #FFD700;
            color: #000;
        }
        
        .status-esaurito {
            background: #8B0000;
            color: #FFB6C1;
        }
        
        .status-uso {
            background: #666;
            color: #fff;
        }
        
        .quantity-info {
            background: rgba(255,215,0,0.15);
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
        }
        
        .item-details {
            font-size: 0.9em;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .profit-positive {
            color: #90EE90;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #FFB6C1;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #8B0000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .info-box {
            background: rgba(255,215,0,0.15);
            border: 2px solid #FFD700;
            border-radius: 15px;
            padding: 18px;
            margin: 20px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .info-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .calc-preview {
            background: rgba(255,215,0,0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #FFD700;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .message {
            padding: 18px;
            margin: 20px 0;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 0.95em;
        }
        
        .success {
            background: rgba(0,100,0,0.3);
            border: 2px solid #006400;
            color: #90EE90;
        }
        
        .error {
            background: rgba(139,0,0,0.3);
            border: 2px solid #8B0000;
            color: #FFB6C1;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #FFD700;
            font-weight: bold;
            padding: 30px;
            font-size: 1.1em;
        }
        
        .floating-add {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FF0000, #FFD700);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #000;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(255,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .floating-add:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255,0,0,0.6);
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
            border-left: 4px solid #8B0000;
        }
        
        .balance-name {
            font-weight: bold;
            font-size: 1em;
        }
        
        .balance-amount {
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .positive {
            background: #006400;
            color: #90EE90;
        }
        
        .negative {
            background: #8B0000;
            color: #FFB6C1;
        }
        
        .neutral {
            background: #666;
            color: #fff;
        }
        
        .cash-movement {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.6);
            border-radius: 12px;
        }
        
        .movement-in {
            border-left: 4px solid #006400;
        }
        
        .movement-out {
            border-left: 4px solid #8B0000;
        }
        
        /* RESPONSIVE MOBILE OPTIMIZATIONS */
        @media (max-width: 480px) {
            .header {
                padding: 15px 10px;
            }
            
            .logo-3legendary {
                width: 60px;
                height: 60px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .tabs {
                grid-template-columns: 1fr 1fr;
            }
            
            .tab {
                padding: 15px 8px;
                font-size: 0.8em;
                min-height: 55px;
            }
            
            .content {
                padding: 15px 10px;
            }
            
            .section {
                padding: 20px 15px;
                margin: 10px 0;
            }
            
            .two-column, .three-column {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .item-name {
                font-size: 1em;
            }
            
            .floating-add {
                bottom: 15px;
                right: 15px;
                width: 55px;
                height: 55px;
                font-size: 28px;
            }
        }
        
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.4em;
            }
            
            .tab {
                font-size: 0.75em;
                padding: 12px 6px;
            }
            
            .content {
                padding: 12px 8px;
            }
            
            .section {
                padding: 18px 12px;
            }
            
            .form-group input, .form-group select {
                padding: 14px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        /* PWA STYLES */
        @media (display-mode: standalone) {
            .container {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* DARK MODE SUPPORT */
        @media (prefers-color-scheme: dark) {
            .form-group input, .form-group select {
                background: rgba(0,0,0,0.9);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-3legendary"></div>
                <h1>3 <span class="legend-text">LEGENDARY</span></h1>
            </div>
            <div class="subtitle">Sistema Mobile Pokémon</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('expenses')">💰 Spese</div>
            <div class="tab" onclick="showTab('inventory')">📦 Inventario</div>
            <div class="tab" onclick="showTab('sales')">📈 Vendite</div>
            <div class="tab" onclick="showTab('reports')">📊 Report</div>
            <div class="tab" onclick="showTab('cash')">🏦 Cassa</div>
            <div class="tab" onclick="showTab('balance')">⚖️ Bilancio</div>
        </div>
        
        <div class="content">
            <!-- 1. SPESE -->
            <div id="expenses" class="form-section active">
                <div class="section">
                    <h2>💰 Nuova Spesa</h2>
                    
                    <div class="info-box">
                        <div class="info-title">📱 Mobile Quick:</div>
                        <p>Inserisci <strong>prezzo totale</strong> e <strong>quantità</strong> - il sistema calcola tutto automaticamente!</p>
                    </div>
                    
                    <form id="expenseForm">
                        <div class="form-group">
                            <label>👤 Chi ha pagato:</label>
                            <select name="socio" required>
                                <option value="">Scegli...</option>
                                <option value="Portafoglio Condiviso">💰 Cassa Comune</option>
                                <option value="Ciano">🎮 Ciano</option>
                                <option value="Alex">🔥 Alex</option>
                                <option value="King">👑 King</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>📝 Cosa hai comprato:</label>
                            <input type="text" name="descrizione" placeholder="Es: Booster Darkness Ablaze" required>
                        </div>
                        
                        <div class="two-column">
                            <div class="form-group">
                                <label>📦 Quantità:</label>
                                <input type="number" name="quantita" min="1" value="1" required onchange="calculateUnitPrice()">
                            </div>
                            <div class="form-group">
                                <label>💶 Prezzo TOTALE €:</label>
                                <input type="number" name="prezzo_totale" step="0.01" placeholder="0.00" required onchange="calculateUnitPrice()">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>🏪 Dove:</label>
                            <input type="text" name="dove" placeholder="eBay, Amazon, Negozio..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>🏷️ Tipo:</label>
                            <select name="categoria" required>
                                <option value="">Seleziona...</option>
                                <option value="Da Vendere">💰 Da Vendere</option>
                                <option value="Uso Interno">🔧 Uso Interno</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>📅 Data:</label>
                            <input type="date" name="data" required>
                        </div>
                        
                        <div id="pricePreview" class="calc-preview" style="display: none;">
                            <strong>💡 Calcolo:</strong><br>
                            <span id="priceCalc"></span>
                        </div>
                        
                        <button type="submit" class="btn">💾 Salva Spesa</button>
                    </form>
                </div>
            </div>
            
            <!-- 2. INVENTARIO -->
            <div id="inventory" class="form-section">
                <div class="section">
                    <h2>📦 Inventario</h2>
                    
                    <div class="inventory-tabs">
                        <div class="inventory-tab active" onclick="showInventoryTab('vendere')">💰 Da Vendere</div>
                        <div class="inventory-tab" onclick="showInventoryTab('interno')">🔧 Uso Interno</div>
                    </div>
                    
                    <div id="inventario-vendere" class="inventory-content active">
                        <div class="loading" id="inventoryLoading">⏳ Caricamento...</div>
                        <div id="inventoryVendereContent"></div>
                    </div>
                    
                    <div id="inventario-interno" class="inventory-content">
                        <div id="inventoryInternoContent"></div>
                    </div>
                    
                    <button class="btn" onclick="loadInventory()">🔄 Aggiorna</button>
                </div>
            </div>
            
            <!-- 3. VENDITE -->
            <div id="sales" class="form-section">
                <div class="section">
                    <h2>📈 Registra Vendita</h2>
                    
                    <div class="info-box">
                        <div class="info-title">💰 Profitti:</div>
                        <p>Il ricavato va in <strong>Cassa Comune</strong> e viene diviso per 3!</p>
                    </div>
                    
                    <form id="salesForm">
                        <div class="form-group">
                            <label>🎴 Cosa vendi:</label>
                            <select name="item_id" id="salesItemSelect" required onchange="updateSaleInfo()">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        
                        <div id="itemInfo" class="quantity-info" style="display: none;">
                            <span id="itemDetails"></span>
                        </div>
                        
                        <div class="two-column">
                            <div class="form-group">
                                <label>📦 Quantità:</label>
                                <input type="number" name="quantita_vendita" min="1" required onchange="calculateSaleProfit()">
                            </div>
                            <div class="form-group">
                                <label>💶 Prezzo TOTALE €:</label>
                                <input type="number" name="prezzo_totale_vendita" step="0.01" required onchange="calculateSaleProfit()">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>👤 Venduto a:</label>
                            <input type="text" name="venduto_a" placeholder="Cliente, eBay, Vinted..." required>
                        </div>
                        
                        <div class="form-group">
                            <label>📅 Data vendita:</label>
                            <input type="date" name="data_vendita" required>
                        </div>
                        
                        <div id="salePreview" class="calc-preview" style="display: none;">
                            <strong>💡 Profitto:</strong><br>
                            <span id="saleCalc"></span>
                        </div>
                        
                        <button type="submit" class="btn">💰 Registra Vendita</button>
                    </form>
                </div>
            </div>
            
            <!-- 4. REPORT -->
            <div id="reports" class="form-section">
                <div class="section">
                    <h2>📊 Report Vendite</h2>
                    
                    <div class="loading" id="reportsLoading">⏳ Caricamento...</div>
                    <div id="reportsContent"></div>
                    
                    <button class="btn" onclick="loadSalesReport()">🔄 Aggiorna</button>
                </div>
            </div>
            
            <!-- 5. CASSA -->
            <div id="cash" class="form-section">
                <div class="section">
                    <h2>🏦 Cassa Comune</h2>
                    <div class="loading" id="cashLoading">⏳ Caricamento...</div>
                    <div id="cashContent"></div>
                    
                    <div class="section" style="margin-top: 20px;">
                        <h3 style="color: #FFD700; margin-bottom: 15px; text-align: center;">💰 Aggiungi Denaro</h3>
                        <form id="addCashForm">
                            <div class="form-group">
                                <label>👤 Chi versa:</label>
                                <select name="socio" required>
                                    <option value="">Scegli...</option>
                                    <option value="Ciano">🎮 Ciano</option>
                                    <option value="Alex">🔥 Alex</option>
                                    <option value="King">👑 King</option>
                                    <option value="Tutti">👥 Tutti (diviso per 3)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>💶 Importo €:</label>
                                <input type="number" name="importo" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>📝 Motivo:</label>
                                <input type="text" name="motivo" placeholder="Versamento iniziale..." required>
                            </div>
                            <button type="submit" class="btn">💰 Aggiungi</button>
                        </form>
                    </div>
                    
                    <div id="profitDistribution"></div>
                    
                    <button class="btn" onclick="loadCashStatus()">🔄 Aggiorna Cassa</button>
                </div>
            </div>
            
            <!-- 6. BILANCIO -->
            <div id="balance" class="form-section">
                <div class="section">
                    <h2>⚖️ Bilancio Personale</h2>
                    
                    <div class="info-box">
                        <div class="info-title">🤔 Come funziona:</div>
                        <p><strong>Quota Teorica:</strong> Quanto dovrebbe aver speso ognuno se diviso equamente<br>
                        <strong>Nota:</strong> Spese da "Cassa Comune" NON influenzano questo bilancio</p>
                    </div>
                    
                    <div class="loading" id="balanceLoading">⏳ Caricamento...</div>
                    <div id="balanceContent"></div>
                    
                    <button class="btn" onclick="loadPersonalBalance()">🔄 Aggiorna</button>
                </div>
            </div>
            
            <!-- MESSAGGI -->
            <div id="message"></div>
        </div>
        
        <!-- FLOATING ACTION BUTTON -->
        <div class="floating-add" onclick="showTab('expenses')" title="Aggiungi Spesa Veloce">
            +
        </div>
    </div>

    <script>
        // 🚀 CONFIGURAZIONE API
const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzfEuEHWVffEsOn1W1ZqTZHw7J0H_YacXLGVe-JzVemunw33hom8LBpk0dxvT4yVVhq1Q/exec';

// STORAGE LOCALE + API
let localData = {
    expenses: [],
    sales: [],
    inventory: []
};

// FUNZIONE PER CHIAMATE API - VERSIONE IBRIDA
async function apiCall(action, data = {}) {
    try {
        const params = new URLSearchParams({
            action: action,
            ...data
        });
        
        // Invia al server (senza leggere risposta)
        fetch(`${API_BASE_URL}?${params}`, {
            method: 'GET',
            mode: 'no-cors'
        }).catch(() => {}); // Ignora errori
        
        // Simula il salvataggio anche localmente per l'interfaccia
        if (action === 'addExpense') {
            return handleLocalExpense(data);
        } else if (action === 'addSale') {
            return handleLocalSale(data);
        } else if (action === 'addCash') {
            return handleLocalCash(data);
        }
        
        return { success: true, message: 'Operazione inviata al server' };
        
    } catch (error) {
        console.error('API Error:', error);
        return { success: false, message: 'Errore di connessione' };
    }
}

// GESTIONE LOCALE SPESE
function handleLocalExpense(data) {
    const quantita = parseInt(data.quantita);
    const prezzoTotale = parseFloat(data.prezzo_totale);
    const prezzoUnitario = (prezzoTotale / quantita).toFixed(2);
    
    const expense = {
        ...data,
        prezzo_unitario: prezzoUnitario,
        id: 'EXP' + Date.now()
    };
    
    localData.expenses.push(expense);
    
    // Se è "Da Vendere" o "Uso Interno", aggiungi all'inventario
    if (data.categoria === 'Da Vendere' || data.categoria === 'Uso Interno') {
        const inventoryItem = {
            id: 'INV' + Date.now(),
            descrizione: data.descrizione,
            acquistato_da: data.socio,
            quantita_totale: quantita,
            quantita_disponibile: quantita,
            prezzo_unitario: parseFloat(prezzoUnitario),
            destinazione: data.categoria,
            data: data.data,
            stato: 'Disponibile'
        };
        localData.inventory.push(inventoryItem);
    }
    
    saveLocalData();
    return { 
        success: true, 
        message: `✅ Spesa salvata! ${quantita}x ${data.descrizione} a €${prezzoUnitario} cad.` 
    };
}

// GESTIONE LOCALE VENDITE
function handleLocalSale(data) {
    const quantita = parseInt(data.quantita_vendita);
    const prezzoTotaleVendita = parseFloat(data.prezzo_totale_vendita);
    const costoTotale = parseFloat(data.costo_totale || 0);
    const profittoTotale = prezzoTotaleVendita - costoTotale;
    
    const sale = {
        ...data,
        profitto_totale: profittoTotale.toFixed(2),
        profitto_per_socio: (profittoTotale / 3).toFixed(2),
        percentuale: costoTotale > 0 ? ((profittoTotale / costoTotale) * 100).toFixed(1) : 0,
        id: 'SALE' + Date.now()
    };
    
    localData.sales.push(sale);
    saveLocalData();
    
    return { 
        success: true, 
        message: `✅ Vendita registrata! Profitto: €${profittoTotale.toFixed(2)}` 
    };
}

// GESTIONE LOCALE CASSA
function handleLocalCash(data) {
    const importo = parseFloat(data.importo);
    return { 
        success: true, 
        message: `✅ €${importo.toFixed(2)} aggiunti alla cassa comune!` 
    };
}

// Carica/Salva dati locali
function loadLocalData() {
    const stored = localStorage.getItem('3legendary_mobile_data');
    if (stored) {
        localData = JSON.parse(stored);
    }
}

function saveLocalData() {
    localStorage.setItem('3legendary_mobile_data', JSON.stringify(localData));
}

// FUNZIONI BASE
let currentInventory = {};

document.addEventListener('DOMContentLoaded', function() {
    loadLocalData();
    
    const today = new Date().toISOString().split('T')[0];
    document.querySelectorAll('input[type="date"]').forEach(input => {
        if (!input.value) input.value = today;
    });
    
    // Carica dati iniziali
    loadInventory();
});

function showTab(tabName) {
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    
    // Carica dati quando necessario
    if (tabName === 'inventory') loadInventory();
    if (tabName === 'reports') loadSalesReport();
    if (tabName === 'cash') loadCashStatus();
    if (tabName === 'balance') loadPersonalBalance();
}

function showInventoryTab(type) {
    document.querySelectorAll('.inventory-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.inventory-content').forEach(content => {
        content.classList.remove('active');
    });
    
    event.target.classList.add('active');
    document.getElementById('inventario-' + type).classList.add('active');
}

function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => {
        messageDiv.innerHTML = '';
    }, 5000);
}

// CALCOLI AUTOMATICI
function calculateUnitPrice() {
    const quantita = parseInt(document.querySelector('input[name="quantita"]').value) || 0;
    const prezzoTotale = parseFloat(document.querySelector('input[name="prezzo_totale"]').value) || 0;
    
    if (quantita > 0 && prezzoTotale > 0) {
        const prezzoUnitario = prezzoTotale / quantita;
        document.getElementById('pricePreview').style.display = 'block';
        document.getElementById('priceCalc').innerHTML = `
            <strong>${quantita}x</strong> a <strong>€${prezzoUnitario.toFixed(2)}</strong> per pezzo
        `;
    } else {
        document.getElementById('pricePreview').style.display = 'none';
    }
}

function updateSaleInfo() {
    const select = document.getElementById('salesItemSelect');
    const selectedId = select.value;
    
    if (selectedId && currentInventory.daVendere) {
        const item = currentInventory.daVendere.find(i => i.id === selectedId);
        if (item) {
            document.getElementById('itemInfo').style.display = 'block';
            document.getElementById('itemDetails').innerHTML = `
                <strong>${item.descrizione}</strong><br>
                <strong>Disponibili:</strong> ${item.quantita_disponibile} | 
                <strong>Prezzo:</strong> €${item.prezzo_unitario.toFixed(2)} cad.
            `;
            
            const quantityInput = document.querySelector('input[name="quantita_vendita"]');
            quantityInput.max = item.quantita_disponibile;
            quantityInput.value = Math.min(1, item.quantita_disponibile);
            
            calculateSaleProfit();
        }
    } else {
        document.getElementById('itemInfo').style.display = 'none';
        document.getElementById('salePreview').style.display = 'none';
    }
}

function calculateSaleProfit() {
    const select = document.getElementById('salesItemSelect');
    const selectedId = select.value;
    const quantitaVendita = parseInt(document.querySelector('input[name="quantita_vendita"]').value) || 0;
    const prezzoTotaleVendita = parseFloat(document.querySelector('input[name="prezzo_totale_vendita"]').value) || 0;
    
    if (selectedId && currentInventory.daVendere && quantitaVendita > 0 && prezzoTotaleVendita > 0) {
        const item = currentInventory.daVendere.find(i => i.id === selectedId);
        if (item) {
            const costoTotale = item.prezzo_unitario * quantitaVendita;
            const profittoTotale = prezzoTotaleVendita - costoTotale;
            const percentuale = ((profittoTotale / costoTotale) * 100).toFixed(1);
            const profittoPerSocio = profittoTotale / 3;
            
            const profitClass = profittoTotale >= 0 ? 'profit-positive' : 'profit-negative';
            
            document.getElementById('salePreview').style.display = 'block';
            document.getElementById('saleCalc').innerHTML = `
                <strong>Costo:</strong> €${costoTotale.toFixed(2)}<br>
                <strong>Ricavo:</strong> €${prezzoTotaleVendita.toFixed(2)}<br>
                <strong>Profitto:</strong> <span class="${profitClass}">€${profittoTotale.toFixed(2)} (${percentuale}%)</span><br>
                <strong>Per socio:</strong> €${profittoPerSocio.toFixed(2)} ciascuno
            `;
        }
    } else {
        document.getElementById('salePreview').style.display = 'none';
    }
}

// FORM HANDLERS
document.getElementById('expenseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    showMessage('⏳ Salvando...', 'success');
    
    const result = await apiCall('addExpense', data);
    
    if (result.success) {
        showMessage(result.message, 'success');
        this.reset();
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="data"]').value = today;
        document.querySelector('input[name="quantita"]').value = 1;
        document.getElementById('pricePreview').style.display = 'none';
        
        loadInventory();
    } else {
        showMessage('❌ ' + result.message, 'error');
    }
});

document.getElementById('salesForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    showMessage('⏳ Registrando vendita...', 'success');
    
    const result = await apiCall('addSale', data);
    
    if (result.success) {
        showMessage(result.message, 'success');
        this.reset();
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="data_vendita"]').value = today;
        document.getElementById('salePreview').style.display = 'none';
        
        loadInventory();
        loadSalesReport();
    } else {
        showMessage('❌ ' + result.message, 'error');
    }
});

document.getElementById('addCashForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    showMessage('⏳ Aggiungendo alla cassa...', 'success');
    
    const result = await apiCall('addCash', data);
    
    if (result.success) {
        showMessage(result.message, 'success');
        this.reset();
    } else {
        showMessage('❌ ' + result.message, 'error');
    }
});

// CARICAMENTO DATI LOCALI
function loadInventory() {
    document.getElementById('inventoryLoading').style.display = 'block';
    
    setTimeout(() => {
        currentInventory = {
            daVendere: localData.inventory.filter(item => item.destinazione === 'Da Vendere'),
            usoInterno: localData.inventory.filter(item => item.destinazione === 'Uso Interno')
        };
        
        const vendereHtml = currentInventory.daVendere.map(item => `
            <div class="item-card">
                <div class="item-header">
                    <span class="item-name">${item.descrizione}</span>
                    <span class="item-status ${item.quantita_disponibile > 0 ? 'status-disponibile' : 'status-esaurito'}">
                        ${item.quantita_disponibile > 0 ? 'DISPONIBILE' : 'ESAURITO'}
                    </span>
                </div>
                <div class="quantity-info">
                    <strong>Quantità:</strong> ${item.quantita_disponibile} disponibili (${item.quantita_totale} totali)<br>
                    <strong>Prezzo acquisto:</strong> €${item.prezzo_unitario.toFixed(2)} cad.
                </div>
                <div class="item-details">
                    Acquistato da <strong>${item.acquistato_da}</strong> il ${item.data}
                    ${item.quantita_disponibile > 0 ? `<button class="btn btn-small" onclick="preloadSaleForm('${item.id}')">🏷️ Vendi</button>` : ''}
                </div>
            </div>
        `).join('');
        
        const internoHtml = currentInventory.usoInterno.map(item => `
            <div class="item-card">
                <div class="item-header">
                    <span class="item-name">${item.descrizione}</span>
                    <span class="item-status status-uso">USO INTERNO</span>
                </div>
                <div class="quantity-info">
                    <strong>Quantità:</strong> ${item.quantita_totale}<br>
                    <strong>Prezzo acquisto:</strong> €${item.prezzo_unitario.toFixed(2)} cad.
                </div>
                <div class="item-details">
                    Acquistato da <strong>${item.acquistato_da}</strong> il ${item.data}
                </div>
            </div>
        `).join('');
        
        document.getElementById('inventoryVendereContent').innerHTML = vendereHtml || '<p>Nessun oggetto da vendere</p>';
        document.getElementById('inventoryInternoContent').innerHTML = internoHtml || '<p>Nessun oggetto uso interno</p>';
        
        loadSalesItems();
        document.getElementById('inventoryLoading').style.display = 'none';
    }, 500);
}

function loadSalesItems() {
    const select = document.getElementById('salesItemSelect');
    let options = '<option value="">Seleziona oggetto...</option>';
    
    if (currentInventory.daVendere) {
        currentInventory.daVendere.forEach(item => {
            if (item.quantita_disponibile > 0) {
                options += `<option value="${item.id}">${item.descrizione} (${item.quantita_disponibile} disp. - €${item.prezzo_unitario.toFixed(2)} cad.)</option>`;
            }
        });
    }
    
    select.innerHTML = options;
}

function loadSalesReport() {
    document.getElementById('reportsLoading').style.display = 'block';
    
    setTimeout(() => {
        const totalExpenses = localData.expenses.length;
        const totalSales = localData.sales.length;
        
        const totalInvested = localData.expenses.reduce((sum, exp) => 
            sum + parseFloat(exp.prezzo_totale || 0), 0);
            
        const totalRevenue = localData.sales.reduce((sum, sale) => 
            sum + parseFloat(sale.prezzo_totale_vendita || 0), 0);
            
        const totalProfit = localData.sales.reduce((sum, sale) => 
            sum + parseFloat(sale.profitto_totale || 0), 0);
        
        const avgROI = totalInvested > 0 ? (totalProfit / totalInvested * 100).toFixed(1) : 0;
        const itemsSold = localData.sales.reduce((sum, sale) => 
            sum + parseInt(sale.quantita_vendita || 0), 0);
        
        const statsHtml = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">€${totalRevenue.toFixed(2)}</div>
                    <div class="stat-label">Ricavo Totale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">€${totalProfit.toFixed(2)}</div>
                    <div class="stat-label">Profitto Totale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgROI}%</div>
                    <div class="stat-label">ROI Medio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${itemsSold}</div>
                    <div class="stat-label">Oggetti Venduti</div>
                </div>
            </div>
        `;
        
        const salesHtml = localData.sales.slice(-5).reverse().map(sale => `
            <div class="item-card">
                <div class="item-header">
                    <span class="item-name">${sale.quantita_vendita}x ${sale.oggetto || 'Oggetto'}</span>
                    <span class="profit-positive">+€${parseFloat(sale.profitto_totale).toFixed(2)}</span>
                </div>
                <div class="item-details">
                    <strong>Vendita:</strong> €${parseFloat(sale.prezzo_totale_vendita).toFixed(2)} totale<br>
                    <strong>Profitto per socio:</strong> €${sale.profitto_per_socio} ciascuno<br>
                    <strong>Venduto a:</strong> ${sale.venduto_a}
                </div>
            </div>
        `).join('');
        
        document.getElementById('reportsContent').innerHTML = statsHtml + 
            '<h3 style="color: #FFD700; margin: 20px 0; text-align: center;">📈 Vendite Recenti</h3>' + 
            (salesHtml || '<p>Nessuna vendita registrata</p>');
        
        document.getElementById('reportsLoading').style.display = 'none';
    }, 500);
}

function loadCashStatus() {
    document.getElementById('cashLoading').style.display = 'block';
    
    setTimeout(() => {
        const totalInvested = localData.expenses.reduce((sum, exp) => 
            sum + parseFloat(exp.prezzo_totale || 0), 0);
        const totalRevenue = localData.sales.reduce((sum, sale) => 
            sum + parseFloat(sale.prezzo_totale_vendita || 0), 0);
        const saldoCassa = totalRevenue - totalInvested;
        
        const statsHtml = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">€${saldoCassa.toFixed(2)}</div>
                    <div class="stat-label">Saldo Stimato</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">€${totalRevenue.toFixed(2)}</div>
                    <div class="stat-label">Da Vendite</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">€0.00</div>
                    <div class="stat-label">Versamenti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">€${totalInvested.toFixed(2)}</div>
                    <div class="stat-label">Spese</div>
                </div>
            </div>
            <div class="info-box">
                <div class="info-title">📱 Nota Mobile:</div>
                <p>Questi sono dati <strong>locali</strong> del dispositivo. Per i dati completi e reali, controlla il sistema PC.</p>
            </div>
        `;
        
        document.getElementById('cashContent').innerHTML = statsHtml;
        document.getElementById('cashLoading').style.display = 'none';
    }, 500);
}

function loadPersonalBalance() {
    document.getElementById('balanceLoading').style.display = 'block';
    
    setTimeout(() => {
        const totali = { Ciano: 0, Alex: 0, King: 0 };
        
        localData.expenses.forEach(exp => {
            const socio = exp.socio;
            const importo = parseFloat(exp.prezzo_totale) || 0;
            if (totali.hasOwnProperty(socio)) {
                totali[socio] += importo;
            }
        });
        
        const totaleGenerale = totali.Ciano + totali.Alex + totali.King;
        const quotaTeorica = totaleGenerale / 3;
        
        const balanceHtml = `
            <div class="balance-item">
                <span class="balance-name">🎮 Ciano</span>
                <span class="balance-amount ${totali.Ciano >= quotaTeorica ? 'positive' : 'negative'}">
                    ${totali.Ciano >= quotaTeorica ? `Riceve €${(totali.Ciano - quotaTeorica).toFixed(2)}` : `Versa €${(quotaTeorica - totali.Ciano).toFixed(2)}`}
                </span>
            </div>
            <div class="balance-item">
                <span class="balance-name">🔥 Alex</span>
                <span class="balance-amount ${totali.Alex >= quotaTeorica ? 'positive' : 'negative'}">
                    ${totali.Alex >= quotaTeorica ? `Riceve €${(totali.Alex - quotaTeorica).toFixed(2)}` : `Versa €${(quotaTeorica - totali.Alex).toFixed(2)}`}
                </span>
            </div>
            <div class="balance-item">
                <span class="balance-name">👑 King</span>
                <span class="balance-amount ${totali.King >= quotaTeorica ? 'positive' : 'negative'}">
                    ${totali.King >= quotaTeorica ? `Riceve €${(totali.King - quotaTeorica).toFixed(2)}` : `Versa €${(quotaTeorica - totali.King).toFixed(2)}`}
                </span>
            </div>
            <div class="balance-item" style="border-top: 2px solid #FFD700; margin-top: 15px; padding-top: 15px;">
                <span class="balance-name">💰 Totale Investito</span>
                <span class="balance-amount" style="background: #FFD700; color: #000;">€${totaleGenerale.toFixed(2)}</span>
            </div>
            <div class="info-box">
                <div class="info-title">📱 Dati Locali:</div>
                <p>Basato sui dati inseriti da questo dispositivo mobile.</p>
            </div>
        `;
        
        document.getElementById('balanceContent').innerHTML = balanceHtml;
        document.getElementById('balanceLoading').style.display = 'none';
    }, 500);
}

function preloadSaleForm(itemId) {
    showTab('sales');
    document.getElementById('salesItemSelect').value = itemId;
    updateSaleInfo();
    window.scrollTo(0, 0);
    showMessage('💡 Oggetto preselezionato!', 'success');
}

// UTILITY FUNCTIONS
function exportData() {
    const dataStr = JSON.stringify(localData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = '3legendary_mobile_data.json';
    link.click();
    
    showMessage('📁 Dati esportati!', 'success');
}

function clearAllData() {
    if (confirm('⚠️ Vuoi cancellare TUTTI i dati locali?')) {
        localData = { expenses: [], sales: [], inventory: [] };
        saveLocalData();
        loadInventory();
        loadSalesReport();
        loadCashStatus();
        loadPersonalBalance();
        showMessage('🗑️ Tutti i dati locali cancellati!', 'error');
    }
}
    </script>
</body>
</html>
